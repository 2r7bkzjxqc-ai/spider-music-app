<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spider Music</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%23ff1744;stop-opacity:1' /><stop offset='100%' style='stop-color:%23f50057;stop-opacity:1' /></linearGradient></defs><rect fill='%23000' width='100' height='100'/><circle cx='50' cy='35' r='10' fill='url(%23grad)'/><circle cx='35' cy='55' r='8' fill='url(%23grad)'/><circle cx='65' cy='55' r='8' fill='url(%23grad)'/><path d='M 50 45 L 35 63 M 50 45 L 65 63' stroke='url(%23grad)' stroke-width='2' stroke-linecap='round'/><path d='M 30 45 L 25 40 M 25 40 Q 20 35 22 28' stroke='url(%23grad)' stroke-width='2' stroke-linecap='round' fill='none'/><path d='M 70 45 L 75 40 M 75 40 Q 80 35 78 28' stroke='url(%23grad)' stroke-width='2' stroke-linecap='round' fill='none'/><path d='M 35 65 L 30 75 M 65 65 L 70 75' stroke='url(%23grad)' stroke-width='2' stroke-linecap='round'/><text x='50' y='92' font-family='Arial, sans-serif' font-size='10' font-weight='bold' fill='%23ff1744' text-anchor='middle'>SPIDER</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://w.soundcloud.com/player/api.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: white; overflow: hidden; user-select: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Hide number input spinner (up/down arrows) */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* 7. Scrollbar Styling (Low Priority Fix) */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
        
        .glass-panel { background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-header { background: rgba(18, 18, 18, 0.90); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.08); height: 112px; } 
        .glass-player { background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(30px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-modal { background: #1c1c1e; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 40px 80px rgba(0, 0, 0, 0.8); }
        
        .z-player-footer { z-index: 50; } .z-sidebar { z-index: 40; } .z-header { z-index: 30; } 
        .z-modal { z-index: 9999; } .z-overlay { z-index: 9998; } .z-fullscreen { z-index: 10000; } 
        .z-toast { z-index: 10001; } .z-notification { z-index: 60; }
        
        /* Notification Panel Theme Adaptation */
        #notificationPanel { position: absolute; right: 0; top: 100%; width: 350px; max-height: 400px; overflow-y: auto; border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .dark #notificationPanel { background: rgba(28, 28, 30, 0.95); }
        .light #notificationPanel { background: rgba(255, 255, 255, 0.95); }
        .pink #notificationPanel { background: rgba(244, 114, 182, 0.15); }
        .lightpink #notificationPanel { background: rgba(254, 219, 242, 0.95); }
        
        .dark .notif-header { background: rgba(28, 28, 30, 0.95); }
        .light .notif-header { background: rgba(240, 240, 240, 0.95); }
        .pink .notif-header { background: rgba(236, 72, 153, 0.15); }
        .lightpink .notif-header { background: rgba(244, 114, 182, 0.2); }
        
        .dark .notif-list { background: rgba(28, 28, 30, 0.95); }
        .light .notif-list { background: rgba(255, 255, 255, 0.95); }
        .pink .notif-list { background: rgba(244, 114, 182, 0.15); }
        .lightpink .notif-list { background: rgba(254, 219, 242, 0.95); }
        
        
        .full-screen-player { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #0a0a0a 100%);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease; 
            transform: translateY(100%); 
            opacity: 0;
            z-index: 10000; 
            overflow: hidden;
        }
        .full-screen-player.active { transform: translateY(0); opacity: 1; }
        
        .fullscreen-bg-blur {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-size: cover;
            background-position: center;
            filter: blur(80px) brightness(0.4);
            opacity: 0.6;
            z-index: 0;
            animation: slowRotate 30s linear infinite;
        }
        
        @keyframes slowRotate {
            from { transform: rotate(0deg) scale(1.1); }
            to { transform: rotate(360deg) scale(1.1); }
        }
        
        .fullscreen-content {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding: 2rem;
        }
        
        .fullscreen-cover-container {
            margin-bottom: 3rem;
        }
        
        .fullscreen-cover {
            width: 320px;
            height: 320px;
            border-radius: 24px;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.8),
                0 0 100px rgba(250, 45, 72, 0.3),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            object-fit: cover;
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        }
        
        @media (min-width: 768px) {
            .fullscreen-cover {
                width: 420px;
                height: 420px;
            }
        }
        
        .fullscreen-cover:hover {
            transform: scale(1.02);
            box-shadow: 
                0 40px 80px rgba(0, 0, 0, 0.9),
                0 0 120px rgba(250, 45, 72, 0.4),
                inset 0 0 0 1px rgba(255, 255, 255, 0.15);
        }
        
        .fullscreen-info {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInUp 0.6s ease 0.2s both;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fullscreen-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            line-height: 1.2;
        }
        
        .fullscreen-artist {
            font-size: 1.25rem;
            color: #fa2d48;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .fullscreen-album {
            font-size: 0.95rem;
            color: #888;
            margin-top: 0.5rem;
        }
        
        .fullscreen-progress {
            width: 100%;
            margin-bottom: 2rem;
            animation: fadeInUp 0.6s ease 0.3s both;
        }
        
        .fullscreen-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: height 0.2s ease;
        }
        
        .fullscreen-progress-bar:hover {
            height: 8px;
        }
        
        .fullscreen-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fa2d48, #ff6b7a);
            border-radius: 3px;
            position: relative;
            transition: width 0.1s linear;
        }
        
        .fullscreen-progress-fill::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .fullscreen-progress-bar:hover .fullscreen-progress-fill::after {
            opacity: 1;
        }
        
        .fullscreen-time {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: #888;
            font-family: 'Courier New', monospace;
        }
        
        .fullscreen-controls {
            display: flex;
            align-items: center;
            gap: 2rem;
            animation: fadeInUp 0.6s ease 0.4s both;
        }
        
        .fullscreen-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fullscreen-btn:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }
        
        .fullscreen-btn:active {
            transform: scale(0.95);
        }
        
        .fullscreen-btn-play {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #fa2d48, #ff4d5f);
            border-radius: 50%;
            box-shadow: 
                0 10px 30px rgba(250, 45, 72, 0.4),
                inset 0 -2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .fullscreen-btn-play:hover {
            transform: scale(1.05);
            box-shadow: 
                0 15px 40px rgba(250, 45, 72, 0.6),
                inset 0 -2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .fullscreen-btn-play:active {
            transform: scale(0.98);
        }
        
        .fullscreen-extras {
            display: flex;
            gap: 1.5rem;
            margin-top: 2rem;
            animation: fadeInUp 0.6s ease 0.5s both;
        }
        
        .fullscreen-btn-extra {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .fullscreen-btn-extra:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .fullscreen-btn-extra.active {
            background: rgba(250, 45, 72, 0.2);
            border-color: #fa2d48;
            color: #fa2d48;
        }
        
        .fullscreen-close {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 20;
        }
        
        .fullscreen-close:hover {
            background: rgba(0, 0, 0, 0.6);
            transform: scale(1.05);
        }
        
        .album-hover:hover { transform: scale(1.02); background-color: rgba(255,255,255,0.08); transition: transform 0.2s; }
        .nav-active { background: rgba(255,255,255,0.1); color: white !important; }
        
        .input-dark { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: 0.2s; }
        .input-dark:focus { border-color: #fa2d48; outline: none; background: rgba(255, 255, 255, 0.15); }
        select.input-dark option { background-color: #1c1c1e; color: white; }
        
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-online { background-color: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .status-offline { background-color: #ef4444; }
        
        .drop-zone { border: 2px dashed rgba(255,255,255,0.2); transition: all 0.3s; position: relative; overflow: hidden; }
        .drop-zone.dragover { border-color: #fa2d48; background: rgba(250, 45, 72, 0.1); }
        .drop-zone img { object-fit: cover; }
        
        #searchResults { position: absolute; top: 100%; left: 0; right: 0; margin-top: 8px; background: #1c1c1e; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; max-height: 60vh; overflow-y: auto; z-index: 100; box-shadow: 0 50px 100px rgba(0,0,0,0.9); display: none; }
        #searchResults.active { display: block !important; }

        #notificationPanel { position: absolute; top: 80px; right: 20px; width: 320px; background: #1c1c1e; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; max-height: 350px; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.6); display: none; }
        #notificationPanel.active { display: block !important; }
        .notif-dot { position: absolute; top: 0; right: 0; width: 9px; height: 9px; background-color: #fa2d48; border-radius: 50%; border: 2px solid #121212; display: none; }
        .notif-dot.active { display: block; }

        #toastContainer { position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); z-index: 10001; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #222; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px 24px; border-radius: 9999px; font-medium text-sm opacity-0 transition: all 0.3s; transform: translateY(20px); display: flex; align-items: center; gap: 10px; pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        input[type=range] { -webkit-appearance: none; background: transparent; height: 100%; width: 100%; cursor: pointer; z-index: 20; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #fff; margin-top: -4px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.2s, transform 0.2s; }
        .group:hover input[type=range]::-webkit-slider-thumb, .group\/vol:hover input[type=range]::-webkit-slider-thumb { opacity: 1; transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { background: transparent; height: 100%; }
        
        .modal-tab { @apply pb-2 text-gray-400 cursor-pointer border-b-2 border-transparent hover:text-white transition-colors; }
        .modal-tab.active { @apply text-red-500 border-red-500 font-bold; }

        /* Language Button Active State */
        .lang-btn[data-lang].active {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(59, 130, 246, 0.2));
            border-color: rgba(6, 182, 212, 0.5);
        }

        /* Theme Button Active State */
        .theme-btn[data-theme].active {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.4);
        }

        /* Page Titles - Simple Colors Based on Theme */
        .page-title {
            font-weight: 900;
            letter-spacing: -0.02em;
            color: #a855f7;
        }

        body[data-theme="light"] .page-title {
            color: #7c3aed;
        }

        body[data-theme="pink"] .page-title {
            color: #ec4899;
        }

        body[data-theme="lightpink"] .page-title {
            color: #db2777;
        }

        /* Theme Variables */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #121212;
            --bg-tertiary: #181818;
            --text-primary: #ffffff;
            --text-secondary: #a3a3a3;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.05);
        }

        /* Light Theme */
        body[data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(0, 0, 0, 0.03);
        }

        body[data-theme="light"] {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
        }

        body[data-theme="light"] .glass-panel,
        body[data-theme="light"] .glass-modal,
        body[data-theme="light"] .glass-header {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
        }

        body[data-theme="light"] .text-white {
            color: #1a1a1a !important;
        }

        body[data-theme="light"] .text-gray-400,
        body[data-theme="light"] .text-gray-500 {
            color: #666666 !important;
        }

        body[data-theme="light"] .bg-[#181818],
        body[data-theme="light"] .bg-[#282828] {
            background-color: #ffffff !important;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        body[data-theme="light"] .input-dark {
            background: #ffffff;
            border-color: #e5e5e5;
            color: #1a1a1a;
        }

        /* Pink Theme */
        body[data-theme="pink"] {
            background: linear-gradient(135deg, #2d1b2e 0%, #3d2435 50%, #4a2c42 100%);
        }

        body[data-theme="pink"] .glass-panel,
        body[data-theme="pink"] .glass-modal,
        body[data-theme="pink"] .glass-header {
            background: rgba(236, 72, 153, 0.12);
            backdrop-filter: blur(20px);
            border-color: rgba(236, 72, 153, 0.25);
        }

        body[data-theme="pink"] .text-white {
            color: #fce7f3 !important;
        }

        body[data-theme="pink"] .text-gray-400,
        body[data-theme="pink"] .text-gray-500 {
            color: #f9a8d4 !important;
        }

        body[data-theme="pink"] .bg-[#181818],
        body[data-theme="pink"] .bg-[#282828] {
            background: rgba(59, 35, 56, 0.6) !important;
            border: 1px solid rgba(236, 72, 153, 0.2);
        }

        body[data-theme="pink"] .bg-[#181818]:hover,
        body[data-theme="pink"] .bg-[#282828]:hover {
            background: rgba(75, 45, 70, 0.7) !important;
            border-color: rgba(236, 72, 153, 0.4);
        }

        body[data-theme="pink"] .input-dark {
            background: rgba(59, 35, 56, 0.5);
            border-color: rgba(236, 72, 153, 0.3);
            color: #fce7f3;
        }

        body[data-theme="pink"] .input-dark::placeholder {
            color: #f9a8d4;
        }

        body[data-theme="pink"] .nav-item.nav-active {
            background: linear-gradient(to right, rgba(236, 72, 153, 0.3), transparent);
            color: #fce7f3 !important;
        }

        body[data-theme="pink"] .nav-item:hover {
            background: linear-gradient(to right, rgba(236, 72, 153, 0.2), transparent);
        }

        body[data-theme="pink"] .bg-red-500,
        body[data-theme="pink"] .bg-gradient-to-r.from-red-500 {
            background: linear-gradient(to right, #ec4899, #f472b6) !important;
        }

        body[data-theme="pink"] .text-red-500 {
            color: #f472b6 !important;
        }

        body[data-theme="pink"] .border-white\/10,
        body[data-theme="pink"] .border-white\/5 {
            border-color: rgba(236, 72, 153, 0.2) !important;
        }

        body[data-theme="pink"] .bg-white\/5,
        body[data-theme="pink"] .bg-white\/10 {
            background: rgba(236, 72, 153, 0.1) !important;
        }

        body[data-theme="pink"] .bg-gradient-to-br {
            background: linear-gradient(to bottom right, rgba(236, 72, 153, 0.15), rgba(157, 23, 77, 0.1)) !important;
        }

        body[data-theme="pink"] .bg-gradient-to-r {
            background: linear-gradient(to right, rgba(236, 72, 153, 0.2), rgba(236, 72, 153, 0.05)) !important;
        }

        body[data-theme="pink"] .rounded-xl,
        body[data-theme="pink"] .rounded-2xl,
        body[data-theme="pink"] .rounded-3xl {
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.1);
        }

        body[data-theme="pink"] img {
            border-color: rgba(236, 72, 153, 0.2);
        }

        body[data-theme="pink"] .genre-card,
        body[data-theme="pink"] .bg-black,
        body[data-theme="pink"] .bg-black\/20,
        body[data-theme="pink"] .bg-black\/40 {
            background: rgba(45, 27, 46, 0.8) !important;
            border: 1px solid rgba(236, 72, 153, 0.15);
        }

        body[data-theme="pink"] .admin-tab.active {
            background: linear-gradient(to right, rgba(236, 72, 153, 0.2), transparent) !important;
            color: #f472b6 !important;
            border-bottom-color: #f472b6 !important;
        }

        body[data-theme="pink"] button:hover,
        body[data-theme="pink"] .cursor-pointer:hover {
            background: rgba(236, 72, 153, 0.15) !important;
        }

        /* Light Theme */
        body[data-theme="light"] {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 50%, #fce7f3 100%);
        }

        body[data-theme="light"] .glass-panel,
        body[data-theme="light"] .glass-modal,
        body[data-theme="light"] .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border-color: rgba(100, 116, 139, 0.15);
        }

        body[data-theme="light"] .text-white {
            color: #1e293b !important;
        }

        body[data-theme="light"] .text-gray-400,
        body[data-theme="light"] .text-gray-500 {
            color: #64748b !important;
        }

        body[data-theme="light"] .bg-[#181818],
        body[data-theme="light"] .bg-[#282828] {
            background: rgba(248, 250, 252, 0.9) !important;
            border: 1px solid rgba(100, 116, 139, 0.15);
        }

        body[data-theme="light"] .bg-[#181818]:hover,
        body[data-theme="light"] .bg-[#282828]:hover {
            background: rgba(241, 245, 249, 1) !important;
            border-color: rgba(100, 116, 139, 0.25);
        }

        body[data-theme="light"] .input-dark {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(100, 116, 139, 0.2);
            color: #1e293b;
        }

        body[data-theme="light"] .input-dark::placeholder {
            color: #94a3b8;
        }

        body[data-theme="light"] .nav-item.nav-active {
            background: linear-gradient(to right, rgba(239, 68, 68, 0.15), transparent);
            color: #1e293b !important;
        }

        body[data-theme="light"] .nav-item:hover {
            background: linear-gradient(to right, rgba(239, 68, 68, 0.08), transparent);
        }

        body[data-theme="light"] .bg-white\/5,
        body[data-theme="light"] .bg-white\/10 {
            background: rgba(100, 116, 139, 0.08) !important;
        }

        body[data-theme="light"] .border-white\/10,
        body[data-theme="light"] .border-white\/5 {
            border-color: rgba(100, 116, 139, 0.15) !important;
        }

        body[data-theme="light"] .bg-black\/60,
        body[data-theme="light"] .bg-black\/40,
        body[data-theme="light"] .bg-black\/80 {
            background: rgba(255, 255, 255, 0.95) !important;
        }

        body[data-theme="light"] .bg-gradient-to-br {
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.95), rgba(241, 245, 249, 0.9)) !important;
        }

        body[data-theme="light"] .bg-gradient-to-r {
            background: linear-gradient(to right, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.02)) !important;
        }

        body[data-theme="light"] .rounded-xl,
        body[data-theme="light"] .rounded-2xl,
        body[data-theme="light"] .rounded-3xl {
            box-shadow: 0 2px 15px rgba(100, 116, 139, 0.1);
        }

        body[data-theme="light"] img {
            border-color: rgba(100, 116, 139, 0.15);
            filter: brightness(0.95) saturate(1.1);
        }

        body[data-theme="light"] .genre-card img,
        body[data-theme="light"] [class*="cover"] img,
        body[data-theme="light"] .w-full.aspect-square {
            filter: brightness(0.92) contrast(1.05) saturate(1.15);
        }

        body[data-theme="light"] .genre-card:hover img,
        body[data-theme="light"] [class*="cover"]:hover img {
            filter: brightness(0.88) contrast(1.08) saturate(1.2);
        }

        body[data-theme="light"] .genre-card,
        body[data-theme="light"] .bg-black,
        body[data-theme="light"] .bg-black\/20,
        body[data-theme="light"] .bg-black\/40 {
            background: rgba(255, 255, 255, 0.95) !important;
        }

        /* ===== LIGHT PINK THEME ===== */
        body[data-theme="lightpink"] {
            background: linear-gradient(135deg, #fff0f7 0%, #ffe4f1 35%, #ffd6ea 70%, #ffc9e3 100%);
        }

        body[data-theme="lightpink"] .glass-panel,
        body[data-theme="lightpink"] .glass-modal,
        body[data-theme="lightpink"] .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border-color: rgba(244, 114, 182, 0.25);
            box-shadow: 0 4px 20px rgba(244, 114, 182, 0.12);
        }

        body[data-theme="lightpink"] .text-white {
            color: #701a3f !important;
        }

        body[data-theme="lightpink"] .text-gray-400 {
            color: #a21650 !important;
        }

        body[data-theme="lightpink"] .text-gray-500 {
            color: #be185d !important;
        }

        body[data-theme="lightpink"] .bg-[#181818] {
            background: linear-gradient(135deg, rgba(255, 237, 246, 0.9), rgba(254, 226, 243, 0.85)) !important;
            border: 1px solid rgba(244, 114, 182, 0.3);
        }

        body[data-theme="lightpink"] .bg-white\/5,
        body[data-theme="lightpink"] .bg-white\/10 {
            background: rgba(255, 230, 245, 0.7) !important;
            border: 1px solid rgba(244, 114, 182, 0.15);
        }

        body[data-theme="lightpink"] .bg-gradient-to-br {
            background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.98), rgba(255, 228, 247, 0.95)) !important;
            border: 1px solid rgba(244, 114, 182, 0.15);
        }

        body[data-theme="lightpink"] .input-dark {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(244, 114, 182, 0.35);
            color: #701a3f;
            box-shadow: 0 2px 10px rgba(244, 114, 182, 0.08);
        }

        body[data-theme="lightpink"] .input-dark::placeholder {
            color: rgba(162, 22, 80, 0.5);
        }

        body[data-theme="lightpink"] .input-dark:focus {
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 0 3px rgba(244, 114, 182, 0.15);
        }

        body[data-theme="lightpink"] .nav-item {
            color: #a21650;
        }

        body[data-theme="lightpink"] .nav-item.active {
            background: linear-gradient(135deg, rgba(244, 114, 182, 0.25), rgba(236, 72, 153, 0.15));
            color: #be185d;
            box-shadow: 0 2px 10px rgba(244, 114, 182, 0.2);
        }

        body[data-theme="lightpink"] .nav-item:hover {
            background: rgba(244, 114, 182, 0.18);
            color: #be185d;
        }

        body[data-theme="lightpink"] .bg-gradient-to-r {
            background: linear-gradient(to right, rgba(244, 114, 182, 0.15), rgba(236, 72, 153, 0.08)) !important;
        }

        body[data-theme="lightpink"] .rounded-xl,
        body[data-theme="lightpink"] .rounded-2xl,
        body[data-theme="lightpink"] .rounded-3xl {
            box-shadow: 0 4px 20px rgba(244, 114, 182, 0.18);
        }

        body[data-theme="lightpink"] img {
            border-color: rgba(244, 114, 182, 0.25);
            filter: brightness(0.96) saturate(1.2) contrast(1.02);
        }

        body[data-theme="lightpink"] .genre-card img,
        body[data-theme="lightpink"] [class*="cover"] img,
        body[data-theme="lightpink"] .w-full.aspect-square {
            filter: brightness(0.94) contrast(1.06) saturate(1.25);
        }

        body[data-theme="lightpink"] .genre-card:hover img,
        body[data-theme="lightpink"] [class*="cover"]:hover img {
            filter: brightness(0.92) contrast(1.1) saturate(1.3);
        }

        body[data-theme="lightpink"] .border-white\/10 {
            border-color: rgba(244, 114, 182, 0.25) !important;
        }

        body[data-theme="lightpink"] .border-white\/20 {
            border-color: rgba(244, 114, 182, 0.35) !important;
        }

        body[data-theme="lightpink"] .from-white\/10 {
            --tw-gradient-from: rgba(255, 255, 255, 0.7);
        }

        body[data-theme="lightpink"] .to-white\/\[0\.02\] {
            --tw-gradient-to: rgba(255, 228, 247, 0.5);
        }

        body[data-theme="lightpink"] .genre-card,
        body[data-theme="lightpink"] .bg-black,
        body[data-theme="lightpink"] .bg-black\/20,
        body[data-theme="lightpink"] .bg-black\/40 {
            background: linear-gradient(135deg, rgba(255, 245, 252, 0.95), rgba(255, 237, 249, 0.9)) !important;
            border: 1px solid rgba(244, 114, 182, 0.2);
        }

        body[data-theme="lightpink"] button:not(.theme-btn):not(.lang-btn):hover {
            background-color: rgba(244, 114, 182, 0.12);
        }

        body[data-theme="lightpink"] .bg-red-500,
        body[data-theme="lightpink"] .text-red-500 {
            color: #ec4899 !important;
        }

        body[data-theme="lightpink"] .hover\:text-red-500:hover {
            color: #db2777 !important;
        }
            border: 1px solid rgba(100, 116, 139, 0.12);
        }

        body[data-theme="light"] .shadow-lg,
        body[data-theme="light"] .shadow-xl {
            box-shadow: 0 10px 25px rgba(100, 116, 139, 0.15) !important;
        }

        body[data-theme="light"] .admin-tab.active {
            background: linear-gradient(to right, rgba(239, 68, 68, 0.12), transparent) !important;
            color: #ef4444 !important;
            border-bottom-color: #ef4444 !important;
        }

        body[data-theme="light"] button:hover,
        body[data-theme="light"] .cursor-pointer:hover {
            background: rgba(239, 68, 68, 0.08) !important;
        }

        body[data-theme="light"] .text-red-500 {
            color: #ef4444 !important;
        }

        body[data-theme="light"] .bg-red-500 {
            background: #ef4444 !important;
        }

        .genre-card { position: relative; aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; cursor: pointer; transition: transform 0.3s ease; }
        .genre-card:hover { transform: scale(1.03); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .genre-image-container { position: absolute; inset: 0; background-color: #1a1a1a; }
        .genre-image-container img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1s ease-in-out; }
        .genre-image-container img.active { opacity: 0.6; }
        .genre-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.2)); display: flex; align-items: end; justify-content: center; padding: 1rem; z-index: 10; }

        .header-player { display: flex; align-items: center; gap: 1.5rem; background: rgba(255,255,255,0.08); padding: 1rem 1.5rem; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); margin: 0 2rem; flex: 1; max-width: 1200px; }
        .player-progress-container { display: flex; align-items: center; gap: 0.75rem; flex: 1; }
        .player-progress-bar { position: relative; flex: 1; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; cursor: pointer; overflow: hidden; transition: height 0.2s ease; }
        .player-progress-bar:hover { height: 8px; }
        .player-progress-fill { position: absolute; height: 100%; background: linear-gradient(90deg, #fa2d48, #ff6b7a); border-radius: 3px; width: 0%; transition: width 0.1s linear; }
        .player-progress-bar:hover .player-progress-fill { background: linear-gradient(90deg, #ff3d5a, #ff7d8a); }
        .player-time { font-family: 'Courier New', monospace; font-size: 0.75rem; color: #a3a3a3; min-width: 2.5rem; text-align: center; }

        /* Admin Tabs Navigation */
        .admin-tab {
            background: transparent;
            color: #9ca3af;
            border: none;
            cursor: pointer;
            position: relative;
        }
        .admin-tab.active {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
        }
        .admin-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.02);
            color: #d1d5db;
        }
        
        /* Admin Tab Content */
        .admin-tab-content {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .admin-section { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; overflow: hidden; }
        .admin-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .admin-body { padding: 1.5rem; }
        .news-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; overflow: hidden; transition: transform 0.2s; }
        .news-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.08); }
        
        #fullScreenPlayer img#fsCover { width: 300px; height: 300px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border-radius: 20px; margin-bottom: 2rem; }
        @media (min-width: 768px) { #fullScreenPlayer img#fsCover { width: 400px; height: 400px; } }

        /* Animation Album Fade - Modified for switching */
        @keyframes fadeAlbumSwitch { 0% { opacity: 0; } 10% { opacity: 1; } 45% { opacity: 1; } 55% { opacity: 0; } 100% { opacity: 0; } }
        .album-fade-img { animation: fadeAlbumSwitch 8s infinite; position: absolute; width: 100%; height: 100%; object-fit: cover; }
        .album-fade-img.no-fade { animation: none !important; opacity: 1 !important; }
        .album-fade-img:nth-child(2) { animation-delay: 4s; }
        
        /* Animation for custom modals */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        
        /* Search Results Dropdown */
        #searchResults {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(20, 20, 20, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        #searchResults.hidden { display: none; }
        #searchResults::-webkit-scrollbar { width: 6px; }
        #searchResults::-webkit-scrollbar-track { background: transparent; }
        #searchResults::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        #searchResults::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row antialiased bg-black text-gray-100">
    <div id="toastContainer"></div>

    <div id="fullScreenPlayer" class="full-screen-player">
        <!-- Background Blur Effect -->
        <div class="fullscreen-bg-blur" id="fsBgBlur"></div>
        
        <!-- Close Button -->
        <button onclick="toggleFullScreen()" class="fullscreen-close">
            <i data-lucide="chevron-down" class="w-6 h-6"></i>
        </button>
        
        <!-- Main Content -->
        <div class="fullscreen-content">
            <!-- Album Cover -->
            <div class="fullscreen-cover-container">
                <img id="fsCover" src="" class="fullscreen-cover">
            </div>
            
            <!-- Song Info -->
            <div class="fullscreen-info">
                <h2 id="fsTitle" class="fullscreen-title">Titre</h2>
                <p id="fsArtist" class="fullscreen-artist" data-i18n-default="common.artist">Artiste</p>
                <p id="fsAlbum" class="fullscreen-album"></p>
                <!-- Like Button -->
                <button id="fsLikeBtn" onclick="toggleLike(currentSongId)" class="mt-4 flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-white/10 to-white/5 hover:from-white/15 hover:to-white/10 rounded-2xl transition-all text-gray-500 hover:text-red-500 mx-auto border border-white/10 hover:border-red-500/50" title="J'aime">
                    <i data-lucide="heart" class="w-5 h-5 fill-current"></i>
                    <span id="fsLikeText">J'aime</span>
                </button>
            </div>
            
            <!-- Progress Bar -->
            <div class="fullscreen-progress">
                <div class="fullscreen-progress-bar" id="fsProgressBar" onclick="seekFullscreen(event)">
                    <div class="fullscreen-progress-fill" id="fsProgressFill"></div>
                </div>
                <div class="fullscreen-time">
                    <span id="fsCurrentTime">0:00</span>
                    <span id="fsDuration">0:00</span>
                </div>
            </div>
            
            <!-- Playback Controls -->
            <div class="fullscreen-controls">
                <button onclick="prevSong()" class="fullscreen-btn">
                    <i data-lucide="skip-back" class="w-10 h-10"></i>
                </button>
                <button onclick="togglePlay()" class="fullscreen-btn fullscreen-btn-play">
                    <span id="fsPlayPauseIcon">
                        <i data-lucide="play" class="w-9 h-9 fill-current"></i>
                    </span>
                </button>
                <button onclick="nextSong()" class="fullscreen-btn">
                    <i data-lucide="skip-forward" class="w-10 h-10"></i>
                </button>
            </div>
            
            <!-- Extra Controls -->
            <div class="fullscreen-extras">
                <button onclick="toggleShuffle()" class="fullscreen-btn-extra" id="fsShuffleBtn">
                    <i data-lucide="shuffle" class="w-4 h-4"></i>
                    <span>Aléatoire</span>
                </button>
                <button onclick="cycleRepeat()" class="fullscreen-btn-extra" id="fsRepeatBtn">
                    <i data-lucide="repeat" class="w-4 h-4"></i>
                    <span id="fsRepeatText">Répéter</span>
                </button>
            </div>
        </div>
    </div>

    <aside class="hidden md:flex flex-col w-72 glass-panel h-full pt-8 px-5 z-sidebar flex-shrink-0 pb-6 border-r border-white/5">
        <!-- Logo Section -->
        <div class="mb-10 px-2 flex items-center gap-4 group relative select-none">
            <div class="relative">
                <div class="absolute inset-0 bg-gradient-to-br from-red-500 to-pink-500 blur-lg opacity-50 group-hover:opacity-75 transition-opacity rounded-full"></div>
                <div class="relative bg-gradient-to-br from-red-500 to-pink-500 p-2 rounded-2xl shadow-xl shadow-red-500/30">
                    <i id="defaultLogo" data-lucide="bug" class="w-7 h-7 text-white"></i>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <span id="siteName" class="text-2xl font-black text-white truncate block tracking-tight">Spider Music</span>
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-semibold">Music Streaming</span>
            </div>
            <button id="btnEditSite" onclick="openSiteConfigModal()" class="hidden p-2 text-gray-500 hover:text-white rounded-xl hover:bg-white/10 transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
        </div>
        
        <!-- Navigation -->
        <nav class="space-y-2 mb-8">
            <a href="#" onclick="switchView('listen', this)" class="nav-item nav-active flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white rounded-2xl transition-all font-semibold group relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-red-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <i data-lucide="play-circle" class="w-5 h-5 relative z-10"></i>
                <span class="relative z-10" data-i18n="nav.listen">Écouter</span>
            </a>
            <a href="#" onclick="switchView('liked', this)" class="nav-item flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white rounded-2xl transition-all font-semibold group relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-pink-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <i data-lucide="heart" class="w-5 h-5 relative z-10"></i>
                <span class="relative z-10" data-i18n="nav.liked">Titres Likés</span>
            </a>
            <a href="#" onclick="switchView('explore', this)" class="nav-item flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white rounded-2xl transition-all font-semibold group relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-purple-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <i data-lucide="layout-grid" class="w-5 h-5 relative z-10"></i>
                <span class="relative z-10" data-i18n="nav.explore">Explorer</span>
            </a>
            <a href="#" onclick="switchView('community', this)" class="nav-item flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white rounded-2xl transition-all font-semibold group relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <i data-lucide="users" class="w-5 h-5 relative z-10"></i>
                <span class="relative z-10" data-i18n="nav.community">Communauté</span>
            </a>
            <a href="#" onclick="switchView('settings', this)" class="nav-item flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white rounded-2xl transition-all font-semibold group relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <i data-lucide="settings" class="w-5 h-5 relative z-10"></i>
                <span class="relative z-10" data-i18n="nav.settings">Paramètres</span>
            </a>
            <a href="#" id="navAdmin" onclick="switchView('users', this)" class="nav-item flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-white rounded-2xl transition-all font-semibold group relative overflow-hidden hidden">
                <div class="absolute inset-0 bg-gradient-to-r from-orange-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <i data-lucide="shield-check" class="w-5 h-5 relative z-10"></i>
                <span class="relative z-10" data-i18n="nav.admin">Gestion</span>
            </a>
        </nav>
        
        <!-- Playlists Section -->
        <div class="flex flex-col flex-1 min-h-0">
            <div class="flex justify-between items-center px-4 mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-1 h-5 bg-gradient-to-b from-red-500 to-pink-500 rounded-full"></div>
                    <h3 class="text-xs font-bold text-white uppercase tracking-wider" data-i18n="common.myPlaylists">Mes Playlists</h3>
                </div>
                <button onclick="openCreatePlaylistModal()" class="p-1.5 text-gray-400 hover:text-white rounded-lg hover:bg-gradient-to-br hover:from-red-500/20 hover:to-pink-500/20 transition-all">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <nav class="space-y-1 overflow-y-auto no-scrollbar flex-1 pr-1" id="playlistSidebar"></nav>
        </div>
        
        <!-- Bottom Section -->
        <div class="mt-auto pt-6 border-t border-white/10 space-y-4">
             <div id="adminPanel" class="hidden">
                 <button onclick="openAddModal()" class="w-full py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white text-sm font-bold rounded-2xl shadow-xl shadow-red-500/30 transition-all flex items-center justify-center gap-2 hover:scale-105">
                    <i data-lucide="plus" class="w-4 h-4"></i> Ajouter du contenu
                </button>
            </div>

            <div id="serverStatus" class="flex items-center gap-2 text-xs text-gray-500 px-3 py-2 cursor-pointer hover:text-white rounded-xl hover:bg-white/5 transition-all" onclick="smartConnect()">
                <div class="status-dot status-offline" id="statusDot"></div>
                <span id="statusText" class="font-medium">Connexion...</span>
            </div>
            
            <div class="bg-gradient-to-br from-white/5 to-white/[0.02] backdrop-blur-xl rounded-2xl border border-white/10 p-3 cursor-pointer hover:border-white/20 transition-all group" onclick="if(currentUser) openUserProfile(safeEncode(currentUser.username))">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <img id="userAvatar" src="" class="w-11 h-11 rounded-full bg-gray-800 object-cover ring-2 ring-white/20 group-hover:ring-red-500/50 transition-all">
                        <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 border-2 border-[#121212] rounded-full"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div id="userInfo" class="text-sm font-bold text-white truncate group-hover:text-red-400 transition-colors">Non connecté</div>
                        <div id="userRole" class="text-[10px] text-gray-500 uppercase tracking-wide">Visiteur</div>
                    </div>
                    <button onclick="event.stopPropagation(); logout()" class="p-2 text-gray-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all rounded-lg hover:bg-red-500/10">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto no-scrollbar relative z-10 bg-black flex flex-col">
        <!-- HEADER PLAYER -->
        <header class="sticky top-0 z-header glass-header px-6 py-3 flex justify-between items-center border-b border-white/5">
            <div class="relative w-80 group flex-shrink-0">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 group-hover:text-red-400 transition-colors"></i>
                <input type="text" id="searchInput" data-i18n-placeholder="common.searchPlaceholder" placeholder="Rechercher des titres, artistes, albums..." onclick="openSearchPage()" readonly class="w-full bg-gradient-to-r from-white/5 to-white/[0.02] text-sm py-3.5 pl-12 pr-4 rounded-2xl focus:outline-none focus:from-white/10 focus:to-white/5 text-white cursor-pointer hover:from-white/10 hover:to-white/5 border border-white/5 hover:border-white/10 transition-all">
            </div>

            <div class="header-player">
                <div class="flex items-center gap-4 flex-shrink-0 cursor-pointer group" onclick="toggleFullScreen()">
                    <div class="relative">
                        <img id="playerArt" src="" class="w-14 h-14 rounded-xl bg-gray-800 object-cover shadow-xl ring-2 ring-white/10 group-hover:ring-red-500/50 transition-all">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent rounded-xl opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <i data-lucide="maximize-2" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                    <div class="flex flex-col w-44">
                        <div class="flex items-center gap-2">
                            <span id="playerTitle" class="text-sm font-bold text-white truncate group-hover:text-red-400 transition-colors">En attente</span>
                            <button id="playerLikeBtn" onclick="event.stopPropagation(); toggleLike(currentSongId)" class="text-gray-500 hover:text-red-500 transition-all" title="J'aime">
                                <i data-lucide="heart" class="w-4 h-4 fill-current"></i>
                            </button>
                        </div>
                        <span id="playerArtist" onclick="event.stopPropagation(); if(this.innerText!=='--') openArtistProfile(safeEncode(this.innerText))" class="text-xs text-gray-400 truncate hover:text-white hover:underline cursor-pointer transition-colors">--</span>
                    </div>
                </div>

                <div class="flex items-center gap-6 flex-shrink-0">
                     <button onclick="prevSong()" class="text-gray-400 hover:text-white transition-all hover:scale-110 p-2 rounded-full hover:bg-white/5"><i data-lucide="skip-back" class="w-6 h-6 fill-current"></i></button>
                     <button onclick="togglePlay()" class="bg-gradient-to-br from-white to-gray-200 text-black rounded-full p-3 hover:scale-110 transition-all shadow-xl shadow-white/20 hover:shadow-white/30"><span id="playPauseIcon"><i data-lucide="play" class="w-5 h-5 fill-current"></i></span></button>
                     <button onclick="nextSong()" class="text-gray-400 hover:text-white transition-all hover:scale-110 p-2 rounded-full hover:bg-white/5"><i data-lucide="skip-forward" class="w-6 h-6 fill-current"></i></button>
                </div>

                <div class="player-progress-container group">
                    <span id="currentTime" class="player-time text-right text-xs font-semibold">0:00</span>
                    <div class="player-progress-bar bg-white/10 rounded-full overflow-hidden">
                        <div id="progressBar" class="player-progress-fill bg-gradient-to-r from-red-500 to-pink-500"></div>
                        <input type="range" id="progressInput" min="0" max="100" value="0" class="absolute w-full h-full opacity-0 cursor-pointer" style="z-index: 10;" oninput="seek(this.value)">
                    </div>
                    <span id="duration" class="player-time text-left text-xs font-semibold">0:00</span>
                </div>

                <div class="flex items-center gap-4 flex-shrink-0">
                    <button onclick="toggleShuffle()" id="btnShuffle" class="text-gray-500 hover:text-white transition-all p-2 rounded-lg hover:bg-white/5"><i data-lucide="shuffle" class="w-4 h-4"></i></button>
                    <button onclick="cycleRepeat()" id="btnRepeat" class="text-gray-500 hover:text-white transition-all p-2 rounded-lg hover:bg-white/5 cursor-pointer select-none" style="pointer-events: auto; user-select: none;"><i data-lucide="repeat" class="w-4 h-4"></i></button>
                    <div class="flex items-center gap-2 group/vol">
                        <i data-lucide="volume-2" class="w-4 h-4 text-gray-400 group-hover/vol:text-white transition-colors"></i>
                        <div class="w-24 h-1.5 bg-white/10 rounded-full relative overflow-hidden transition-all hover:h-2">
                            <div id="volumeBar" class="absolute h-full bg-gradient-to-r from-red-400 to-pink-400 rounded-full w-3/4 transition-all"></div>
                            <input type="range" min="0" max="1" step="0.01" value="0.75" class="absolute w-full h-full opacity-0 cursor-pointer" style="z-index: 10;" oninput="setVolume(this.value)">
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative ml-4 flex-shrink-0">
                <button id="btnNotifs" onclick="toggleNotifications()" class="p-2.5 text-gray-400 hover:text-white relative rounded-xl hover:bg-gradient-to-br hover:from-red-500/10 hover:to-pink-500/10 transition-all border border-transparent hover:border-white/10">
                    <i data-lucide="bell" class="w-5 h-5"></i><div id="notifDot" class="notif-dot"></div>
                </button>
                <div id="notificationPanel" class="z-notification hidden">
                    <div class="px-4 py-3 border-b border-white/10 flex justify-between items-center notif-header sticky top-0 z-10">
                        <h3 class="text-sm font-bold text-white" data-i18n="notifications.title">Notifications</h3><button onclick="clearNotifications()" class="text-xs text-red-400 hover:text-red-300" data-i18n="notifications.clearAll">Effacer tout</button>
                    </div>
                    <div id="notificationList" class="p-0 text-sm notif-list"><p class="text-gray-500 text-center text-xs py-8" data-i18n="notifications.empty">Aucune notification</p></div>
                </div>
            </div>
        </header>

        <div class="p-6 md:p-8 pb-10">
            <!-- VUE ÉCOUTER -->
            <div id="view-listen" class="view-section">
                <div class="mb-10">
                    <h1 class="text-5xl md:text-6xl font-black mb-3 tracking-tight page-title" data-i18n="nav.listen">Écouter</h1>
                    <p class="text-gray-400 text-lg" data-i18n="listen.subtitle">Découvrez toute la musique</p>
                </div>
                <div class="mb-10 relative group cursor-pointer overflow-hidden rounded-2xl h-64 md:h-80 bg-gray-900 shadow-2xl" onclick="playRandom()">
                    <img id="heroImage" src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=1000&q=80" class="w-full h-full object-cover opacity-60 group-hover:opacity-50 group-hover:scale-105 transition-all duration-700">
                    <div class="absolute bottom-0 left-0 p-8 w-full"><h2 class="text-4xl md:text-6xl font-bold mb-4 text-white" data-i18n="listen.hero">Mix Global</h2><button class="bg-white text-black rounded-full px-8 py-3.5 flex items-center gap-2 font-bold hover:scale-105 transition-transform"><i data-lucide="play" class="fill-current w-4 h-4"></i> <span data-i18n="listen.playRandom">Lecture Aléatoire</span></button></div>
                </div>
                <div class="flex justify-between items-end mb-6"><h2 class="text-2xl font-bold text-white"><span data-i18n="listen.songs">Titres</span> <span id="songCount" class="text-sm text-gray-500 font-normal ml-2"></span></h2><button onclick="smartConnect()" class="text-gray-500 hover:text-white p-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button></div>
                <div id="songGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6"><div class="col-span-full text-center py-20 text-gray-600 animate-pulse" data-i18n="common.connecting">Connexion au serveur...</div></div>
            </div>
            
            <!-- VUE TITRES LIKÉS -->
            <div id="view-liked" class="view-section hidden">
                <div class="mb-10">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="p-4 bg-gradient-to-br from-red-500 to-pink-500 rounded-2xl">
                            <i data-lucide="heart" class="w-10 h-10 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-5xl font-bold text-white mb-2" data-i18n="liked.title">Titres Likés</h1>
                            <p class="text-gray-400" data-i18n="liked.subtitle">Vos coups de cœur musicaux</p>
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <div class="flex items-center justify-between">
                        <h2 id="likedSongCount" class="text-sm font-semibold text-gray-400">0 titres</h2>
                    </div>
                </div>
                <div id="likedSongGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6"></div>
            </div>
            
            <!-- VUE EXPLORER (CORRIGÉE) -->
            <div id="view-explore" class="view-section hidden">
                <!-- Header Explorer avec gradient -->
                <div class="mb-10">
                    <h1 class="text-5xl md:text-6xl font-black mb-3 tracking-tight page-title" data-i18n="nav.explore">Explorer</h1>
                    <p class="text-gray-400 text-lg" data-i18n="explore.subtitle">Découvrez des genres, albums et artistes</p>
                </div>

                <!-- Section Genres avec cards modernes -->
                <div class="mb-12">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                            <i data-lucide="disc-3" class="w-8 h-8 text-purple-400"></i>
                            <span data-i18n="explore.genres">Genres Musicaux</span>
                        </h2>
                        <div class="flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-5 h-5 text-purple-400"></i>
                            <span class="text-sm text-gray-400" id="genreCount">0 genres</span>
                        </div>
                    </div>
                    <div id="exploreGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                </div>
                
                <!-- Section Albums avec design premium -->
                <div class="mb-12">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                            <i data-lucide="album" class="w-8 h-8 text-pink-400"></i>
                            <span data-i18n="explore.albums">Tous les Albums</span>
                        </h2>
                        <button onclick="document.getElementById('albumsList').scrollLeft -= 400" class="p-2 bg-white/5 hover:bg-white/10 rounded-xl transition-all border border-white/10 hover:border-white/20">
                            <i data-lucide="chevron-left" class="w-5 h-5 text-gray-400"></i>
                        </button>
                    </div>
                    <div class="relative group">
                        <div id="albumsList" class="flex gap-6 overflow-x-auto no-scrollbar pb-4 snap-x scroll-smooth"></div>
                        <button onclick="document.getElementById('albumsList').scrollLeft += 400" class="absolute right-0 top-1/2 -translate-y-1/2 p-3 bg-gradient-to-r from-pink-500 to-red-500 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-all hover:scale-110">
                            <i data-lucide="chevron-right" class="w-6 h-6 text-white"></i>
                        </button>
                    </div>
                </div>

                <!-- Section Artistes avec grille moderne -->
                <div class="mb-12">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                            <i data-lucide="mic-2" class="w-8 h-8 text-red-400"></i>
                            <span data-i18n="explore.artists">Artistes à Découvrir</span>
                        </h2>
                        <div class="flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5 text-red-400"></i>
                            <span class="text-sm text-gray-400" id="artistCount">0 artistes</span>
                        </div>
                    </div>
                    <div id="exploreProfilesList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6"></div>
                </div>
            </div>
            
            <!-- VUE COMMUNAUTÉ (CORRIGÉE) -->
            <div id="view-community" class="view-section hidden">
                <!-- Header avec titre et stats -->
                <div class="mb-8">
                    <div class="flex items-end justify-between mb-8">
                        <div>
                            <h1 class="text-5xl md:text-6xl font-black mb-3 tracking-tight page-title" data-i18n="nav.community">Communauté</h1>
                            <p class="text-gray-400 text-lg" data-i18n="community.subtitle">Découvrez l'actualité et les membres actifs</p>
                        </div>
                        <div class="hidden md:flex items-center gap-4">
                            <div class="bg-gradient-to-br from-red-500/20 to-red-500/5 backdrop-blur-xl rounded-2xl px-5 py-3 border border-red-500/20">
                                <div class="text-2xl font-black text-red-500" id="statsCommunityPosts">0</div>
                                <div class="text-xs text-gray-400 font-semibold" data-i18n="community.posts">Posts</div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500/20 to-purple-500/5 backdrop-blur-xl rounded-2xl px-5 py-3 border border-purple-500/20">
                                <div class="text-2xl font-black text-purple-400" id="statsCommunityMembers">0</div>
                                <div class="text-xs text-gray-400 font-semibold" data-i18n="community.members">Membres</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-500/20 to-green-500/5 backdrop-blur-xl rounded-2xl px-5 py-3 border border-green-500/20">
                                <div class="text-2xl font-black text-green-400" id="statsCommunityOnline">0</div>
                                <div class="text-xs text-gray-400 font-semibold" data-i18n="community.online">En ligne</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                    <!-- Colonne principale (News + Derniers ajouts) -->
                    <div class="xl:col-span-8 space-y-8">
                        <!-- Section News -->
                        <div>
                            <div class="flex items-center justify-between mb-5">
                                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                                    <div class="w-1 h-8 bg-gradient-to-b from-red-500 to-pink-500 rounded-full"></div>
                                    Actualités
                                </h2>
                                <button class="text-sm text-gray-400 hover:text-white transition-colors flex items-center gap-2">
                                    <span>Tout voir</span>
                                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div id="newsFeed" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[600px] overflow-y-auto pr-2 custom-scroll"></div>
                        </div>

                        <!-- Section Derniers Ajouts -->
                        <div>
                            <div class="flex items-center justify-between mb-5">
                                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                                    <div class="w-1 h-8 bg-gradient-to-b from-purple-500 to-blue-500 rounded-full"></div>
                                    Nouveautés
                                </h2>
                            </div>
                            <div class="bg-gradient-to-br from-white/5 to-white/[0.02] backdrop-blur-xl p-6 rounded-3xl border border-white/10">
                                <div id="newAdditionsList" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne latérale (Membres) -->
                    <div class="xl:col-span-4">
                        <div class="sticky top-6">
                            <div class="flex items-center justify-between mb-5">
                                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                                    <div class="w-1 h-8 bg-gradient-to-b from-green-500 to-emerald-500 rounded-full"></div>
                                    Membres
                                </h2>
                            </div>
                            <div class="bg-gradient-to-br from-white/5 to-white/[0.02] backdrop-blur-xl rounded-3xl border border-white/10 p-4">
                                <div id="communityUsers" class="space-y-2 max-h-[700px] overflow-y-auto pr-2 custom-scroll"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VUE PROFIL -->
            <div id="view-profile" class="view-section hidden">
                <div class="relative h-64 md:h-80 w-full mb-10 rounded-3xl overflow-hidden group">
                    <img id="profileBanner" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/50 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 w-full p-8 flex flex-col md:flex-row items-end gap-8">
                        <img id="profileAvatar" src="" class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-[#1c1c1e] bg-gray-800 object-cover shadow-2xl">
                        <div class="flex-1 mb-2">
                            <h1 id="profileName" class="text-4xl md:text-6xl font-bold text-white mb-2 shadow-sm">Pseudo</h1>
                            <p id="profileRole" class="text-gray-300 font-medium uppercase text-xs tracking-wider">User</p>
                            <div class="flex gap-6 text-sm text-gray-300 mt-3" id="profileStatsContainer">
                                <div class="cursor-pointer hover:text-white transition-colors" onclick="showUserList('followers')"><span id="profileFollowing" class="font-bold text-white">0</span> <span id="labelFollowing">Abonnés</span></div>
                                <div id="containerFollowing" class="cursor-pointer hover:text-white transition-colors" onclick="showUserList('following')"><span id="profileFollowers" class="font-bold text-white">0</span> Abonnements</div>
                            </div>
                        </div>
                        <div id="profileActions" class="mb-4"></div>
                    </div>
                    <button id="btnAdminEditProfile" class="absolute top-4 right-4 p-2 bg-black/40 hover:bg-black/60 rounded-full text-white hidden" onclick="openAdminEditProfile()"><i data-lucide="pencil" class="w-5 h-5"></i></button>
                </div>
                <h2 id="profileContentTitle" class="text-2xl font-bold mb-6 text-white" data-i18n="common.playlistsAndSongs">Playlists / Titres</h2>
                <div id="profilePlaylists" class="space-y-1"></div>
            </div>
            
            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="view-section hidden">
                <div class="max-w-4xl mx-auto">
                    <!-- Header -->
                    <div class="mb-10">
                        <h1 class="text-5xl md:text-6xl font-black mb-3 tracking-tight page-title" data-i18n="settings.title">Paramètres</h1>
                        <p class="text-gray-400 text-lg" data-i18n="settings.subtitle">Personnalisez votre expérience</p>
                    </div>

                    <!-- Settings Sections -->
                    <div class="space-y-6">
                        <!-- Account Section -->
                        <div class="bg-gradient-to-br from-white/10 to-white/[0.02] backdrop-blur-xl rounded-3xl p-8 border border-white/10">
                            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                                <i data-lucide="user" class="w-6 h-6 text-cyan-400"></i>
                                <span data-i18n="settings.account.title">Compte</span>
                            </h2>
                            
                            <!-- Change Username -->
                            <div class="mb-6">
                                <label class="block text-sm font-semibold text-gray-400 mb-3" data-i18n="settings.account.username">Nom d'utilisateur</label>
                                <div class="flex gap-3">
                                    <input type="text" id="newUsernameInput" class="flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:border-cyan-500 focus:outline-none" placeholder="Nouveau pseudo">
                                    <button onclick="changeUsername()" class="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-bold rounded-xl transition-all">
                                        <span data-i18n="settings.account.change">Modifier</span>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2" data-i18n="settings.account.usernameHint">3 caractères minimum</p>
                            </div>
                        </div>

                        <!-- Language Section -->
                        <div class="bg-gradient-to-br from-white/10 to-white/[0.02] backdrop-blur-xl rounded-3xl p-8 border border-white/10">
                            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                                <i data-lucide="globe" class="w-6 h-6 text-blue-400"></i>
                                <span data-i18n="settings.language.title">Langue</span>
                            </h2>
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <button onclick="changeLang('fr')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="fr">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1eb-1f1f7.svg" class="w-7 h-7" alt="FR">
                                    <span class="font-semibold text-white">Français</span>
                                </button>
                                <button onclick="changeLang('en')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="en">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1ec-1f1e7.svg" class="w-7 h-7" alt="EN">
                                    <span class="font-semibold text-white">English</span>
                                </button>
                                <button onclick="changeLang('es')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="es">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1ea-1f1f8.svg" class="w-7 h-7" alt="ES">
                                    <span class="font-semibold text-white">Español</span>
                                </button>
                                <button onclick="changeLang('it')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="it">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1ee-1f1f9.svg" class="w-7 h-7" alt="IT">
                                    <span class="font-semibold text-white">Italiano</span>
                                </button>
                                <button onclick="changeLang('pt')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="pt">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1f5-1f1f9.svg" class="w-7 h-7" alt="PT">
                                    <span class="font-semibold text-white">Português</span>
                                </button>
                                <button onclick="changeLang('de')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="de">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1e9-1f1ea.svg" class="w-7 h-7" alt="DE">
                                    <span class="font-semibold text-white">Deutsch</span>
                                </button>
                                <button onclick="changeLang('zh')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="zh">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1e8-1f1f3.svg" class="w-7 h-7" alt="ZH">
                                    <span class="font-semibold text-white">中文</span>
                                </button>
                                <button onclick="changeLang('ja')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="ja">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1ef-1f1f5.svg" class="w-7 h-7" alt="JA">
                                    <span class="font-semibold text-white">日本語</span>
                                </button>
                                <button onclick="changeLang('ko')" class="lang-btn px-4 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-cyan-500 rounded-xl transition-all text-left flex items-center gap-3" data-lang="ko">
                                    <img src="https://abs-0.twimg.com/emoji/v2/svg/1f1f0-1f1f7.svg" class="w-7 h-7" alt="KO">
                                    <span class="font-semibold text-white">한국어</span>
                                </button>
                            </div>
                        </div>

                        <!-- Theme Section -->
                        <div class="bg-gradient-to-br from-white/10 to-white/[0.02] backdrop-blur-xl rounded-3xl p-8 border border-white/10">
                            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                                <i data-lucide="palette" class="w-6 h-6 text-purple-400"></i>
                                <span data-i18n="settings.theme.title">Thème</span>
                            </h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <button onclick="changeTheme('dark')" class="theme-btn group relative overflow-hidden px-6 py-8 bg-gradient-to-br from-gray-900 to-black border-2 border-white/10 hover:border-purple-500 rounded-2xl transition-all" data-theme="dark">
                                    <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <div class="relative z-10">
                                        <div class="text-4xl mb-3">🌙</div>
                                        <div class="font-bold text-white text-lg" data-i18n="settings.theme.dark">Sombre</div>
                                        <div class="text-xs text-gray-400 mt-1" data-i18n="settings.theme.darkDesc">Par défaut</div>
                                    </div>
                                </button>
                                
                                <button onclick="changeTheme('light')" class="theme-btn group relative overflow-hidden px-6 py-8 bg-gradient-to-br from-gray-100 to-white border-2 border-gray-300 hover:border-purple-500 rounded-2xl transition-all" data-theme="light">
                                    <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <div class="relative z-10">
                                        <div class="text-4xl mb-3">☀️</div>
                                        <div class="font-bold text-gray-900 text-lg" data-i18n="settings.theme.light">Clair</div>
                                        <div class="text-xs text-gray-600 mt-1" data-i18n="settings.theme.lightDesc">Lumineux</div>
                                    </div>
                                </button>
                                
                                <button onclick="changeTheme('pink')" class="theme-btn group relative overflow-hidden px-6 py-8 bg-gradient-to-br from-pink-500 to-rose-600 border-2 border-pink-400 hover:border-purple-500 rounded-2xl transition-all" data-theme="pink">
                                    <div class="absolute inset-0 bg-gradient-to-br from-purple-500/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <div class="relative z-10">
                                        <div class="text-4xl mb-3">🌸</div>
                                        <div class="font-bold text-white text-lg" data-i18n="settings.theme.pink">Rose</div>
                                        <div class="text-xs text-pink-100 mt-1" data-i18n="settings.theme.pinkDesc">Doux</div>
                                    </div>
                                </button>
                                
                                <button onclick="changeTheme('lightpink')" class="theme-btn group relative overflow-hidden px-6 py-8 bg-gradient-to-br from-pink-100 to-rose-200 border-2 border-pink-300 hover:border-purple-500 rounded-2xl transition-all" data-theme="lightpink">
                                    <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                    <div class="relative z-10">
                                        <div class="text-4xl mb-3">🌺</div>
                                        <div class="font-bold text-pink-900 text-lg" data-i18n="settings.theme.lightpink">Rose Clair</div>
                                        <div class="text-xs text-pink-700 mt-1" data-i18n="settings.theme.lightpinkDesc">Pastel</div>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- VUE GESTION - REFONTE MODERNE -->
            <div id="view-users" class="view-section hidden">
                <!-- Header avec statistiques -->
                <div class="mb-10">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h1 class="text-4xl font-bold text-white mb-2">Gestion Serveur</h1>
                            <p class="text-gray-400">Administration et contrôle du contenu</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="bg-white/5 backdrop-blur-lg rounded-2xl px-6 py-4 border border-white/10">
                                <div class="text-2xl font-bold text-white" id="statsUsers">0</div>
                                <div class="text-xs text-gray-400 font-medium">Utilisateurs</div>
                            </div>
                            <div class="bg-white/5 backdrop-blur-lg rounded-2xl px-6 py-4 border border-white/10">
                                <div class="text-2xl font-bold text-red-500" id="statsSongs">0</div>
                                <div class="text-xs text-gray-400 font-medium">Titres</div>
                            </div>
                            <div class="bg-white/5 backdrop-blur-lg rounded-2xl px-6 py-4 border border-white/10">
                                <div class="text-2xl font-bold text-purple-500" id="statsArtists">0</div>
                                <div class="text-xs text-gray-400 font-medium">Artistes</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Onglets de navigation -->
                <div class="mb-8">
                    <div class="flex gap-2 border-b border-white/10 pb-2">
                        <button onclick="switchAdminTab('news')" id="adminTabNews" class="admin-tab px-6 py-3 rounded-t-xl font-semibold transition-all active">
                            <i data-lucide="newspaper" class="w-4 h-4 inline mr-2"></i>Actualités
                        </button>
                        <button onclick="switchAdminTab('content')" id="adminTabContent" class="admin-tab px-6 py-3 rounded-t-xl font-semibold transition-all">
                            <i data-lucide="library" class="w-4 h-4 inline mr-2"></i>Contenu
                        </button>
                        <button onclick="switchAdminTab('users')" id="adminTabUsers" class="admin-tab px-6 py-3 rounded-t-xl font-semibold transition-all">
                            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>Utilisateurs
                        </button>
                        <button onclick="switchAdminTab('system')" id="adminTabSystem" class="admin-tab px-6 py-3 rounded-t-xl font-semibold transition-all">
                            <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>Système
                        </button>
                    </div>
                </div>

                <!-- Contenu des onglets -->
                <div id="adminContentNews" class="admin-tab-content">
                    <!-- Publication de News -->
                    <div class="bg-gradient-to-br from-green-500/10 to-emerald-500/5 backdrop-blur-lg rounded-2xl p-8 border border-green-500/20 mb-6">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="p-4 bg-green-500/20 rounded-xl">
                                <i data-lucide="newspaper" class="w-8 h-8 text-green-500"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-white">Publier une News</h2>
                                <p class="text-green-400/80 text-sm">Partagez les dernières nouveautés avec la communauté</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-300 mb-2 block">Titre</label>
                                <input type="text" id="postTitle" class="w-full px-5 py-4 rounded-xl bg-black/30 border border-white/10 focus:border-green-500/50 focus:bg-black/40 transition-all text-white placeholder-gray-500" placeholder="Titre accrocheur de votre article...">
                            </div>
                            
                            <div>
                                <label class="text-sm font-semibold text-gray-300 mb-2 block">Contenu</label>
                                <textarea id="postContent" class="w-full px-5 py-4 rounded-xl bg-black/30 border border-white/10 focus:border-green-500/50 focus:bg-black/40 transition-all text-white placeholder-gray-500 resize-none" rows="6" placeholder="Rédigez votre contenu ici..."></textarea>
                            </div>
                            
                            <div>
                                <label class="text-sm font-semibold text-gray-300 mb-2 block">Média</label>
                                <div class="drop-zone w-full h-56 rounded-xl flex flex-col items-center justify-center cursor-pointer bg-black/20 hover:bg-black/30 border-2 border-dashed border-white/20 hover:border-green-500/50 relative group transition-all">
                                    <input type="file" id="postMediaFile" accept="image/*,video/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleSingleFileSelect(this, 'postMedia')">
                                    <img id="postMediaPreview" class="absolute inset-0 w-full h-full object-cover opacity-60 hidden rounded-xl">
                                    <video id="postMediaVideoPreview" class="absolute inset-0 w-full h-full object-cover opacity-60 hidden rounded-xl" muted></video>
                                    <div class="flex flex-col items-center text-gray-400 pointer-events-none group-hover:text-green-400 transition-colors z-10">
                                        <div class="p-4 bg-white/5 rounded-full mb-3 group-hover:bg-green-500/10 transition-all">
                                            <i data-lucide="image-plus" class="w-10 h-10"></i>
                                        </div>
                                        <span class="text-base font-semibold">Glisser une image ou vidéo</span>
                                        <span class="text-sm text-gray-500 mt-1">ou cliquer pour parcourir</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-sm font-semibold text-gray-300 mb-2 block">URL Média (optionnel)</label>
                                <input type="url" id="postMediaUrl" class="w-full px-5 py-4 rounded-xl bg-black/30 border border-white/10 focus:border-green-500/50 transition-all text-white placeholder-gray-500" placeholder="https://exemple.com/image.jpg" oninput="document.getElementById('postMedia').value = this.value">
                            </div>
                            
                            <input type="hidden" id="postMedia">
                            <input type="hidden" id="postMediaType" value="image">
                            
                            <button onclick="submitPost()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-green-900/30 hover:shadow-green-900/50 transform hover:scale-[1.02]">
                                <i data-lucide="send" class="w-5 h-5 inline mr-2"></i>Publier l'article
                            </button>
                        </div>
                    </div>
                </div>

                <div id="adminContentContent" class="admin-tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Gestion Artistes -->
                        <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/5 backdrop-blur-lg rounded-2xl border border-purple-500/20 overflow-hidden flex flex-col" style="height: 600px;">
                            <div class="p-6 border-b border-white/10">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="p-3 bg-purple-500/20 rounded-xl">
                                            <i data-lucide="mic-2" class="w-6 h-6 text-purple-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-xl font-bold text-white" data-i18n="admin.artists.title">Artistes</h3>
                                            <p class="text-sm text-gray-400" data-i18n="admin.artists.subtitle">Érer les profils d'artistes</p>
                                        </div>
                                    </div>
                                    <button onclick="openEditArtistModal()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 rounded-xl text-purple-300 font-semibold flex items-center gap-2 transition-all hover:scale-105">
                                        <i data-lucide="plus" class="w-4 h-4"></i>Créer
                                    </button>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-6" id="adminArtistList">
                                <!-- Liste dynamique -->
                            </div>
                        </div>

                        <!-- Gestion Genres -->
                        <div class="bg-gradient-to-br from-red-500/10 to-orange-500/5 backdrop-blur-lg rounded-2xl border border-red-500/20 overflow-hidden flex flex-col" style="height: 600px;">
                            <div class="p-6 border-b border-white/10">
                                <div class="flex items-center gap-3">
                                    <div class="p-3 bg-red-500/20 rounded-xl">
                                        <i data-lucide="tag" class="w-6 h-6 text-red-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-white">Genres Musicaux</h3>
                                        <p class="text-sm text-gray-400">Catégoriser la musique</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 flex flex-col h-full overflow-hidden">
                                <div class="flex gap-3 mb-6">
                                    <input type="text" id="newGenreInput" class="flex-1 px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:border-red-500/50 transition-all text-white placeholder-gray-500" placeholder="Nouveau genre musical...">
                                    <button onclick="addGenre()" class="px-6 py-3 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white rounded-xl font-bold transition-all shadow-lg">
                                        <i data-lucide="plus" class="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div id="genreAdminList" class="flex-1 overflow-y-auto space-y-2 pr-2">
                                    <!-- Liste dynamique -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="adminContentUsers" class="admin-tab-content hidden">
                    <!-- Table utilisateurs -->
                    <div class="bg-white/5 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden">
                        <div class="p-6 border-b border-white/10">
                            <div class="flex items-center gap-3">
                                <div class="p-3 bg-blue-500/20 rounded-xl">
                                    <i data-lucide="users" class="w-6 h-6 text-blue-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Utilisateurs Enregistrés</h3>
                                    <p class="text-sm text-gray-400">Liste complète des membres</p>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-black/20">
                                    <tr class="text-left text-sm text-gray-400 border-b border-white/10">
                                        <th class="px-6 py-4 font-semibold">Utilisateur</th>
                                        <th class="px-6 py-4 font-semibold">Email</th>
                                        <th class="px-6 py-4 font-semibold">Playlists</th>
                                        <th class="px-6 py-4 font-semibold">Admin</th>
                                        <th class="px-6 py-4 font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody" class="divide-y divide-white/5 text-sm">
                                    <!-- Liste dynamique -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="adminContentSystem" class="admin-tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Notifications -->
                        <div class="bg-gradient-to-br from-blue-500/10 to-cyan-500/5 backdrop-blur-lg rounded-2xl p-6 border border-blue-500/20">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-3 bg-blue-500/20 rounded-xl">
                                    <i data-lucide="bell-plus" class="w-6 h-6 text-blue-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Envoyer une Notification</h3>
                                    <p class="text-sm text-gray-400">Alerter les utilisateurs</p>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm font-semibold text-gray-300 mb-2 block">Destinataire</label>
                                    <select id="notifTargetUser" class="w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:border-blue-500/50 transition-all text-white">
                                        <option value="all">Tous les utilisateurs</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-sm font-semibold text-gray-300 mb-2 block">Message</label>
                                    <input type="text" id="notifMessage" class="w-full px-4 py-3 rounded-xl bg-black/30 border border-white/10 focus:border-blue-500/50 transition-all text-white placeholder-gray-500" placeholder="Votre message...">
                                </div>
                                
                                <button onclick="sendAdminNotification()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg">
                                    <i data-lucide="send" class="w-5 h-5 inline mr-2"></i>Envoyer la notification
                                </button>
                            </div>
                        </div>

                        <!-- Statistiques serveur -->
                        <div class="bg-gradient-to-br from-violet-500/10 to-purple-500/5 backdrop-blur-lg rounded-2xl p-6 border border-violet-500/20">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="p-3 bg-violet-500/20 rounded-xl">
                                    <i data-lucide="bar-chart-3" class="w-6 h-6 text-violet-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Statistiques du Serveur</h3>
                                    <p class="text-sm text-gray-400">Vue d'ensemble</p>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-black/20 rounded-xl border border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-green-500/20 rounded-lg">
                                            <i data-lucide="music" class="w-5 h-5 text-green-400"></i>
                                        </div>
                                        <span class="text-gray-300 font-medium" data-i18n="admin.stats.totalSongs">Titres totaux</span>
                                    </div>
                                    <span class="text-2xl font-bold text-white" id="statsDetailSongs">0</span>
                                </div>
                                
                                <div class="flex items-center justify-between p-4 bg-black/20 rounded-xl border border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-purple-500/20 rounded-lg">
                                            <i data-lucide="mic-2" class="w-5 h-5 text-purple-400"></i>
                                        </div>
                                        <span class="text-gray-300 font-medium" data-i18n="admin.stats.activeArtists">Artistes actifs</span>
                                    </div>
                                    <span class="text-2xl font-bold text-white" id="statsDetailArtists">0</span>
                                </div>
                                
                                <div class="flex items-center justify-between p-4 bg-black/20 rounded-xl border border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-blue-500/20 rounded-lg">
                                            <i data-lucide="users" class="w-5 h-5 text-blue-400"></i>
                                        </div>
                                        <span class="text-gray-300 font-medium">Membres inscrits</span>
                                    </div>
                                    <span class="text-2xl font-bold text-white" id="statsDetailUsers">0</span>
                                </div>
                                
                                <div class="flex items-center justify-between p-4 bg-black/20 rounded-xl border border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-red-500/20 rounded-lg">
                                            <i data-lucide="tag" class="w-5 h-5 text-red-400"></i>
                                        </div>
                                        <span class="text-gray-300 font-medium">Genres disponibles</span>
                                    </div>
                                    <span class="text-2xl font-bold text-white" id="statsDetailGenres">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="view-playlist" class="view-section hidden">
                <div class="flex flex-col md:flex-row items-end gap-8 mb-10 relative group">
                    <img id="plCover" src="" class="w-64 h-64 rounded-xl shadow-2xl bg-gray-800 object-cover">
                    <div class="flex-1">
                        <h1 id="plTitle" class="text-5xl md:text-7xl font-bold mt-2 mb-4 text-white">Titre</h1>
                        <p id="plOwner" class="text-gray-300 font-medium text-lg">...</p>
                        <!-- Bouton Like Album -->
                        <button id="btnLikeAlbum" onclick="event.stopPropagation(); toggleAlbumLike(encodeURIComponent(window.currentAlbumName || ''))" class="mt-4 flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors text-gray-400 hover:text-red-500 hidden" title="J'aime cet album">
                            <i data-lucide="heart" class="w-5 h-5"></i>
                            <span id="albumLikeText">J'aime</span>
                        </button>
                    </div>
                    <button id="btnEditPlaylist" onclick="openEditPlaylistModal()" class="absolute top-0 right-0 p-3 bg-white/10 hover:bg-white/20 rounded-full hidden"><i data-lucide="pencil" class="w-5 h-5 text-white"></i></button>
                    <button id="btnDeletePlaylist" onclick="deletePlaylist()" class="absolute top-0 right-12 p-3 bg-red-500/80 hover:bg-red-500 rounded-full hidden text-white"><i data-lucide="trash" class="w-5 h-5"></i></button>
                </div>
                <div id="plSongs" class="space-y-1"></div>
            </div>
        </div>
    </main>

    <!-- MODALS -->
    <div id="newsDetailModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/80 hidden"><div class="glass-modal w-full max-w-2xl rounded-2xl p-0 relative overflow-hidden flex flex-col max-h-[80vh]"><button onclick="document.getElementById('newsDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-white bg-black/50 p-2 rounded-full z-10"><i data-lucide="x"></i></button><div id="newsDetailContent" class="overflow-y-auto"></div></div></div>

    <div id="addModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden"><div class="glass-modal w-full max-w-md rounded-2xl p-6 relative"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white" id="addModalTitle">Ajouter / Modifier</h3><button onclick="closeAddModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="flex border-b border-white/10 mb-4"><button onclick="switchAddTab('song')" id="tabSong" class="modal-tab flex-1 active">Son unique</button><button onclick="switchAddTab('album')" id="tabAlbum" class="modal-tab flex-1">Album entier</button></div><form id="formSong" onsubmit="handleSongSubmit(event)" class="space-y-4"><input type="hidden" id="editSongId" value=""><input type="hidden" id="existingSrc" value=""><div class="drop-zone w-full h-24 rounded-xl flex flex-col items-center justify-center cursor-pointer bg-white/5 hover:bg-white/10 relative"><input type="file" id="fileInputSong" accept="audio/*,.mp3,.wav,.flac,.ogg,.aac,.m4a,.opus,.alac,.wma,.aiff,.ape,.dsd" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleFileSelect(this, 'song')"><div id="dropContentSong" class="text-center pointer-events-none text-xs text-gray-400 flex flex-col items-center"><i data-lucide="upload-cloud" class="w-6 h-6 mb-1"></i>Fichier Audio</div></div><input type="hidden" id="audioDataSong" value=""><input type="text" id="inputTitle" required class="w-full px-3 py-2 rounded-lg input-dark text-sm" placeholder="Titre"><div class="space-y-2">
                    <label class="text-xs text-gray-400">Artiste(s)</label>
                    <div class="flex gap-2">
                        <input type="text" id="inputArtist" class="flex-1 px-3 py-2 rounded-lg input-dark text-sm" placeholder="Ajouter un artiste" onkeypress="if(event.key==='Enter'){event.preventDefault();addSongArtist();}">
                        <button type="button" onclick="addSongArtist()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold text-sm">+</button>
                    </div>
                    <div id="songArtistsList" class="space-y-1"></div>
                </div><select id="inputGenre" class="w-full px-3 py-2 rounded-lg input-dark text-sm text-white"></select><div class="drop-zone w-full h-24 rounded-xl relative flex items-center justify-center bg-white/5 hover:bg-white/10 group"><input type="file" id="inputCoverFile" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleSingleFileSelect(this, 'inputCover')"><img id="inputCoverPreview" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden rounded-xl"><div class="text-center pointer-events-none text-xs text-gray-400"><i data-lucide="image" class="w-5 h-5 mx-auto mb-1"></i>Cover</div></div><input type="url" id="inputCoverUrl" class="w-full input-dark rounded-xl px-3 py-2 text-sm bg-black/20" placeholder="Ou URL Cover" oninput="document.getElementById('inputCover').value=this.value"><input type="hidden" id="inputCover"><input type="url" id="inputAudioUrl" class="w-full px-3 py-2 rounded-lg input-dark text-sm" placeholder="ou Lien Audio (SoundCloud/Direct)"><button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl">Valider</button></form><form id="formAlbum" onsubmit="handleAlbumSubmit(event)" class="space-y-4 hidden"><div class="drop-zone w-full h-32 rounded-xl flex flex-col items-center justify-center cursor-pointer bg-white/5 hover:bg-white/10 relative"><input type="file" id="fileInputAlbum" accept="audio/*,.mp3,.wav,.flac,.ogg,.aac,.m4a,.opus,.alac,.wma,.aiff,.ape,.dsd" multiple class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleAlbumFilesSelect(this)"><div id="dropContentAlbum" class="text-center pointer-events-none text-xs text-gray-400 flex flex-col items-center"><i data-lucide="folder-plus" class="w-8 h-8 mb-2"></i>Sélectionner des fichiers</div></div><div id="albumFileList" class="text-xs text-gray-500 max-h-20 overflow-y-auto hidden"></div><input type="text" id="inputAlbumName" required class="w-full px-3 py-2 rounded-lg input-dark text-sm" placeholder="Nom de l'album">
                <div class="space-y-2">
                    <label class="text-xs text-gray-400">Artiste(s)</label>
                    <div class="flex gap-2">
                        <input type="text" id="inputAlbumArtist" class="flex-1 px-3 py-2 rounded-lg input-dark text-sm" placeholder="Ajouter un artiste" onkeypress="if(event.key==='Enter'){event.preventDefault();addAlbumArtist();}">
                        <button type="button" onclick="addAlbumArtist()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm">+</button>
                    </div>
                    <div id="albumArtistsList" class="space-y-1"></div>
                </div>
                <select id="inputAlbumGenre" class="w-full px-3 py-2 rounded-lg input-dark text-sm text-white"></select><div class="drop-zone w-full h-24 rounded-xl relative flex items-center justify-center bg-white/5 hover:bg-white/10 group"><input type="file" id="inputAlbumCoverFile" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleSingleFileSelect(this, 'inputAlbumCover')"><img id="inputAlbumCoverPreview" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden rounded-xl"><div class="text-center pointer-events-none text-xs text-gray-400"><i data-lucide="image" class="w-5 h-5 mx-auto mb-1"></i>Cover Album</div></div><input type="url" id="inputAlbumCoverUrl" class="w-full input-dark rounded-xl px-3 py-2 text-sm bg-black/20" placeholder="Ou URL Cover" oninput="document.getElementById('inputAlbumCover').value=this.value"><input type="hidden" id="inputAlbumCover"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl">Importer Album</button></form></div></div>
    
    <!-- ADD TO PLAYLIST MODAL (NEW) -->
    <div id="addToPlaylistModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/80 hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative h-[60vh] flex flex-col"><button onclick="document.getElementById('addToPlaylistModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button><h3 class="text-xl font-bold mb-4">Ajouter à...</h3><div id="addToPlaylistContent" class="flex-1 overflow-y-auto space-y-2"></div></div></div>

    <div id="editAlbumModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative"><button onclick="document.getElementById('editAlbumModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button><h3 class="text-xl font-bold mb-4">Modifier l'Album</h3><input type="hidden" id="editAlbumOldName"><div class="space-y-4"><input id="editAlbumNewName" class="w-full px-3 py-2 rounded-lg input-dark text-sm" placeholder="Nom"><input id="editAlbumArtist" class="w-full px-3 py-2 rounded-lg input-dark text-sm" placeholder="Artiste"><div class="drop-zone w-full h-24 rounded-xl relative flex items-center justify-center bg-white/5 hover:bg-white/10 group"><input type="file" id="editAlbumCoverFile" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleSingleFileSelect(this, 'editAlbumCover')"><img id="editAlbumCoverPreview" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden rounded-xl"><div class="text-center pointer-events-none text-xs text-gray-400"><i data-lucide="image" class="w-5 h-5 mx-auto mb-1"></i>Modifier Cover</div></div><input type="url" id="editAlbumCoverUrl" class="w-full input-dark rounded-xl px-3 py-2 text-sm bg-black/20" placeholder="Ou URL Cover" oninput="document.getElementById('editAlbumCover').value=this.value"><input type="hidden" id="editAlbumCover"><button onclick="saveAlbumEdit()" class="w-full bg-white text-black font-bold py-2 rounded-lg">Enregistrer</button></div></div></div>
    <div id="editArtistModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative"><button onclick="document.getElementById('editArtistModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button><h3 class="text-xl font-bold mb-4">Profil Artiste</h3><input type="hidden" id="editArtistOriginalName"><div class="space-y-4"><label class="text-xs text-gray-400">Nom</label><input id="editArtistName" class="w-full px-3 py-2 rounded-lg input-dark text-sm"><div class="grid grid-cols-2 gap-4"><div><label class="text-xs text-gray-400">Avatar</label><div class="drop-zone w-full aspect-square rounded-full relative flex items-center justify-center bg-white/5 hover:bg-white/10 group"><input type="file" id="editArtistAvatarFile" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleSingleFileSelect(this, 'editArtistAvatar')"><img id="editArtistAvatarPreview" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden rounded-full"><i data-lucide="camera" class="w-5 h-5 text-gray-400"></i></div><input type="url" id="editArtistAvatarUrl" class="w-full input-dark rounded-xl px-3 py-2 text-sm bg-black/20 mt-1" placeholder="URL Avatar" oninput="document.getElementById('editArtistAvatar').value=this.value"><input type="hidden" id="editArtistAvatar"></div><div><label class="text-xs text-gray-400">Bannière</label><div class="drop-zone w-full aspect-square rounded-xl relative flex items-center justify-center bg-white/5 hover:bg-white/10 group"><input type="file" id="editArtistBannerFile" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleSingleFileSelect(this, 'editArtistBanner')"><img id="editArtistBannerPreview" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden rounded-xl"><i data-lucide="image" class="w-5 h-5 text-gray-400"></i></div><input type="url" id="editArtistBannerUrl" class="w-full input-dark rounded-xl px-3 py-2 text-sm bg-black/20 mt-1" placeholder="URL Bannière" oninput="document.getElementById('editArtistBanner').value=this.value"><input type="hidden" id="editArtistBanner"></div></div><button onclick="saveArtistProfile()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg">Enregistrer</button></div></div></div>
    
    <div id="userListModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/80 hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative h-[60vh] flex flex-col"><button onclick="document.getElementById('userListModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button><h3 class="text-xl font-bold mb-4" id="userListTitle">Liste</h3><div id="userListContent" class="flex-1 overflow-y-auto space-y-2"></div></div></div>

    <div id="authModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/90 backdrop-blur-md hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-8 text-center relative">
        <div id="loginForm"><div class="mb-6"><h3 class="text-2xl font-bold text-white mb-2" id="authTitle">Connexion</h3></div><div class="space-y-4 text-left"><input type="text" id="authUsername" class="w-full px-4 py-3 rounded-xl input-dark text-sm" placeholder="Nom d'utilisateur"><input type="password" id="authPassword" class="w-full px-4 py-3 rounded-xl input-dark text-sm" placeholder="Mot de passe"><button onclick="performAuth()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl" id="authBtnAction">Se connecter</button><div class="text-center text-xs text-gray-400 mt-6 pt-4 border-t border-white/10"><button onclick="toggleAuthMode()" class="text-white font-bold hover:underline" id="authSwitchBtn">Créer un compte</button></div></div></div>
    </div></div>
    
    <!-- SEARCH PAGE MODAL -->
    <div id="searchModal" class="fixed inset-0 z-modal bg-black/95 backdrop-blur-xl hidden">
        <div class="h-full flex flex-col">
            <!-- Search Header -->
            <div class="flex items-center gap-4 px-8 py-6 border-b border-white/10">
                <button onclick="closeSearchPage()" class="text-gray-400 hover:text-white">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <div class="relative flex-1 max-w-2xl">
                    <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-gray-400"></i>
                    <input type="text" id="searchModalInput" placeholder="Rechercher des titres, artistes, utilisateurs..." class="w-full bg-white/10 text-base py-3 pl-12 pr-4 rounded-xl focus:outline-none focus:bg-white/15 text-white" autofocus>
                </div>
            </div>
            
            <!-- Search Results -->
            <div class="flex-1 overflow-y-auto p-8">
                <div class="max-w-4xl mx-auto space-y-8">
                    <!-- Songs Section -->
                    <div id="searchModalSongs" class="hidden">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <i data-lucide="music" class="w-5 h-5 text-red-500"></i>
                            Titres
                        </h3>
                        <div id="searchModalSongsList" class="grid grid-cols-1 gap-2"></div>
                    </div>
                    
                    <!-- Users Section -->
                    <div id="searchModalUsers" class="hidden">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5 text-red-500"></i>
                            Profils
                        </h3>
                        <div id="searchModalUsersList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
                    </div>
                    
                    <!-- No Results -->
                    <div id="searchModalEmpty" class="hidden text-center py-20">
                        <i data-lucide="search-x" class="w-16 h-16 mx-auto mb-4 text-gray-600"></i>
                        <p class="text-gray-400 text-lg">Aucun résultat trouvé</p>
                        <p class="text-gray-500 text-sm mt-2">Essayez avec d'autres mots-clés</p>
                    </div>
                    
                    <!-- Initial State -->
                    <div id="searchModalInitial" class="text-center py-20">
                        <i data-lucide="search" class="w-16 h-16 mx-auto mb-4 text-gray-600"></i>
                        <p class="text-gray-400 text-lg">Commencez à taper pour rechercher</p>
                        <p class="text-gray-500 text-sm mt-2">Titres, artistes, albums, utilisateurs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="siteConfigModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/80 hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative"><button onclick="document.getElementById('siteConfigModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button><h3 class="text-xl font-bold mb-4">Site</h3><input id="editSiteName" class="w-full mb-3 px-3 py-2 rounded-lg input-dark"><input id="editSiteLogo" class="w-full mb-4 px-3 py-2 rounded-lg input-dark"><button onclick="saveSiteConfig()" class="w-full bg-white text-black font-bold py-2 rounded-lg">OK</button></div></div>
    <div id="createPlaylistModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/80 hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative"><button onclick="document.getElementById('createPlaylistModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button><h3 class="text-xl font-bold mb-4">Playlist</h3><input id="newPlaylistName" class="w-full mb-4 px-3 py-2 rounded-lg input-dark" placeholder="Nom"><button onclick="submitCreatePlaylist()" class="w-full bg-red-500 text-white font-bold py-2 rounded-lg">Créer</button></div></div>
    <div id="editPlaylistModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/80 hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative"><button onclick="document.getElementById('editPlaylistModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button><h3 class="text-xl font-bold mb-4">Modifier Playlist</h3><input type="hidden" id="editPlaylistId"><label class="text-xs text-gray-400 mb-1 block">Nom</label><input id="editPlaylistName" class="w-full mb-3 px-3 py-2 rounded-lg input-dark"><label class="text-xs text-gray-400 mb-1 block">Cover</label><div class="drop-zone w-full h-24 rounded-xl relative flex items-center justify-center bg-white/5 hover:bg-white/10 group"><input type="file" id="editPlaylistCoverFile" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleSingleFileSelect(this, 'editPlaylistCover')"><img id="editPlaylistCoverPreview" class="absolute inset-0 w-full h-full object-cover opacity-50 hidden rounded-xl"><div class="text-center pointer-events-none text-xs text-gray-400"><i data-lucide="image" class="w-5 h-5 mx-auto mb-1"></i>Modifier Cover</div></div><input type="url" id="editPlaylistCoverUrl" class="w-full input-dark rounded-xl px-3 py-2 text-sm bg-black/20" placeholder="Ou URL Cover" oninput="document.getElementById('editPlaylistCover').value=this.value"><input type="hidden" id="editPlaylistCover"><button onclick="savePlaylistEdit()" class="w-full bg-white text-black font-bold py-2 rounded-lg mt-4">Enregistrer</button></div></div>
    <div id="profileModal" class="fixed inset-0 z-modal flex items-center justify-center p-4 bg-black/80 hidden"><div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative"><button onclick="document.getElementById('profileModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400"><i data-lucide="x"></i></button><h3 class="text-xl font-bold mb-4">Modifier Profil</h3><div class="drop-zone w-32 h-32 rounded-full mx-auto mb-4 relative flex items-center justify-center bg-white/5 group hover:bg-white/10"><input type="file" id="avatarInput" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleAvatarSelect(this)"><img id="avatarPreview" class="absolute inset-0 w-full h-full rounded-full object-cover opacity-50 hidden"><i data-lucide="camera" class="w-6 h-6 text-gray-400 z-10"></i></div><input type="url" id="avatarUrlInput" class="w-full input-dark rounded-xl px-3 py-2 text-sm bg-black/20 mb-4" placeholder="Ou URL Avatar" oninput="document.getElementById('avatarData').value=this.value"><label class="text-xs text-gray-400 mb-2 block">Bannière</label><div class="drop-zone w-full h-24 rounded-xl mb-4 relative flex items-center justify-center bg-white/5 group hover:bg-white/10"><input type="file" id="bannerInput" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleBannerSelect(this)"><img id="bannerPreview" class="absolute inset-0 w-full h-full rounded-xl object-cover opacity-50 hidden"><div class="flex flex-col items-center text-gray-400 pointer-events-none"><i data-lucide="image" class="w-5 h-5 mb-1"></i><span class="text-[10px]">Modifier bannière</span></div></div><input type="url" id="bannerUrlInput" class="w-full input-dark rounded-xl px-3 py-2 text-sm bg-black/20 mb-4" placeholder="Ou URL Bannière" oninput="document.getElementById('bannerData').value=this.value"><input type="hidden" id="avatarData"><input type="hidden" id="bannerData"><button onclick="updateProfile()" class="w-full bg-white text-black font-bold py-2 rounded-lg">Enregistrer</button></div></div>
    
    <!-- CUSTOM CONFIRM MODAL -->
    <div id="customConfirmModal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative animate-fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-circle" class="w-8 h-8 text-red-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Confirmation</h3>
                <p id="customConfirmMessage" class="text-gray-300 text-sm"></p>
            </div>
            <div class="flex gap-3">
                <button id="customConfirmCancel" class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-xl transition">Annuler</button>
                <button id="customConfirmOk" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl transition">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM ALERT MODAL -->
    <div id="customAlertModal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative animate-fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="info" class="w-8 h-8 text-blue-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Information</h3>
                <p id="customAlertMessage" class="text-gray-300 text-sm"></p>
            </div>
            <button id="customAlertOk" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl transition">OK</button>
        </div>
    </div>

    <!-- CUSTOM PROMPT MODAL -->
    <div id="customPromptModal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden">
        <div class="glass-modal w-full max-w-sm rounded-2xl p-6 relative animate-fade-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="edit-3" class="w-8 h-8 text-purple-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2" id="customPromptTitle">Saisir</h3>
                <p id="customPromptMessage" class="text-gray-300 text-sm mb-4"></p>
                <input type="text" id="customPromptInput" class="w-full px-4 py-3 rounded-xl input-dark text-sm" placeholder="Votre réponse">
            </div>
            <div class="flex gap-3">
                <button id="customPromptCancel" class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-xl transition">Annuler</button>
                <button id="customPromptOk" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 rounded-xl transition">Valider</button>
            </div>
        </div>
    </div>
    
    <iframe id="scPlayer" class="absolute top-0 left-0 w-1 h-1 opacity-0 pointer-events-none" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/293&auto_play=false" allow="autoplay"></iframe>
    <audio id="audioPlayer"></audio>

    <script>
        // --- HELPER & CONSTANTS ---
        function safeEncode(str) { if (!str) return ""; return encodeURIComponent(str).replace(/'/g, "%27"); }
        const ACTIVE_SERVER = window.location.origin;
        // --- 1. DEFAULT COVER CONSTANT ---
        const DEFAULT_COVER = "https://via.placeholder.com/300/121212/FFFFFF?text=No+Cover";
        
        // --- CUSTOM MODALS (CONFIRM, ALERT, PROMPT) ---
        function customConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const messageEl = document.getElementById('customConfirmMessage');
                const okBtn = document.getElementById('customConfirmOk');
                const cancelBtn = document.getElementById('customConfirmCancel');
                
                messageEl.textContent = message;
                modal.classList.remove('hidden');
                lucide.createIcons();
                
                const handleOk = () => {
                    modal.classList.add('hidden');
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    modal.classList.add('hidden');
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }
        
        function customAlert(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('customAlertModal');
                const messageEl = document.getElementById('customAlertMessage');
                const okBtn = document.getElementById('customAlertOk');
                
                messageEl.textContent = message;
                modal.classList.remove('hidden');
                lucide.createIcons();
                
                const handleOk = () => {
                    modal.classList.add('hidden');
                    okBtn.removeEventListener('click', handleOk);
                    resolve();
                };
                
                okBtn.addEventListener('click', handleOk);
            });
        }
        
        function customPrompt(message, defaultValue = '') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customPromptModal');
                const messageEl = document.getElementById('customPromptMessage');
                const input = document.getElementById('customPromptInput');
                const okBtn = document.getElementById('customPromptOk');
                const cancelBtn = document.getElementById('customPromptCancel');
                
                messageEl.textContent = message;
                input.value = defaultValue;
                modal.classList.remove('hidden');
                lucide.createIcons();
                setTimeout(() => input.focus(), 100);
                
                const handleOk = () => {
                    modal.classList.add('hidden');
                    const value = input.value;
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    input.removeEventListener('keypress', handleEnter);
                    resolve(value || null);
                };
                
                const handleCancel = () => {
                    modal.classList.add('hidden');
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    input.removeEventListener('keypress', handleEnter);
                    resolve(null);
                };
                
                const handleEnter = (e) => {
                    if(e.key === 'Enter') {
                        e.preventDefault();
                        handleOk();
                    }
                };
                
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                input.addEventListener('keypress', handleEnter);
            });
        }
        
        // --- FIX: ASYNC FILE READING HELPER ---
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- STATE ---
        let songs = [], filteredSongs = [], playlists = [], genres = [], notifications = [], users = [], posts = [], artists = [];
        let currentUser = null, isRegistering = false;
        let currentSongId = null, isPlaying = false, isShuffle = false, repeatMode = 0; 
        let currentAlbumName = null; // Store current album name for like button 
        let viewingProfileType = 'user'; let viewingProfileId = null;
        let scWidget = null;
        let audioDuration = 0;
        let songToAddId = null;
        let scUpdateInterval = null;
        let currentLang = localStorage.getItem('appLang') || 'fr';
        let currentTheme = localStorage.getItem('appTheme') || 'dark';

        const audio = document.getElementById('audioPlayer');
        audio.onplay = () => { isPlaying = true; updatePlayBtn(); };
        audio.onpause = () => { isPlaying = false; updatePlayBtn(); };
        audio.ontimeupdate = updateProgress;
        audio.onloadedmetadata = () => { audioDuration = audio.duration; document.getElementById('duration').innerText = formatTimeRemaining(0, audioDuration); }
        audio.onended = onTrackEnd;

        function onTrackEnd() {
            if(repeatMode === 2) { 
                // Repeat One (Song) - Replay the current song
                const s = songs.find(x => x.id === currentSongId);
                if(s) {
                    if(s.src.includes('soundcloud')) {
                        // For SoundCloud, reset to beginning and play
                        scWidget.seekTo(0);
                        scWidget.play();
                    } else { 
                        // For native audio, restart and play
                        audio.currentTime = 0; 
                        audio.play(); 
                    }
                }
            } 
            else if (repeatMode === 1) { 
                // Repeat All - Go to next song, loop at end
                nextSong(); 
            } 
            else { 
                // No Repeat - Stop after last song
                const currentIdx = filteredSongs.findIndex(s => s.id === currentSongId); 
                if (currentIdx >= 0 && currentIdx < filteredSongs.length - 1) { 
                    nextSong(); 
                } 
                else { 
                    isPlaying = false; 
                    updatePlayBtn(); 
                } 
            }
        }

        // --- SC PLAYER ---
        window.onload = function() {
            scWidget = SC.Widget(document.getElementById('scPlayer'));
            scWidget.bind(SC.Widget.Events.FINISH, onTrackEnd);
            scWidget.bind(SC.Widget.Events.PAUSE, () => { isPlaying = false; updatePlayBtn(); clearInterval(scUpdateInterval); });
            scWidget.bind(SC.Widget.Events.PLAY, () => { 
                isPlaying = true; 
                updatePlayBtn();
                // Start regular updates when playing
                if(scUpdateInterval) clearInterval(scUpdateInterval);
                scUpdateInterval = setInterval(updateSCProgress, 100);
            });
            scWidget.bind(SC.Widget.Events.PLAY_PROGRESS, (data) => {
                // This event fires regularly during playback
                const current = data.currentPosition / 1000;
                const duration = data.duration / 1000 || 0;
                
                // Update duration if available (critical for timecode)
                if(duration > 0) {
                    audioDuration = duration;
                }
                
                // Only update UI if we have valid duration
                if(audioDuration > 0) {
                    const pct = (current / audioDuration) * 100; 
                    document.getElementById('progressInput').value = pct || 0; 
                    document.getElementById('progressBar').style.width = `${pct || 0}%`; 
                    document.getElementById('currentTime').innerText = formatTime(current); 
                    document.getElementById('duration').innerText = formatTimeRemaining(current, audioDuration); 
                }
            });
        };

        function updateSCProgress() {
            if(!scWidget || !isPlaying) return;
            try {
                scWidget.getPosition(pos => {
                    scWidget.getDuration(dur => {
                        const current = (pos || 0) / 1000;
                        const durationSec = (dur || 0) / 1000;
                        
                        // Only update if we have valid duration
                        if(durationSec > 0) {
                            audioDuration = durationSec;
                            const pct = (current / durationSec) * 100;
                            
                            // Update header player
                            document.getElementById('progressInput').value = pct || 0;
                            document.getElementById('progressBar').style.width = `${pct || 0}%`;
                            document.getElementById('currentTime').innerText = formatTime(current);
                            document.getElementById('duration').innerText = formatTimeRemaining(current, durationSec);
                            
                            // Update fullscreen player
                            document.getElementById('fsProgressFill').style.width = `${pct || 0}%`;
                            document.getElementById('fsCurrentTime').innerText = formatTime(current);
                            document.getElementById('fsDuration').innerText = formatTime(durationSec);
                        } else {
                            // Duration still loading, show loading state but update position
                            document.getElementById('currentTime').innerText = formatTime(current);
                            document.getElementById('fsCurrentTime').innerText = formatTime(current);
                            // Keep showing "--:--" until duration is available
                            if(document.getElementById('duration').innerText === '--:--') {
                                // Still waiting for duration
                            }
                        }
                    });
                });
            } catch(e) {
                console.warn('SC update error:', e);
            }
        }

        function togglePlay() { 
            const s = songs.find(x => x.id === currentSongId);
            if(!s && filteredSongs.length > 0) playSong(filteredSongs[0].id);
            else if(s) {
                if(s.src.includes('soundcloud')) scWidget.toggle();
                else isPlaying ? audio.pause() : audio.play(); 
            }
        }
        
        function updatePlayBtn() { 
            // LOGIC: If playing (sound detected), show PAUSE button. If paused/stopped, show PLAY button.
            // SVG for PAUSE
            const pauseIcon = `<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>`;
            // SVG for PLAY
            const playIcon = `<polygon points="5 3 19 12 5 21 5 3"></polygon>`;
            
            const currentIcon = isPlaying ? pauseIcon : playIcon;
            
            // Update Header Player
            document.getElementById('playPauseIcon').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${currentIcon}</svg>`; 
            
            // Update Full Screen Player
            updateFullScreenPlayBtn();
        }
        
        function updateProgress() {
            try {
                const s = songs.find(x => x.id === currentSongId);

                // If this is a SoundCloud track, use the SC widget to get position/duration
                if (s && typeof s.src === 'string' && s.src.includes('soundcloud')) {
                    console.debug('[DEBUG] SC updateProgress - currentSongId=', currentSongId, 'src=', s.src, 'scWidget=', !!window.scWidget);
                    if (window.scWidget && scWidget.getPosition && scWidget.getDuration) {
                        scWidget.getPosition(pos => {
                            console.debug('[DEBUG] SC getPosition -> pos (ms)=', pos);
                            scWidget.getDuration(dur => {
                                console.debug('[DEBUG] SC getDuration -> dur (ms)=', dur);
                                const current = (pos || 0) / 1000;
                                const durationSec = (dur || 0) / 1000;
                                const pct = durationSec ? (current / durationSec) * 100 : 0;
                                console.debug('[DEBUG] SC computed -> current=', current, 'duration=', durationSec, 'pct=', pct);
                                
                                // Update header player
                                document.getElementById('progressInput').value = pct || 0;
                                document.getElementById('progressBar').style.width = `${pct || 0}%`;
                                document.getElementById('currentTime').innerText = formatTime(current);
                                document.getElementById('duration').innerText = formatTimeRemaining(current, durationSec);
                                
                                // Update fullscreen player
                                document.getElementById('fsProgressFill').style.width = `${pct || 0}%`;
                                document.getElementById('fsCurrentTime').innerText = formatTime(current);
                                document.getElementById('fsDuration').innerText = formatTime(durationSec);
                            });
                        });
                    } else {
                        console.warn('[WARN] scWidget not ready or missing getPosition/getDuration');
                    }
                    return;
                }

                // Native audio element handling
                if (!audio.duration || isNaN(audio.duration)) return;
                const pct = (audio.currentTime / audio.duration) * 100;
                
                // Update header player
                document.getElementById('progressInput').value = pct;
                document.getElementById('progressBar').style.width = `${pct}%`;
                document.getElementById('currentTime').innerText = formatTime(audio.currentTime);
                
                // Update fullscreen player
                document.getElementById('fsProgressFill').style.width = `${pct}%`;
                document.getElementById('fsCurrentTime').innerText = formatTime(audio.currentTime);
                document.getElementById('fsDuration').innerText = formatTime(audio.duration);
                document.getElementById('duration').innerText = formatTimeRemaining(audio.currentTime, audio.duration);
            } catch (err) {
                console.error('updateProgress error', err);
            }
        }
        
        function seek(v) { 
            const s = songs.find(x => x.id === currentSongId);
            if(s && s.src.includes('soundcloud')) {
                // Seek SC
                if(audioDuration) scWidget.seekTo((v/100) * audioDuration * 1000);
            } else {
                if(audio.duration) audio.currentTime = (v/100) * audio.duration; 
            }
        }
        
        function setVolume(v) { audio.volume = v; if(scWidget) scWidget.setVolume(v*100); document.getElementById('volumeBar').style.width = `${v*100}%`; }
        
        function nextSong() { 
            if(!filteredSongs.length) return; 
            let idx = -1; 
            if (isShuffle) { 
                do { idx = Math.floor(Math.random() * filteredSongs.length); } while (filteredSongs.length > 1 && filteredSongs[idx].id === currentSongId); 
            } else { 
                idx = filteredSongs.findIndex(s=>s.id===currentSongId)+1; 
                if(idx >= filteredSongs.length) {
                    if(repeatMode === 1) idx = 0; // Loop All
                    else return; // Stop
                } 
            } 
            playSong(filteredSongs[idx].id); 
        }
        
        function prevSong() { 
            let idx = filteredSongs.findIndex(s=>s.id===currentSongId)-1; 
            if(idx<0) idx = filteredSongs.length-1; 
            playSong(filteredSongs[idx].id); 
        }
        
        function toggleShuffle() { 
            isShuffle = !isShuffle; 
            document.getElementById('btnShuffle').classList.toggle('text-red-500', isShuffle);
            document.getElementById('fsShuffleBtn').classList.toggle('active', isShuffle);
        }
        
        function cycleRepeat() {
            repeatMode = (repeatMode + 1) % 3; // 0: Off, 1: All, 2: One
            const btn = document.getElementById('btnRepeat');
            const fsBtn = document.getElementById('fsRepeatBtn');
            const fsText = document.getElementById('fsRepeatText');
            
            // Set button color based on mode
            btn.classList.toggle('text-red-500', repeatMode > 0);
            fsBtn.classList.toggle('active', repeatMode > 0);
            
            // Enable native audio loop for Repeat One mode
            if(audio) audio.loop = (repeatMode === 2);
            
            // For SoundCloud tracks, disable native loop as SC widget handles it
            const s = songs.find(x => x.id === currentSongId);
            if(s && s.src.includes('soundcloud') && audio) {
                audio.loop = false;
            }

            // Update button icon and display based on mode
            if(repeatMode === 2) {
                // Repeat One
                btn.innerHTML = '<div class="relative"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg><span class="absolute -top-1 -right-2 text-[8px] font-bold">1</span></div>';
                btn.title = 'Repeat: One Track';
                fsText.textContent = 'Répéter: 1';
            } 
            else if(repeatMode === 1) {
                // Repeat All
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>';
                btn.title = 'Repeat: All Tracks';
                fsText.textContent = 'Répéter: Tout';
            }
            else {
                // No Repeat
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>';
                btn.title = 'Repeat: Off';
                fsText.textContent = 'Répéter';
            }
        }
        
        function toggleFullScreen() { 
            const fs = document.getElementById('fullScreenPlayer');
            fs.classList.toggle('active'); 
            if(fs.classList.contains('active')) {
                updateFullScreenUI();
                lucide.createIcons();
                // Activer le plein écran natif du navigateur
                if (fs.requestFullscreen) {
                    fs.requestFullscreen();
                } else if (fs.webkitRequestFullscreen) {
                    fs.webkitRequestFullscreen();
                } else if (fs.msRequestFullscreen) {
                    fs.msRequestFullscreen();
                }
            } else {
                // Quitter le plein écran natif
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
        
        function updateFullScreenUI() {
            const s = songs.find(x => x.id === currentSongId);
            if (!s) return;
            
            // Update cover and background
            const cover = s.cover || 'https://via.placeholder.com/500';
            document.getElementById('fsCover').src = cover;
            document.getElementById('fsBgBlur').style.backgroundImage = `url(${cover})`;
            
            // Update text info
            document.getElementById('fsTitle').textContent = s.title || 'Titre';
            document.getElementById('fsArtist').textContent = s.artist || 'Artiste';
            document.getElementById('fsAlbum').textContent = s.album || '';
            
            // Update shuffle and repeat button states
            document.getElementById('fsShuffleBtn').classList.toggle('active', isShuffle);
            document.getElementById('fsRepeatBtn').classList.toggle('active', repeatMode > 0);
            
            // Update repeat text
            const fsRepeatText = document.getElementById('fsRepeatText');
            if (repeatMode === 2) {
                fsRepeatText.textContent = 'Répéter: 1';
            } else if (repeatMode === 1) {
                fsRepeatText.textContent = 'Répéter: Tout';
            } else {
                fsRepeatText.textContent = 'Répéter';
            }
            
            // Update play/pause icon
            updateFullScreenPlayBtn();
        }
        
        function updateFullScreenPlayBtn() {
            const pauseIcon = `<i data-lucide="pause" class="w-9 h-9 fill-current"></i>`;
            const playIcon = `<i data-lucide="play" class="w-9 h-9 fill-current"></i>`;
            const icon = isPlaying ? pauseIcon : playIcon;
            document.getElementById('fsPlayPauseIcon').innerHTML = icon;
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function seekFullscreen(event) {
            const bar = event.currentTarget;
            const rect = bar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            
            const s = songs.find(x => x.id === currentSongId);
            if (s && s.src.includes('soundcloud')) {
                scWidget.getDuration(duration => {
                    scWidget.seekTo(duration * percent);
                });
            } else if (audio.duration) {
                audio.currentTime = audio.duration * percent;
            }
        }
        
        function formatTime(s) { if(!s || isNaN(s)) return "0:00"; const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }
        
        function formatTimeRemaining(current, duration) { 
            // Invalid or still loading - show loading state
            if(isNaN(duration) || duration <= 0 || isNaN(current)) return "--:--";
            // Valid times
            const remaining = Math.max(0, duration - current);
            const m = Math.floor(remaining / 60);
            const sc = Math.floor(remaining % 60);
            return `-${m}:${sc < 10 ? '0' : ''}${sc}`;
        }

        function playSong(id) {
            const s = songs.find(x => x.id === id); if(!s) return;
            currentSongId = id;
            ['player','fs'].forEach(p => { 
                document.getElementById(`${p}Title`).innerText = s.title; 
                document.getElementById(`${p}Artist`).innerText = s.artist; 
                // 3. FALLBACK COVER FOR PLAYER
                const cover = s.cover || DEFAULT_COVER;
                if(document.getElementById(`${p}Art`)) document.getElementById(`${p}Art`).src = cover; 
                else document.getElementById('fsCover').src = cover; 
            });
            
            // Update player like button
            updatePlayerLikeButton();

            // STOP PREVIOUS
            audio.pause();
            if(scWidget) scWidget.pause();
            if(scUpdateInterval) clearInterval(scUpdateInterval); // Clear SC update interval

            if (s.src.includes('soundcloud')) {
                // Reset timecode for SoundCloud (show loading state)
                document.getElementById('currentTime').innerText = '0:00';
                document.getElementById('duration').innerText = '--:--';
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('progressInput').value = 0;
                audioDuration = 0;
                
                scWidget.load(s.src, { auto_play: true, show_artwork: false });
                isPlaying = true;
                updatePlayBtn();
            } else {
                audio.src = s.src; 
                audio.play().catch(()=>{}); 
                audio.loop = (repeatMode === 2); 
            }
            isPlaying = true; 
            updatePlayBtn(); 
            
            if ('mediaSession' in navigator) { 
                navigator.mediaSession.metadata = new MediaMetadata({ title: s.title, artist: s.artist, album: s.album || 'Single', artwork: [ { src: s.cover || DEFAULT_COVER, sizes: '512x512', type: 'image/jpeg' } ] }); 
                navigator.mediaSession.setActionHandler('play', () => togglePlay()); 
                navigator.mediaSession.setActionHandler('pause', () => togglePlay()); 
                navigator.mediaSession.setActionHandler('previoustrack', () => prevSong()); 
                navigator.mediaSession.setActionHandler('nexttrack', () => nextSong()); 
            }
        }

        // Helper: Check if a song has a specific artist (handles multiple artists separated by comma)
        function songHasArtist(song, artistName) {
            if(!song.artist) return false;
            if(song.artist === artistName) return true; // Exact match
            // Check if artist is in comma-separated list
            if(song.artist.includes(',')) {
                const artists = song.artist.split(',').map(a => a.trim());
                return artists.includes(artistName);
            }
            return false;
        }

        // --- TRANSLATION SYSTEM ---
        const translations = {
            fr: {
                nav: {
                    listen: "Écouter",
                    liked: "Mes titres",
                    explore: "Explorer",
                    community: "Communauté",
                    settings: "Paramètres",
                    admin: "Gestion"
                },
                explore: {
                    subtitle: "Découvrez des genres, albums et artistes",
                    genres: "Genres Musicaux",
                    albums: "Tous les Albums",
                    artists: "Artistes à Découvrir"
                },
                listen: {
                    hero: "Mix Global",
                    playRandom: "Lecture Aléatoire",
                    songs: "Titres",
                    subtitle: "Découvrez toute la musique"
                },
                liked: {
                    title: "Titres Likés",
                    subtitle: "Vos coups de cœur musicaux"
                },
                community: {
                    subtitle: "Découvrez l'actualité et les membres actifs"
                },
                notifications: {
                    title: "Notifications",
                    clearAll: "Effacer tout",
                    empty: "Aucune notification"
                },
                settings: {
                    title: "Paramètres",
                    subtitle: "Personnalisez votre expérience",
                    account: {
                        title: "Compte",
                        username: "Nom d'utilisateur",
                        change: "Modifier",
                        usernameHint: "3 caractères minimum"
                    },
                    language: {
                        title: "Langue"
                    },
                    theme: {
                        title: "Thème",
                        dark: "Sombre",
                        darkDesc: "Par défaut",
                        light: "Clair",
                        lightDesc: "Lumineux",
                        pink: "Rose",
                        pinkDesc: "Doux",
                        lightpink: "Rose Clair",
                        lightpinkDesc: "Pastel"
                    }
                },
                player: {
                    play: "Lecture",
                    pause: "Pause",
                    next: "Suivant",
                    previous: "Précédent",
                    shuffle: "Aléatoire",
                    repeat: "Répéter",
                    like: "J'aime",
                    liked: "Liké",
                    volume: "Volume"
                },
                common: {
                    search: "Rechercher...",
                    loading: "Chargement...",
                    error: "Erreur",
                    success: "Succès",
                    cancel: "Annuler",
                    save: "Enregistrer",
                    delete: "Supprimer",
                    edit: "Modifier",
                    close: "Fermer",
                    myPlaylists: "Mes Playlists",
                    playlistsAndSongs: "Playlists / Titres",
                    searchPlaceholder: "Rechercher des titres, artistes, albums...",
                    connecting: "Connexion au serveur...",
                    artist: "Artiste"
                },
                community: {
                    subtitle: "Découvrez l'actualité et les membres actifs",
                    posts: "Posts",
                    members: "Membres",
                    online: "En ligne"
                },
                admin: {
                    artists: {
                        title: "Artistes",
                        subtitle: "Gérer les profils d'artistes"
                    },
                    stats: {
                        totalSongs: "Titres totaux",
                        activeArtists: "Artistes actifs"
                    }
                }
            },
            en: {
                nav: {
                    listen: "Listen",
                    liked: "My Songs",
                    explore: "Explore",
                    community: "Community",
                    settings: "Settings",
                    admin: "Management"
                },
                explore: {
                    subtitle: "Discover genres, albums and artists",
                    genres: "Music Genres",
                    albums: "All Albums",
                    artists: "Artists to Discover"
                },
                listen: {
                    hero: "Global Mix",
                    playRandom: "Random Play",
                    songs: "Songs",
                    subtitle: "Discover all the music"
                },
                liked: {
                    title: "Liked Songs",
                    subtitle: "Your favorite tracks"
                },
                community: {
                    subtitle: "Discover news and active members"
                },
                notifications: {
                    title: "Notifications",
                    clearAll: "Clear all",
                    empty: "No notifications"
                },
                settings: {
                    title: "Settings",
                    subtitle: "Customize your experience",
                    account: {
                        title: "Account",
                        username: "Username",
                        change: "Change",
                        usernameHint: "Minimum 3 characters"
                    },
                    language: {
                        title: "Language"
                    },
                    theme: {
                        title: "Theme",
                        dark: "Dark",
                        darkDesc: "Default",
                        light: "Light",
                        lightDesc: "Bright",
                        pink: "Pink",
                        pinkDesc: "Soft",
                        lightpink: "Light Pink",
                        lightpinkDesc: "Pastel"
                    }
                },
                player: {
                    play: "Play",
                    pause: "Pause",
                    next: "Next",
                    previous: "Previous",
                    shuffle: "Shuffle",
                    repeat: "Repeat",
                    like: "Like",
                    liked: "Liked",
                    volume: "Volume"
                },
                common: {
                    search: "Search...",
                    loading: "Loading...",
                    error: "Error",
                    success: "Success",
                    cancel: "Cancel",
                    save: "Save",
                    delete: "Delete",
                    edit: "Edit",
                    close: "Close",
                    myPlaylists: "My Playlists",
                    playlistsAndSongs: "Playlists / Songs",
                    searchPlaceholder: "Search for songs, artists, albums...",
                    connecting: "Connecting to server...",
                    artist: "Artist"
                },
                community: {
                    subtitle: "Discover news and active members",
                    posts: "Posts",
                    members: "Members",
                    online: "Online"
                },
                admin: {
                    artists: {
                        title: "Artists",
                        subtitle: "Manage artist profiles"
                    },
                    stats: {
                        totalSongs: "Total Songs",
                        activeArtists: "Active Artists"
                    }
                }
            },
            es: {
                nav: {
                    listen: "Escuchar",
                    liked: "Mis canciones",
                    explore: "Explorar",
                    community: "Comunidad",
                    settings: "Configuración",
                    admin: "Gestión"
                },
                explore: {
                    subtitle: "Descubre géneros, álbumes y artistas",
                    genres: "Géneros Musicales",
                    albums: "Todos los Álbumes",
                    artists: "Artistas para Descubrir"
                },
                listen: {
                    hero: "Mix Global",
                    playRandom: "Reproducción Aleatoria",
                    songs: "Canciones",
                    subtitle: "Descubre toda la música"
                },
                liked: {
                    title: "Canciones Favoritas",
                    subtitle: "Tus favoritos musicales"
                },
                community: {
                    subtitle: "Descubre noticias y miembros activos"
                },
                notifications: {
                    title: "Notificaciones",
                    clearAll: "Borrar todo",
                    empty: "Sin notificaciones"
                },
                settings: {
                    title: "Configuración",
                    subtitle: "Personaliza tu experiencia",
                    account: {
                        title: "Cuenta",
                        username: "Nombre de usuario",
                        change: "Cambiar",
                        usernameHint: "Mínimo 3 caracteres"
                    },
                    language: {
                        title: "Idioma"
                    },
                    theme: {
                        title: "Tema",
                        dark: "Oscuro",
                        darkDesc: "Por defecto",
                        light: "Claro",
                        lightDesc: "Brillante",
                        pink: "Rosa",
                        pinkDesc: "Suave",
                        lightpink: "Rosa Claro",
                        lightpinkDesc: "Pastel"
                    }
                },
                player: {
                    play: "Reproducir",
                    pause: "Pausa",
                    next: "Siguiente",
                    previous: "Anterior",
                    shuffle: "Aleatorio",
                    repeat: "Repetir",
                    like: "Me gusta",
                    liked: "Me gusta",
                    volume: "Volumen"
                },
                common: {
                    search: "Buscar...",
                    loading: "Cargando...",
                    error: "Error",
                    success: "Éxito",
                    cancel: "Cancelar",
                    save: "Guardar",
                    delete: "Eliminar",
                    edit: "Editar",
                    close: "Cerrar",
                    myPlaylists: "Mis Listas",
                    playlistsAndSongs: "Listas / Canciones",
                    searchPlaceholder: "Buscar canciones, artistas, álbumes...",
                    connecting: "Conectando al servidor...",
                    artist: "Artista"
                },
                community: {
                    subtitle: "Descubre noticias y miembros activos",
                    posts: "Publicaciones",
                    members: "Miembros",
                    online: "En línea"
                },
                admin: {
                    artists: {
                        title: "Artistas",
                        subtitle: "Gestionar perfiles de artistas"
                    },
                    stats: {
                        totalSongs: "Canciones totales",
                        activeArtists: "Artistas activos"
                    }
                }
            },
            it: {
                nav: {
                    listen: "Ascolta",
                    liked: "Le mie canzoni",
                    explore: "Esplora",
                    community: "Comunità",
                    settings: "Impostazioni",
                    admin: "Gestione"
                },
                explore: {
                    subtitle: "Scopri generi, album e artisti",
                    genres: "Generi Musicali",
                    albums: "Tutti gli Album",
                    artists: "Artisti da Scoprire"
                },
                listen: {
                    hero: "Mix Globale",
                    playRandom: "Riproduzione Casuale",
                    songs: "Brani",
                    subtitle: "Scopri tutta la musica"
                },
                liked: {
                    title: "Brani Preferiti",
                    subtitle: "I tuoi preferiti musicali"
                },
                community: {
                    subtitle: "Scopri notizie e membri attivi"
                },
                notifications: {
                    title: "Notifiche",
                    clearAll: "Cancella tutto",
                    empty: "Nessuna notifica"
                },
                settings: {
                    title: "Impostazioni",
                    subtitle: "Personalizza la tua esperienza",
                    account: {
                        title: "Account",
                        username: "Nome utente",
                        change: "Modifica",
                        usernameHint: "Minimo 3 caratteri"
                    },
                    language: {
                        title: "Lingua"
                    },
                    theme: {
                        title: "Tema",
                        dark: "Scuro",
                        darkDesc: "Predefinito",
                        light: "Chiaro",
                        lightDesc: "Luminoso",
                        pink: "Rosa",
                        pinkDesc: "Morbido",
                        lightpink: "Rosa Chiaro",
                        lightpinkDesc: "Pastello"
                    }
                },
                player: {
                    play: "Riproduci",
                    pause: "Pausa",
                    next: "Successivo",
                    previous: "Precedente",
                    shuffle: "Casuale",
                    repeat: "Ripeti",
                    like: "Mi piace",
                    liked: "Piaciuto",
                    volume: "Volume"
                },
                common: {
                    search: "Cerca...",
                    loading: "Caricamento...",
                    error: "Errore",
                    success: "Successo",
                    cancel: "Annulla",
                    save: "Salva",
                    delete: "Elimina",
                    edit: "Modifica",
                    close: "Chiudi",
                    myPlaylists: "Le Mie Playlist",
                    playlistsAndSongs: "Playlist / Brani",
                    searchPlaceholder: "Cerca brani, artisti, album...",
                    connecting: "Connessione al server...",
                    artist: "Artista"
                },
                community: {
                    subtitle: "Scopri notizie e membri attivi",
                    posts: "Post",
                    members: "Membri",
                    online: "Online"
                },
                admin: {
                    artists: {
                        title: "Artisti",
                        subtitle: "Gestisci i profili degli artisti"
                    },
                    stats: {
                        totalSongs: "Brani totali",
                        activeArtists: "Artisti attivi"
                    }
                }
            },
            pt: {
                nav: {
                    listen: "Ouvir",
                    liked: "Minhas músicas",
                    explore: "Explorar",
                    community: "Comunidade",
                    settings: "Configurações",
                    admin: "Gestão"
                },
                explore: {
                    subtitle: "Descubra gêneros, álbuns e artistas",
                    genres: "Gêneros Musicais",
                    albums: "Todos os Álbuns",
                    artists: "Artistas para Descobrir"
                },
                listen: {
                    hero: "Mix Global",
                    playRandom: "Reprodução Aleatória",
                    songs: "Músicas",
                    subtitle: "Descubra toda a música"
                },
                liked: {
                    title: "Músicas Curtidas",
                    subtitle: "Seus favoritos musicais"
                },
                community: {
                    subtitle: "Descubra notícias e membros ativos"
                },
                notifications: {
                    title: "Notificações",
                    clearAll: "Limpar tudo",
                    empty: "Sem notificações"
                },
                settings: {
                    title: "Configurações",
                    subtitle: "Personalize sua experiência",
                    account: {
                        title: "Conta",
                        username: "Nome de usuário",
                        change: "Alterar",
                        usernameHint: "Mínimo 3 caracteres"
                    },
                    language: {
                        title: "Idioma"
                    },
                    theme: {
                        title: "Tema",
                        dark: "Escuro",
                        darkDesc: "Padrão",
                        light: "Claro",
                        lightDesc: "Brilhante",
                        pink: "Rosa",
                        pinkDesc: "Suave",
                        lightpink: "Rosa Claro",
                        lightpinkDesc: "Pastel"
                    }
                },
                player: {
                    play: "Reproduzir",
                    pause: "Pausar",
                    next: "Próximo",
                    previous: "Anterior",
                    shuffle: "Aleatório",
                    repeat: "Repetir",
                    like: "Curtir",
                    liked: "Curtido",
                    volume: "Volume"
                },
                common: {
                    search: "Pesquisar...",
                    loading: "Carregando...",
                    error: "Erro",
                    success: "Sucesso",
                    cancel: "Cancelar",
                    save: "Salvar",
                    delete: "Excluir",
                    edit: "Editar",
                    close: "Fechar",
                    myPlaylists: "Minhas Playlists",
                    playlistsAndSongs: "Playlists / Músicas",
                    searchPlaceholder: "Pesquisar músicas, artistas, álbuns...",
                    connecting: "Conectando ao servidor...",
                    artist: "Artista"
                },
                community: {
                    subtitle: "Descubra notícias e membros ativos",
                    posts: "Postagens",
                    members: "Membros",
                    online: "Online"
                },
                admin: {
                    artists: {
                        title: "Artistas",
                        subtitle: "Gerenciar perfis de artistas"
                    },
                    stats: {
                        totalSongs: "Músicas totais",
                        activeArtists: "Artistas ativos"
                    }
                }
            },
            de: {
                nav: {
                    listen: "Hören",
                    liked: "Meine Lieder",
                    explore: "Erkunden",
                    community: "Gemeinschaft",
                    settings: "Einstellungen",
                    admin: "Verwaltung"
                },
                explore: {
                    subtitle: "Entdecken Sie Genres, Alben und Künstler",
                    genres: "Musik-Genres",
                    albums: "Alle Alben",
                    artists: "Künstler zum Entdecken"
                },
                listen: {
                    hero: "Globaler Mix",
                    playRandom: "Zufällige Wiedergabe",
                    songs: "Lieder",
                    subtitle: "Entdecke alle Musik"
                },
                liked: {
                    title: "Gelikte Lieder",
                    subtitle: "Ihre musikalischen Favoriten"
                },
                community: {
                    subtitle: "Entdecken Sie Neuigkeiten und aktive Mitglieder"
                },
                notifications: {
                    title: "Benachrichtigungen",
                    clearAll: "Alle löschen",
                    empty: "Keine Benachrichtigungen"
                },
                settings: {
                    title: "Einstellungen",
                    subtitle: "Passen Sie Ihr Erlebnis an",
                    account: {
                        title: "Konto",
                        username: "Benutzername",
                        change: "Ändern",
                        usernameHint: "Mindestens 3 Zeichen"
                    },
                    language: {
                        title: "Sprache"
                    },
                    theme: {
                        title: "Thema",
                        dark: "Dunkel",
                        darkDesc: "Standard",
                        light: "Hell",
                        lightDesc: "Leuchtend",
                        pink: "Rosa",
                        pinkDesc: "Sanft",
                        lightpink: "Hellrosa",
                        lightpinkDesc: "Pastell"
                    }
                },
                player: {
                    play: "Abspielen",
                    pause: "Pause",
                    next: "Weiter",
                    previous: "Zurück",
                    shuffle: "Zufällig",
                    repeat: "Wiederholen",
                    like: "Gefällt mir",
                    liked: "Gefällt mir",
                    volume: "Lautstärke"
                },
                common: {
                    search: "Suchen...",
                    loading: "Laden...",
                    error: "Fehler",
                    success: "Erfolg",
                    cancel: "Abbrechen",
                    save: "Speichern",
                    delete: "Löschen",
                    edit: "Bearbeiten",
                    close: "Schließen",
                    myPlaylists: "Meine Playlists",
                    playlistsAndSongs: "Playlists / Lieder",
                    searchPlaceholder: "Lieder, Künstler, Alben suchen...",
                    connecting: "Verbindung zum Server...",
                    artist: "Künstler"
                },
                community: {
                    subtitle: "Entdecken Sie Neuigkeiten und aktive Mitglieder",
                    posts: "Beiträge",
                    members: "Mitglieder",
                    online: "Online"
                },
                admin: {
                    artists: {
                        title: "Künstler",
                        subtitle: "Künstlerprofile verwalten"
                    },
                    stats: {
                        totalSongs: "Lieder insgesamt",
                        activeArtists: "Aktive Künstler"
                    }
                }
            },
            zh: {
                nav: {
                    listen: "听歌",
                    liked: "我的歌曲",
                    explore: "探索",
                    community: "社区",
                    settings: "设置",
                    admin: "管理"
                },
                explore: {
                    subtitle: "发现风格、专辑和艺术家",
                    genres: "音乐风格",
                    albums: "所有专辑",
                    artists: "发现艺术家"
                },
                listen: {
                    hero: "全球混音",
                    playRandom: "随机播放",
                    songs: "歌曲",
                    subtitle: "发现所有音乐"
                },
                liked: {
                    title: "喜欢的歌曲",
                    subtitle: "您的音乐收藏"
                },
                community: {
                    subtitle: "发现动态和活跃成员"
                },
                notifications: {
                    title: "通知",
                    clearAll: "清除所有",
                    empty: "没有通知"
                },
                settings: {
                    title: "设置",
                    subtitle: "个性化您的体验",
                    account: {
                        title: "账户",
                        username: "用户名",
                        change: "更改",
                        usernameHint: "至少3个字符"
                    },
                    language: {
                        title: "语言"
                    },
                    theme: {
                        title: "主题",
                        dark: "深色",
                        darkDesc: "默认",
                        light: "浅色",
                        lightDesc: "明亮",
                        pink: "粉色",
                        pinkDesc: "柔和",
                        lightpink: "淡粉色",
                        lightpinkDesc: "色彩柔和"
                    }
                },
                player: {
                    play: "播放",
                    pause: "暂停",
                    next: "下一首",
                    previous: "上一首",
                    shuffle: "随机",
                    repeat: "重复",
                    like: "喜欢",
                    liked: "已喜欢",
                    volume: "音量"
                },
                common: {
                    search: "搜索...",
                    loading: "加载中...",
                    error: "错误",
                    success: "成功",
                    cancel: "取消",
                    save: "保存",
                    delete: "删除",
                    edit: "编辑",
                    close: "关闭",
                    myPlaylists: "我的播放列表",
                    playlistsAndSongs: "播放列表 / 歌曲",
                    searchPlaceholder: "搜索歌曲、艺人、专辑...",
                    connecting: "连接服务器...",
                    artist: "艺人"
                },
                community: {
                    subtitle: "发现动态和活跃成员",
                    posts: "帖子",
                    members: "成员",
                    online: "在线"
                },
                admin: {
                    artists: {
                        title: "艺人",
                        subtitle: "管理艺人资料"
                    },
                    stats: {
                        totalSongs: "总歌曲数",
                        activeArtists: "活跃艺人"
                    }
                }
            },
            ja: {
                nav: {
                    listen: "聴く",
                    liked: "マイソング",
                    explore: "探索",
                    community: "コミュニティ",
                    settings: "設定",
                    admin: "管理"
                },
                settings: {
                    title: "設定",
                    subtitle: "体験をカスタマイズ",
                    account: {
                        title: "アカウント",
                        username: "ユーザー名",
                        change: "変更",
                        usernameHint: "最低3文字"
                    },
                    language: {
                        title: "言語"
                    },
                    theme: {
                        title: "テーマ",
                        dark: "ダーク",
                        darkDesc: "デフォルト",
                        light: "ライト",
                        lightDesc: "明るい",
                        pink: "ピンク",
                        pinkDesc: "柔らかい",
                        lightpink: "ライトピンク",
                        lightpinkDesc: "パステル"
                    }
                },
                player: {
                    play: "再生",
                    pause: "一時停止",
                    next: "次へ",
                    previous: "前へ",
                    shuffle: "シャッフル",
                    repeat: "リピート",
                    like: "いいね",
                    liked: "いいね済み",
                    volume: "音量"
                },
                common: {
                    search: "検索...",
                    loading: "読み込み中...",
                    error: "エラー",
                    success: "成功",
                    cancel: "キャンセル",
                    save: "保存",
                    delete: "削除",
                    edit: "編集",
                    close: "閉じる",
                    myPlaylists: "マイプレイリスト",
                    playlistsAndSongs: "プレイリスト / 曲",
                    searchPlaceholder: "曲、アーティスト、アルバムを検索...",
                    connecting: "サーバーに接続中...",
                    artist: "アーティスト"
                },
                community: {
                    subtitle: "ニュースとアクティブメンバーを発見",
                    posts: "投稿",
                    members: "メンバー",
                    online: "オンライン"
                },
                admin: {
                    artists: {
                        title: "アーティスト",
                        subtitle: "アーティストプロフィールを管理"
                    },
                    stats: {
                        totalSongs: "総曲数",
                        activeArtists: "アクティブアーティスト"
                    }
                }
            },
            ko: {
                nav: {
                    listen: "듣기",
                    liked: "내 노래",
                    explore: "탐색",
                    community: "커뮤니티",
                    settings: "설정",
                    admin: "관리"
                },
                explore: {
                    subtitle: "장르, 앨범, 아티스트 발견",
                    genres: "음악 장르",
                    albums: "모든 앨범",
                    artists: "발견할 아티스트"
                },
                listen: {
                    hero: "글로벌 믹스",
                    playRandom: "무작위 재생",
                    songs: "노래",
                    subtitle: "모든 음악 발견"
                },
                liked: {
                    title: "좋아요 한 노래",
                    subtitle: "좋아하는 음악"
                },
                community: {
                    subtitle: "뉴스와 활동 멤버 발견"
                },
                notifications: {
                    title: "알림",
                    clearAll: "모두 삭제",
                    empty: "알림 없음"
                },
                settings: {
                    title: "설정",
                    subtitle: "경험을 맞춤화하세요",
                    account: {
                        title: "계정",
                        username: "사용자 이름",
                        change: "변경",
                        usernameHint: "최소 3자"
                    },
                    language: {
                        title: "언어"
                    },
                    theme: {
                        title: "테마",
                        dark: "다크",
                        darkDesc: "기본",
                        light: "라이트",
                        lightDesc: "밝은",
                        pink: "핑크",
                        pinkDesc: "부드러운",
                        lightpink: "라이트 핑크",
                        lightpinkDesc: "파스텔"
                    }
                },
                player: {
                    play: "재생",
                    pause: "일시정지",
                    next: "다음",
                    previous: "이전",
                    shuffle: "셔플",
                    repeat: "반복",
                    like: "좋아요",
                    liked: "좋아요 완료",
                    volume: "볼륨"
                },
                common: {
                    search: "검색...",
                    loading: "로딩 중...",
                    error: "오류",
                    success: "성공",
                    cancel: "취소",
                    save: "저장",
                    delete: "삭제",
                    edit: "편집",
                    close: "닫기",
                    myPlaylists: "내 플레이리스트",
                    playlistsAndSongs: "플레이리스트 / 노래",
                    searchPlaceholder: "노래, 아티스트, 앨범 검색...",
                    connecting: "서버에 연결 중...",
                    artist: "아티스트"
                },
                community: {
                    subtitle: "소식과 활동 회원 발견",
                    posts: "게시물",
                    members: "회원",
                    online: "온라인"
                },
                admin: {
                    artists: {
                        title: "아티스트",
                        subtitle: "아티스트 프로필 관리"
                    },
                    stats: {
                        totalSongs: "총 노래 수",
                        activeArtists: "활동 아티스트"
                    }
                }
            }
        };

        function t(key) {
            const keys = key.split('.');
            let value = translations[currentLang];
            for (const k of keys) {
                value = value?.[k];
            }
            return value || key;
        }

        function updateTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            
            // Update placeholders
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.placeholder = t('common.searchPlaceholder');
            
            // Update data-i18n-placeholder elements
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
            
            const newUsernameInput = document.getElementById('newUsernameInput');
            if (newUsernameInput) newUsernameInput.placeholder = currentLang === 'fr' ? 'Nouveau pseudo' : 
                currentLang === 'en' ? 'New username' : 
                currentLang === 'es' ? 'Nuevo nombre' :
                currentLang === 'it' ? 'Nuovo nome' :
                currentLang === 'pt' ? 'Novo nome' :
                currentLang === 'de' ? 'Neuer Name' :
                currentLang === 'zh' ? '新用户名' :
                currentLang === 'ja' ? '新しいユーザー名' : '새 사용자 이름';
            
            // Update active language button
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.lang-btn[data-lang="${currentLang}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            lucide.createIcons();
        }

        function changeLang(lang) {
            currentLang = lang;
            localStorage.setItem('appLang', lang);
            updateTranslations();
            showToast(currentLang === 'fr' ? '🌍 Langue modifiée' : 
                     currentLang === 'en' ? '🌍 Language changed' :
                     currentLang === 'es' ? '🌍 Idioma cambiado' :
                     currentLang === 'it' ? '🌍 Lingua modificata' :
                     currentLang === 'pt' ? '🌍 Idioma alterado' :
                     currentLang === 'de' ? '🌍 Sprache geändert' :
                     currentLang === 'zh' ? '🌍 语言已更改' :
                     currentLang === 'ja' ? '🌍 言語が変更されました' : '🌍 언어가 변경되었습니다');
        }

        function changeTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('appTheme', theme);
            document.body.setAttribute('data-theme', theme);
            
            // Update active theme button
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.theme-btn[data-theme="${theme}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Show notification
            const messages = {
                dark: {
                    fr: '🌙 Thème sombre activé',
                    en: '🌙 Dark theme enabled',
                    es: '🌙 Tema oscuro activado',
                    it: '🌙 Tema scuro attivato',
                    pt: '🌙 Tema escuro ativado',
                    de: '🌙 Dunkles Thema aktiviert',
                    zh: '🌙 深色主题已启用',
                    ja: '🌙 ダークテーマ有効',
                    ko: '🌙 다크 테마 활성화'
                },
                light: {
                    fr: '☀️ Thème clair activé',
                    en: '☀️ Light theme enabled',
                    es: '☀️ Tema claro activado',
                    it: '☀️ Tema chiaro attivato',
                    pt: '☀️ Tema claro ativado',
                    de: '☀️ Helles Thema aktiviert',
                    zh: '☀️ 浅色主题已启用',
                    ja: '☀️ ライトテーマ有効',
                    ko: '☀️ 라이트 테마 활성화'
                },
                pink: {
                    fr: '🌸 Thème rose activé',
                    en: '🌸 Pink theme enabled',
                    es: '🌸 Tema rosa activado',
                    it: '🌸 Tema rosa attivato',
                    pt: '🌸 Tema rosa ativado',
                    de: '🌸 Rosa Thema aktiviert',
                    zh: '🌸 粉色主题已启用',
                    ja: '🌸 ピンクテーマ有効',
                    ko: '🌸 핑크 테마 활성화'
                },
                lightpink: {
                    fr: '🌺 Thème rose clair activé',
                    en: '🌺 Light pink theme enabled',
                    es: '🌺 Tema rosa claro activado',
                    it: '🌺 Tema rosa chiaro attivato',
                    pt: '🌺 Tema rosa claro ativado',
                    de: '🌺 Hellrosa Thema aktiviert',
                    zh: '🌺 淡粉色主题已启用',
                    ja: '🌺 ライトピンクテーマ有効',
                    ko: '🌺 라이트 핑크 테마 활성화'
                }
            };
            
            showToast(messages[theme][currentLang] || messages[theme]['fr']);
            lucide.createIcons();
        }

        async function changeUsername() {
            if (!currentUser) {
                showToast(t('common.error'));
                return;
            }
            
            const newUsername = document.getElementById('newUsernameInput').value.trim();
            if (!newUsername || newUsername.length < 3) {
                showToast(currentLang === 'fr' ? '⚠️ Minimum 3 caractères' :
                         currentLang === 'en' ? '⚠️ Minimum 3 characters' :
                         currentLang === 'es' ? '⚠️ Mínimo 3 caracteres' :
                         currentLang === 'it' ? '⚠️ Minimo 3 caratteri' :
                         currentLang === 'pt' ? '⚠️ Mínimo 3 caracteres' :
                         currentLang === 'de' ? '⚠️ Mindestens 3 Zeichen' :
                         currentLang === 'zh' ? '⚠️ 至少3个字符' :
                         currentLang === 'ja' ? '⚠️ 最低3文字' : '⚠️ 최소 3자');
                return;
            }
            
            // Check if username already exists
            const exists = users.some(u => u.username.toLowerCase() === newUsername.toLowerCase() && u.username !== currentUser.username);
            if (exists) {
                showToast(currentLang === 'fr' ? '⚠️ Ce pseudo existe déjà' :
                         currentLang === 'en' ? '⚠️ Username already exists' :
                         currentLang === 'es' ? '⚠️ Este nombre ya existe' :
                         currentLang === 'it' ? '⚠️ Nome già esistente' :
                         currentLang === 'pt' ? '⚠️ Nome já existe' :
                         currentLang === 'de' ? '⚠️ Name bereits vergeben' :
                         currentLang === 'zh' ? '⚠️ 用户名已存在' :
                         currentLang === 'ja' ? '⚠️ ユーザー名は既に存在します' : '⚠️ 사용자 이름이 이미 존재합니다');
                return;
            }
            
            const oldUsername = currentUser.username;
            
            try {
                const response = await fetch(`${ACTIVE_SERVER}/users/${oldUsername}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ newUsername })
                });
                
                if (response.ok) {
                    // Update local currentUser object
                    currentUser.username = newUsername;
                    localStorage.setItem('musicAppUser', JSON.stringify(currentUser));
                    
                    // Clear input
                    document.getElementById('newUsernameInput').value = '';
                    
                    // Show success message
                    showToast(currentLang === 'fr' ? '✅ Pseudo modifié !' :
                             currentLang === 'en' ? '✅ Username changed!' :
                             currentLang === 'es' ? '✅ ¡Nombre cambiado!' :
                             currentLang === 'it' ? '✅ Nome modificato!' :
                             currentLang === 'pt' ? '✅ Nome alterado!' :
                             currentLang === 'de' ? '✅ Name geändert!' :
                             currentLang === 'zh' ? '✅ 用户名已更改！' :
                             currentLang === 'ja' ? '✅ ユーザー名が変更されました！' : '✅ 사용자 이름이 변경되었습니다!');
                    
                    // Reload all data from server
                    await smartConnect();
                    
                    // Update UI with new username
                    updateUserUI();
                    
                    // If viewing own profile, refresh it
                    if (viewingProfileType === 'user' && viewingProfileId === oldUsername) {
                        openProfile(newUsername);
                    }
                } else {
                    showToast(t('common.error'));
                }
            } catch (err) {
                console.error('Error changing username:', err);
                showToast(t('common.error'));
            }
        }

        // --- DATA FETCHING ---
        async function smartConnect() {
            try {
                // Fetch directly from localhost:3000
                const res = await fetch(`${ACTIVE_SERVER}/songs`); songs = await res.json(); filteredSongs = [...songs];
                renderSongs(filteredSongs); 
                fetchGenres(); fetchPlaylists(); fetchUsers(); fetchPosts(); fetchArtists(); fetchNotifications();
                setServerStatus('online');
            } catch(e) { 
                setServerStatus('offline'); 
                showToast("Impossible de se connecter au serveur");
            }
        }

        function toggleNotifications() { 
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('active');
            if(panel.classList.contains('active')) fetchNotifications();
        }

        async function fetchNotifications() {
            if(!currentUser) return;
            try {
                const res = await fetch(`${ACTIVE_SERVER}/notifications`);
                if(res.ok) {
                    const allData = await res.json();
                    // FILTER: Show notifs targetting ME specifically OR 'all'
                    notifications = allData.filter(n => n.targetUser === 'all' || n.targetUser === currentUser.username);
                    // SORT: Newest first (optional but good UX)
                    notifications.sort((a, b) => (b.timestamp || b.date) - (a.timestamp || a.date));
                    renderNotifications();
                }
            } catch(e) {}
        }

        function renderNotifications() {
            const list = document.getElementById('notificationList');
            const dot = document.getElementById('notifDot');
            const unread = notifications.filter(n => !n.read).length;
            
            if(unread > 0) dot.classList.add('active'); else dot.classList.remove('active');
            
            if(notifications.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center text-xs py-8">Aucune notification</p>';
                return;
            }
            
            list.innerHTML = notifications.map(n => `
                <div class="p-3 border-b border-white/10 hover:bg-white/5 flex justify-between items-start ${n.read ? 'opacity-50' : ''}">
                    <div class="text-xs text-white">
                        <span class="font-bold text-red-400">${n.sender || 'Système'}</span>: ${n.message}
                        <div class="text-[10px] text-gray-500 mt-1">${new Date(n.timestamp || n.date).toLocaleDateString()}</div>
                    </div>
                    <button onclick="deleteNotification('${n.id}')" class="text-gray-500 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function deleteNotification(id) {
            try {
                await fetch(`${ACTIVE_SERVER}/notifications/${id}`, { method: 'DELETE' });
                // Optimistic update
                notifications = notifications.filter(n => n.id !== id);
                renderNotifications();
            } catch(e) {}
        }

        async function clearNotifications() {
            if(!await customConfirm("Tout effacer ?")) return;
            try {
                for(let n of notifications) await fetch(`${ACTIVE_SERVER}/notifications/${n.id}`, { method: 'DELETE' });
                notifications = [];
                renderNotifications();
            } catch(e) {}
        }

        async function fetchPosts() { try { const r = await fetch(`${ACTIVE_SERVER}/posts`); if(r.ok) { posts = await r.json(); renderNewsFeed(); } } catch(e) {} }
        
        function renderNewsFeed() {
            const feed = document.getElementById('newsFeed'); if(!feed) return;
            const canDelete = u => currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin' || u === currentUser.username);
            const getAuthorAvatar = (authorName) => {
                const author = users.find(u => u.username === authorName);
                return author && author.avatar ? author.avatar : `https://ui-avatars.com/api/?name=${authorName}&background=random`;
            };
            const formatDateTime = (date) => {
                const d = new Date(date || Date.now());
                const now = new Date();
                const diff = now - d;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'À l\'instant';
                if (minutes < 60) return `Il y a ${minutes}min`;
                if (hours < 24) return `Il y a ${hours}h`;
                if (days < 7) return `Il y a ${days}j`;
                return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
            };
            
            // Update stats
            document.getElementById('statsCommunityPosts').textContent = posts.length;
            
            feed.innerHTML = posts.length === 0 ? '<div class="col-span-full text-center py-20"><div class="text-gray-500 text-lg mb-2">Aucune actualité pour le moment</div><div class="text-gray-600 text-sm">Revenez plus tard !</div></div>' : posts.map(post => {
                const authorAvatar = getAuthorAvatar(post.author);
                const dateTime = formatDateTime(post.date);
                
                // Vérifier si l'utilisateur a liké ce post
                const isLiked = currentUser && post.likes && post.likes.includes(currentUser.username);
                const likeCount = (post.likes && post.likes.length) || 0;
                
                return `
                    <div class="group relative bg-gradient-to-br from-white/10 to-white/[0.02] backdrop-blur-xl rounded-2xl overflow-hidden border border-white/10 hover:border-white/20 transition-all duration-300 cursor-pointer hover:shadow-2xl hover:shadow-red-500/10" onclick="openNewsDetail('${post.id}')">
                        ${canDelete(post.author) ? `<button onclick="event.stopPropagation(); deletePost('${post.id}')" class="absolute top-3 right-3 p-2 bg-black/80 backdrop-blur-xl rounded-full text-white hover:bg-red-500 z-20 opacity-0 group-hover:opacity-100 transition-all hover:scale-110" title="Supprimer"><i data-lucide="trash" class="w-3.5 h-3.5"></i></button>` : ''}
                        
                        ${post.media ? `<div class="w-full h-40 relative bg-gradient-to-br from-gray-900 to-black overflow-hidden">
                            ${post.type === 'video' ? `<video src="${post.media}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"></video>` : `<img src="${post.media}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">`}
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                        </div>` : ''}
                        
                        <div class="p-5">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="relative">
                                    <img src="${authorAvatar}" alt="${post.author}" class="w-8 h-8 rounded-full object-cover ring-2 ring-white/10">
                                    <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-[#121212] rounded-full"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <span class="text-xs font-bold text-white truncate block">${post.author}</span>
                                    <span class="text-[10px] text-gray-500">${dateTime}</span>
                                </div>
                            </div>
                            
                            <h3 class="font-bold text-white text-base mb-2 line-clamp-2 leading-tight group-hover:text-red-400 transition-colors">${post.title}</h3>
                            <p class="text-gray-400 text-sm leading-relaxed line-clamp-3">${post.content}</p>
                            
                            <div class="flex items-center gap-4 mt-4 pt-4 border-t border-white/5">
                                <button class="flex items-center gap-1.5 ${isLiked ? 'text-red-500' : 'text-gray-500'} hover:text-red-500 transition-colors text-xs" onclick="event.stopPropagation(); togglePostLike('${post.id}')">
                                    <i data-lucide="heart" class="w-3.5 h-3.5 fill-current"></i>
                                    <span>${likeCount}</span>
                                </button>
                                <button class="ml-auto flex items-center gap-1.5 text-gray-400 hover:text-purple-500 transition-colors text-xs" onclick="event.stopPropagation(); sharePost('${post.id}', '${post.title.replace(/'/g, "\\'")}')">
                                    <i data-lucide="share-2" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
            lucide.createIcons();
        }

        function openNewsDetail(postId) {
            const post = posts.find(p => p.id == postId);
            if(!post) return;
            const modal = document.getElementById('newsDetailModal');
            const content = document.getElementById('newsDetailContent');
            const authorAvatarUrl = (() => {
                const author = users.find(u => u.username === post.author);
                return author && author.avatar ? author.avatar : `https://ui-avatars.com/api/?name=${post.author}&background=random`;
            })();
            const formatDateTime = (date) => {
                const d = new Date(date || Date.now());
                const datePart = d.toLocaleDateString();
                const timePart = d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                return `${datePart} ${timePart}`;
            };
            content.innerHTML = `
                ${post.media ? (post.type === 'video' ? `<video src="${post.media}" controls class="w-full h-64 md:h-96 object-cover bg-black"></video>` : `<img src="${post.media}" class="w-full h-64 md:h-96 object-cover bg-black">`) : ''}
                <div class="p-8">
                    <div class="flex items-center gap-3 mb-6">
                        <img src="${authorAvatarUrl}" alt="${post.author}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <p class="text-white font-bold">${post.author}</p>
                            <p class="text-xs text-gray-500">${formatDateTime(post.date)}</p>
                        </div>
                    </div>
                    <h2 class="text-3xl font-bold text-white mb-4">${post.title}</h2>
                    <div class="text-gray-300 leading-relaxed whitespace-pre-wrap">${post.content}</div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function deletePost(id) {
            if(!await customConfirm("Supprimer ce post ?")) return;
            try {
                await fetch(`${ACTIVE_SERVER}/posts/${id}`, { method: 'DELETE' });
                // Refresh posts
                fetchPosts();
                showToast("Post supprimé");
            } catch(e) {
                showToast("Erreur lors de la suppression");
            }
        }
        
        async function togglePostLike(postId) {
            if (!currentUser) {
                showToast('Connectez-vous pour liker des posts');
                return;
            }
            
            try {
                const response = await fetch(`${ACTIVE_SERVER}/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser.username })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update local post data
                    const post = posts.find(p => p.id == postId);
                    if (post) {
                        if (!post.likes) post.likes = [];
                        const index = post.likes.indexOf(currentUser.username);
                        if (result.liked) {
                            if (index === -1) post.likes.push(currentUser.username);
                        } else {
                            if (index > -1) post.likes.splice(index, 1);
                        }
                    }
                    
                    // Update UI immediately without full re-render
                    updatePostLikeButton(postId, result.liked, post.likes.length);
                } else {
                    showToast('Erreur lors du like');
                }
            } catch (err) {
                console.error('Error toggling post like:', err);
                showToast('Erreur lors du like');
            }
        }
        
        function updatePostLikeButton(postId, isLiked, likeCount) {
            // Find all like buttons for this post
            const buttons = document.querySelectorAll(`button[onclick*="togglePostLike('${postId}')"]`);
            
            buttons.forEach(btn => {
                const countSpan = btn.querySelector('span');
                
                // Update button color
                if (isLiked) {
                    btn.classList.remove('text-gray-500');
                    btn.classList.add('text-red-500');
                } else {
                    btn.classList.remove('text-red-500');
                    btn.classList.add('text-gray-500');
                }
                
                // Update count
                if (countSpan) {
                    countSpan.textContent = likeCount;
                }
            });
            
            // Recreate icons
            lucide.createIcons();
        }
        
        async function sharePost(postId, postTitle) {
            const shareUrl = `${window.location.origin}${window.location.pathname}#post-${postId}`;
            
            // Try native share API first (mobile)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: postTitle,
                        text: `Découvrez ce post : ${postTitle}`,
                        url: shareUrl
                    });
                    showToast('Post partagé !');
                    return;
                } catch (err) {
                    // User cancelled or error, fallback to clipboard
                }
            }
            
            // Fallback: copy to clipboard
            try {
                await navigator.clipboard.writeText(shareUrl);
                showToast('🔗 Lien copié dans le presse-papiers !');
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = shareUrl;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('🔗 Lien copié !');
                } catch (e) {
                    showToast('Impossible de copier le lien');
                }
                document.body.removeChild(textArea);
            }
        }

        // --- EXPLORE & ARTISTS ---
        async function fetchArtists() {
            let serverArtists = [];
            try {
                const r = await fetch(`${ACTIVE_SERVER}/artists`);
                if(r.ok) serverArtists = await r.json();
            } catch(e) {}

            // Extract unique artists from songs - SPLIT MULTIPLE ARTISTS
            const allArtistNames = songs.flatMap(s => {
                if(!s.artist) return [];
                // Si l'artiste contient des virgules, séparer en plusieurs artistes
                if(s.artist.includes(',')) {
                    return s.artist.split(',').map(a => a.trim()).filter(a => a);
                }
                return [s.artist];
            });
            const songArtists = [...new Set(allArtistNames)]; // Unique names
            
            // Merge
            artists = songArtists.map(name => {
                const serverData = serverArtists.find(a => a.name === name) || {};
                return {
                    name: name,
                    avatar: serverData.avatar || 'https://via.placeholder.com/150',
                    banner: serverData.banner || 'https://images.unsplash.com/photo-1514525253440-b393332569ec?w=1200&q=80',
                    followersCount: serverData.followersCount || 0 // Keeping data but hiding from UI
                };
            });
            
            renderExploreProfiles();
            renderAdminLists();
        }

        function renderExploreProfiles() {
            const artistsHTML = artists.map(art => `
                <div class="group relative cursor-pointer" onclick="openArtistProfile('${safeEncode(art.name)}')">
                    <div class="bg-gradient-to-br from-white/10 to-white/[0.02] backdrop-blur-xl rounded-3xl p-6 border border-white/10 hover:border-white/20 transition-all duration-300 hover:shadow-2xl hover:shadow-purple-500/10">
                        <div class="relative mb-4">
                            <div class="absolute inset-0 bg-gradient-to-br from-purple-500 to-pink-500 blur-xl opacity-0 group-hover:opacity-30 transition-opacity rounded-full"></div>
                            <img src="${art.avatar || 'https://via.placeholder.com/150'}" class="relative w-full aspect-square rounded-full object-cover ring-4 ring-white/10 group-hover:ring-purple-500/50 transition-all transform group-hover:scale-105">
                        </div>
                        <h3 class="font-bold text-white text-center truncate text-lg group-hover:text-transparent group-hover:bg-gradient-to-r group-hover:from-purple-400 group-hover:to-pink-400 group-hover:bg-clip-text transition-all">${art.name}</h3>
                        <div class="flex items-center justify-center gap-1 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="music" class="w-3 h-3 text-purple-400"></i>
                            <span class="text-xs text-gray-400">Artiste</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('exploreProfilesList').innerHTML = artistsHTML;
            const artistWord = currentLang === 'fr' ? 'artiste' + (artists.length > 1 ? 's' : '') : currentLang === 'en' ? 'artist' + (artists.length > 1 ? 's' : '') : currentLang === 'es' ? 'artista' + (artists.length > 1 ? 's' : '') : currentLang === 'it' ? 'artist' + (artists.length > 1 ? 'i' : 'a') : currentLang === 'pt' ? 'artista' + (artists.length > 1 ? 's' : '') : currentLang === 'de' ? 'Künstler' : currentLang === 'zh' ? '艺人' : currentLang === 'ja' ? 'アーティスト' : '아티스트';
            document.getElementById('artistCount').textContent = `${artists.length} ${artistWord}`;
            lucide.createIcons();
        }

        function fetchGenres() { fetch(`${ACTIVE_SERVER}/genres`).then(r=>r.ok?r.json():[]).then(g=>{genres=g; renderExplore(); renderAdminLists(); }); }
        
        function renderExplore() { 
            // 1. Genres Grid: Only show genres that have songs
            const activeGenres = genres.filter(gName => songs.some(s => s.genre === gName));
            
            const genresHTML = activeGenres.map(g => {
                // Find songs cover for this genre to use as bg
                const genreSongs = songs.filter(song => song.genre === g);
                const songCount = genreSongs.length;
                
                // Create cycling images
                let imagesHtml = '';
                if(genreSongs.length > 0) {
                    const uniqueCovers = [...new Set(genreSongs.map(s => s.cover || DEFAULT_COVER))].slice(0, 5);
                    imagesHtml = uniqueCovers.map((img, i) => `<img src="${img}" class="album-fade-img${uniqueCovers.length > 1 ? '' : ' no-fade'}" style="animation-delay: ${i * 4}s">`).join('');
                }
                
                return `
                    <div class="genre-card group" onclick="filterByGenre('${g}')">
                        <div class="genre-image-container">${imagesHtml}</div>
                        <div class="genre-overlay">
                            <div class="text-center">
                                <span class="text-2xl font-black block mb-1">${g}</span>
                                <span class="text-xs text-gray-300 opacity-0 group-hover:opacity-100 transition-opacity">${songCount} ${currentLang === 'fr' ? 'titre' + (songCount > 1 ? 's' : '') : currentLang === 'en' ? 'song' + (songCount > 1 ? 's' : '') : currentLang === 'es' ? 'canción' + (songCount > 1 ? 'es' : '') : currentLang === 'it' ? 'bran' + (songCount > 1 ? 'i' : 'o') : currentLang === 'pt' ? 'música' + (songCount > 1 ? 's' : '') : currentLang === 'de' ? 'Lied' + (songCount > 1 ? 'er' : '') : currentLang === 'zh' ? '歌曲' : currentLang === 'ja' ? '曲' : '노래'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('exploreGrid').innerHTML = genresHTML;
            const genreWord = currentLang === 'fr' ? 'genre' + (activeGenres.length > 1 ? 's' : '') : currentLang === 'en' ? 'genre' + (activeGenres.length > 1 ? 's' : '') : currentLang === 'es' ? 'género' + (activeGenres.length > 1 ? 's' : '') : currentLang === 'it' ? 'gener' + (activeGenres.length > 1 ? 'i' : 'e') : currentLang === 'pt' ? 'gênero' + (activeGenres.length > 1 ? 's' : '') : currentLang === 'de' ? 'Genre' + (activeGenres.length > 1 ? 's' : '') : currentLang === 'zh' ? '风格' : currentLang === 'ja' ? 'ジャンル' : '장르';
            document.getElementById('genreCount').textContent = `${activeGenres.length} ${genreWord}`;

            // 2. Albums Carousel avec design premium
            const albums = [...new Set(songs.filter(s=>s.album).map(s=>s.album))];
            const canModAlbum = currentUser && (['admin','superadmin'].includes(currentUser.role));
            const isAlbumLiked = (albumName) => currentUser && currentUser.likedAlbums && currentUser.likedAlbums.includes(albumName);
            
            const albumsHTML = albums.map(alb => {
                const s = songs.find(x => x.album === alb);
                const albumLikes = users.filter(u => u.likedAlbums && u.likedAlbums.includes(alb)).length;
                return `
                    <div class="flex-shrink-0 w-44 md:w-52 snap-start cursor-pointer group relative" onclick="openAlbumView('${safeEncode(alb)}')">
                        <div class="bg-gradient-to-br from-white/10 to-white/[0.02] backdrop-blur-xl rounded-2xl p-4 border border-white/10 hover:border-purple-500/50 transition-all duration-300 hover:shadow-2xl hover:shadow-purple-500/20">
                            <div class="relative mb-3">
                                <div class="absolute inset-0 bg-gradient-to-br from-purple-500 to-pink-500 blur-xl opacity-0 group-hover:opacity-20 transition-opacity rounded-xl"></div>
                                <img src="${s.cover || DEFAULT_COVER}" class="relative w-full aspect-square rounded-xl object-cover shadow-lg transform group-hover:scale-105 transition-transform">
                                ${canModAlbum ? `
                                    <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-20 pointer-events-none group-hover:pointer-events-auto">
                                        <button onclick="event.stopPropagation(); event.preventDefault(); openEditAlbumModal('${safeEncode(alb)}')" class="p-2.5 bg-blue-600 backdrop-blur-sm rounded-lg text-white hover:bg-blue-700 active:scale-95 transition-all shadow-lg hover:shadow-blue-500/50 cursor-pointer pointer-events-auto" title="Modifier" style="pointer-events: auto !important;">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="event.stopPropagation(); event.preventDefault(); deleteAlbum('${safeEncode(alb)}')" class="p-2.5 bg-red-600 backdrop-blur-sm rounded-lg text-white hover:bg-red-700 active:scale-95 transition-all shadow-lg hover:shadow-red-500/50 cursor-pointer pointer-events-auto" title="Supprimer" style="pointer-events: auto !important;">
                                            <i data-lucide="trash" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                ` : ''}
                                <button onclick="event.stopPropagation(); toggleAlbumLike('${safeEncode(alb)}')" class="absolute bottom-2 right-2 p-2 bg-black/80 backdrop-blur-sm rounded-full ${isAlbumLiked(alb) ? 'text-red-500' : 'text-gray-400'} hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all hover:scale-110" title="J'aime">
                                    <i data-lucide="heart" class="w-4 h-4 fill-current"></i>
                                </button>
                                ${albumLikes > 0 ? `
                                    <span class="absolute bottom-2 left-2 px-2 py-1 bg-black/80 backdrop-blur-sm rounded-full text-xs text-white opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                                        <i data-lucide="heart" class="w-3 h-3 text-red-500 fill-current"></i>
                                        ${albumLikes}
                                    </span>
                                ` : ''}
                            </div>
                            <p class="text-sm font-bold text-white truncate mb-1">${alb}</p>
                            <p class="text-xs text-gray-400 truncate">${s.artist}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('albumsList').innerHTML = albumsHTML;
        }

        // --- COMMUNITY LIST ---
        async function fetchUsers() { 
            try {
                const r=await fetch(`${ACTIVE_SERVER}/users`); 
                const u=await r.json(); 
                users = u;
                
                // Admin Table
                document.getElementById('userTableBody').innerHTML=u.map(x=>{ 
                    let actionBtn = ""; 
                    if (currentUser && ['superadmin'].includes(currentUser.role) && x.role !== 'superadmin') {
                        if(x.role === "user") actionBtn = `<button onclick="changeRole('${x.username}','admin')" class="text-blue-400 hover:text-blue-300 text-xs font-bold uppercase">Promouvoir</button>`; 
                        else if(x.role === "admin") actionBtn = `<button onclick="changeRole('${x.username}','user')" class="text-red-400 hover:text-red-300 text-xs font-bold uppercase">Rétrograder</button>`; 
                    }
                    return `<tr><td class="px-4 py-3 font-medium text-white">${x.username}</td><td class="px-4 py-3"><span class="px-2 py-1 bg-white/10 rounded text-xs">${x.role}</span></td><td class="px-4 py-3 text-right">${actionBtn}</td></tr>`; 
                }).join(''); 
                
                // Notif Target Select
                const notifSelect = document.getElementById('notifTargetUser'); 
                if(notifSelect) { const currentOpt = notifSelect.value; notifSelect.innerHTML = `<option value="all">Tous les utilisateurs</option>` + u.map(x => `<option value="${x.username}">${x.username}</option>`).join(''); if(currentOpt) notifSelect.value = currentOpt; } 
                
                // Update community stats
                const onlineCount = users.filter(u => u.isOnline).length;
                document.getElementById('statsCommunityMembers').textContent = users.length;
                document.getElementById('statsCommunityOnline').textContent = onlineCount;
                
                // Community list with Online Status & Role - REFONTE
                document.getElementById('communityUsers').innerHTML = users.map(u => `
                    <div class="flex items-center gap-3 p-3 bg-gradient-to-r from-white/5 to-transparent rounded-xl cursor-pointer hover:from-white/10 hover:to-white/5 transition-all duration-300 group border border-transparent hover:border-white/10" onclick="openUserProfile('${safeEncode(u.username)}')">
                        <div class="relative flex-shrink-0">
                            <img src="${u.avatar || 'https://via.placeholder.com/150'}" class="w-12 h-12 rounded-full object-cover ring-2 ring-white/10 group-hover:ring-white/20 transition-all">
                            ${u.isOnline ? '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 border-2 border-[#121212] rounded-full animate-pulse"></div>' : '<div class="absolute bottom-0 right-0 w-3.5 h-3.5 bg-gray-600 border-2 border-[#121212] rounded-full"></div>'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-sm text-white truncate group-hover:text-red-400 transition-colors">${u.username}</span>
                                ${u.role === 'superadmin' ? '<div class="flex items-center gap-1 bg-gradient-to-r from-red-500 to-pink-500 px-2 py-0.5 rounded-full"><i data-lucide="crown" class="w-2.5 h-2.5 text-white"></i><span class="text-[9px] text-white font-bold">SUPER</span></div>' : (u.role === 'admin' ? '<div class="flex items-center gap-1 bg-gradient-to-r from-blue-500 to-cyan-500 px-2 py-0.5 rounded-full"><i data-lucide="shield" class="w-2.5 h-2.5 text-white"></i><span class="text-[9px] text-white font-bold">ADMIN</span></div>' : '')}
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white transition-colors opacity-0 group-hover:opacity-100"></i>
                    </div>`).join('');
                lucide.createIcons();

                // New Additions (Logic changed: Group by Album) - REFONTE
                // Filter recent adds, grouping by Album if present
                const recentItems = [];
                const processedAlbums = new Set();
                const reversedSongs = [...songs].reverse();

                for (const s of reversedSongs) {
                    if (recentItems.length >= 5) break;
                    
                    if (s.album && s.album !== 'Single' && s.album !== s.title) {
                        if (!processedAlbums.has(s.album)) {
                            recentItems.push({ type: 'album', data: s });
                            processedAlbums.add(s.album);
                        }
                    } else {
                        recentItems.push({ type: 'song', data: s });
                    }
                }

                document.getElementById('newAdditionsList').innerHTML = recentItems.map((item, index) => {
                    const s = item.data;
                    const gradient = index % 4 === 0 ? 'from-red-500/10' : index % 4 === 1 ? 'from-purple-500/10' : index % 4 === 2 ? 'from-blue-500/10' : 'from-pink-500/10';
                    
                    if(item.type === 'album') {
                        return `
                        <div class="flex items-center gap-4 p-3 hover:bg-white/5 rounded-xl cursor-pointer group transition-all duration-300 bg-gradient-to-r ${gradient} to-transparent border border-white/5 hover:border-white/10" onclick="openAlbumView('${safeEncode(s.album)}')">
                            <div class="relative flex-shrink-0">
                                <img src="${s.cover || DEFAULT_COVER}" class="w-14 h-14 rounded-lg object-cover shadow-lg group-hover:shadow-xl group-hover:scale-105 transition-all duration-300">
                                <div class="absolute -top-1 -right-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-full shadow-lg">ALBUM</div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-white truncate group-hover:text-purple-400 transition-colors mb-0.5">${s.album}</p>
                                <p class="text-xs text-gray-400 truncate">${s.artist}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[9px] text-gray-600 uppercase tracking-wider">Nouvel album</span>
                                </div>
                            </div>
                            <i data-lucide="disc-3" class="w-5 h-5 text-gray-600 group-hover:text-purple-400 transition-colors"></i>
                        </div>`;
                    } else {
                        return `
                        <div class="flex items-center gap-4 p-3 hover:bg-white/5 rounded-xl cursor-pointer group transition-all duration-300 bg-gradient-to-r ${gradient} to-transparent border border-white/5 hover:border-white/10" onclick="playSong('${s.id}')">
                            <div class="relative flex-shrink-0">
                                <img src="${s.cover || DEFAULT_COVER}" class="w-14 h-14 rounded-lg object-cover shadow-lg group-hover:shadow-xl group-hover:scale-105 transition-all duration-300">
                                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center">
                                    <i data-lucide="play" class="w-5 h-5 text-white fill-current"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-white truncate group-hover:text-red-400 transition-colors mb-0.5">${s.title}</p>
                                <p class="text-xs text-gray-400 truncate">${s.artist}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[9px] text-gray-600 uppercase tracking-wider">Nouveau titre</span>
                                </div>
                            </div>
                            <i data-lucide="music" class="w-5 h-5 text-gray-600 group-hover:text-red-400 transition-colors"></i>
                        </div>`;
                    }
                }).join('');
                lucide.createIcons();

            } catch(e) {}
        }

        // --- ADMIN LISTS (REAL DATA) ---
        function renderAdminLists() {
            if(!currentUser || !['admin','superadmin'].includes(currentUser.role)) return;
            
            // Artists (Real List from JSON/Server)
            document.getElementById('adminArtistList').innerHTML = artists.map(art => `
                <div class="flex items-center justify-between p-2 hover:bg-white/5 rounded-lg group">
                    <img src="${art.avatar || ''}" class="w-6 h-6 rounded-full mr-2 object-cover">
                    <span class="text-sm font-medium truncate flex-1 cursor-pointer hover:text-purple-400" onclick="openArtistProfile('${safeEncode(art.name)}')">${art.name}</span>
                    <button onclick="openEditArtistModal('${safeEncode(art.name)}')" class="text-gray-500 hover:text-white p-1"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                </div>`).join('');
            
            // Genres (Editable)
            document.getElementById('genreAdminList').innerHTML = genres.map(g => `
                <div class="flex items-center justify-between p-2 bg-white/5 rounded mb-1">
                    <span class="text-xs font-medium">${g}</span>
                    <button onclick="deleteGenre('${g}')" class="text-red-500 hover:text-white p-1"><i data-lucide="trash" class="w-3 h-3"></i></button>
                </div>
            `).join('');

            lucide.createIcons();
        }

        async function addGenre() {
            const val = document.getElementById('newGenreInput').value;
            if(!val) return;
            try {
                // Assuming POST /genres endpoint adds to the list
                await fetch(`${ACTIVE_SERVER}/genres`, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: val }) });
                document.getElementById('newGenreInput').value = '';
                showToast("Genre ajouté");
                fetchGenres(); // Refresh
            } catch(e) { showToast("Erreur serveur"); }
        }

        async function deleteGenre(name) {
            if(!await customConfirm("Supprimer ce genre ?")) return;
            try {
                await fetch(`${ACTIVE_SERVER}/genres/${name}`, { method: 'DELETE' });
                fetchGenres();
            } catch(e) {}
        }

        // ... [Rest of standard functions: handleSingleFileSelect, handleFileSelect, etc. unchanged] ...
        function handleSingleFileSelect(input, targetIdPrefix) {
            if (input.files[0]) {
                const file = input.files[0]; const r = new FileReader();
                r.onload = e => {
                    document.getElementById(targetIdPrefix).value = e.target.result;
                    const isVideo = file.type.startsWith('video');
                    if(document.getElementById(targetIdPrefix + 'Type')) document.getElementById(targetIdPrefix + 'Type').value = isVideo ? 'video' : 'image';
                    if(isVideo && document.getElementById(targetIdPrefix + 'VideoPreview')) { const vPreview = document.getElementById(targetIdPrefix + 'VideoPreview'); vPreview.src = e.target.result; vPreview.classList.remove('hidden'); document.getElementById(targetIdPrefix + 'Preview').classList.add('hidden'); } 
                    else if (document.getElementById(targetIdPrefix + 'Preview')) { const imgPreview = document.getElementById(targetIdPrefix + 'Preview'); imgPreview.src = e.target.result; imgPreview.classList.remove('hidden'); if(document.getElementById(targetIdPrefix + 'VideoPreview')) document.getElementById(targetIdPrefix + 'VideoPreview').classList.add('hidden'); }
                }; r.readAsDataURL(file);
            }
        }
        function handleFileSelect(input, type) { if(input.files[0]) { const r = new FileReader(); r.onload = e => document.getElementById(type==='song'?'audioDataSong':'').value = e.target.result; r.readAsDataURL(input.files[0]); if(type==='song') document.getElementById('dropContentSong').innerHTML = `<p class="text-white">${input.files[0].name}</p>`; } }
        
        function handleAlbumFilesSelect(input) {
            const list = document.getElementById('albumFileList');
            if (input.files.length > 0) {
                list.classList.remove('hidden');
                list.innerHTML = Array.from(input.files).map(f => `<div>- ${f.name}</div>`).join('');
                document.getElementById('dropContentAlbum').innerHTML = `<p class="text-white">${input.files.length} fichiers</p>`;
            } else {
                list.classList.add('hidden');
                list.innerHTML = '';
            }
        }
        
        function handleAvatarSelect(input) { handleSingleFileSelect(input, 'avatarData'); }
        function handleBannerSelect(input) { handleSingleFileSelect(input, 'bannerData'); }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initSearch(); // Initialize search system
            updateTranslations(); // Initialize translations
            
            // Initialize theme
            document.body.setAttribute('data-theme', currentTheme);
            const activeThemeBtn = document.querySelector(`.theme-btn[data-theme="${currentTheme}"]`);
            if (activeThemeBtn) activeThemeBtn.classList.add('active');
            
            const savedUser = localStorage.getItem('musicAppUser');
            if(savedUser) { currentUser = JSON.parse(savedUser); updateUserUI(); setServerStatus('online'); smartConnect(); }
            else document.getElementById('authModal').classList.remove('hidden');
        });

        function setServerStatus(status) {
            const el = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            el.className = 'status-dot ' + (status === 'online' ? 'status-online' : 'status-offline');
            txt.innerText = status === 'online' ? 'En ligne' : 'Hors ligne';
        }

        // --- AUTH ---
        function toggleAuthMode() {
            isRegistering = !isRegistering;
            document.getElementById('authTitle').innerText = isRegistering ? "Inscription" : "Connexion";
            document.getElementById('authBtnAction').innerText = isRegistering ? "S'inscrire" : "Se connecter";
            document.getElementById('authSwitchBtn').innerText = isRegistering ? "J'ai déjà un compte" : "Créer un compte";
        }

        async function performAuth() {
            const u = document.getElementById('authUsername').value;
            const p = document.getElementById('authPassword').value;
            if(!u || !p) return showToast("Remplissez tous les champs");
            const ep = isRegistering ? '/auth/register' : '/auth/login';
            try {
                const r = await fetch(`${ACTIVE_SERVER}${ep}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const d = await r.json();
                if(d.success || r.ok) {
                    const role = d.role || (u.toLowerCase() === 'admin' ? 'superadmin' : 'user');
                    currentUser = { 
                        username: u, 
                        role: role, 
                        following: d.following || [], 
                        avatar: d.avatar,
                        likedAlbums: d.likedAlbums || []
                    };
                    localStorage.setItem('musicAppUser', JSON.stringify(currentUser));
                    document.getElementById('authModal').classList.add('hidden');
                    updateUserUI(); smartConnect(); showToast(`Bienvenue ${u}`);
                } else { showToast(d.message || "Erreur"); }
            } catch(e) { showToast("Erreur connexion serveur"); }
        }

        function logout() { localStorage.removeItem('musicAppUser'); location.reload(); }
        function updateUserUI() {
            if(!currentUser) return;
            console.log('🔍 Current user:', currentUser);
            console.log('👤 Role:', currentUser.role);
            document.getElementById('userInfo').innerText = currentUser.username;
            document.getElementById('userRole').innerText = currentUser.role || 'User';
            document.getElementById('userAvatar').src = currentUser.avatar || "https://via.placeholder.com/150";
            
            // Show admin panel if user is admin or superadmin
            const isAdmin = currentUser.role === 'admin' || currentUser.role === 'superadmin';
            console.log('👑 Is admin?', isAdmin);
            
            if(isAdmin) { 
                console.log('✅ Showing admin panel and nav');
                const adminPanel = document.getElementById('adminPanel');
                const navAdmin = document.getElementById('navAdmin');
                if(adminPanel) adminPanel.classList.remove('hidden');
                if(navAdmin) navAdmin.classList.remove('hidden');
            } else {
                console.log('❌ Not admin, hiding admin panel');
            }
        }

        function renderSongs(list) {
            const canMod = s => currentUser && (['admin','superadmin'].includes(currentUser.role));
            const isLiked = (s) => currentUser && s.likes && s.likes.includes(currentUser.username);
            const likeCount = (s) => (s.likes && s.likes.length) || 0;
            
            document.getElementById('songGrid').innerHTML = list.map(s => `
                <div class="group relative bg-[#181818] p-4 rounded-xl hover:bg-[#282828] transition-all duration-300 cursor-pointer" onclick="playSong('${s.id}')">
                    <div class="relative mb-4 shadow-lg rounded-lg overflow-hidden">
                        <img src="${s.cover || DEFAULT_COVER}" class="w-full aspect-square object-cover transform group-hover:scale-105 transition-transform duration-500">
                        <button onclick="playSong('${s.id}')" class="absolute bottom-2 right-2 p-3 rounded-full bg-red-500 text-white shadow-xl translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 hover:scale-105 hover:bg-red-400"><i data-lucide="play" class="fill-current w-5 h-5"></i></button>
                    </div>
                    <h3 class="font-bold text-white mb-1 truncate">${s.title}</h3>
                    <p class="text-sm text-gray-400 truncate hover:underline" onclick="event.stopPropagation(); openArtistProfile('${safeEncode(s.artist)}')">${s.artist}</p>
                    
                    <div class="flex items-center gap-2 mt-2">
                        <button onclick="event.stopPropagation(); toggleLike('${s.id}')" class="flex items-center gap-1 text-xs ${isLiked(s) ? 'text-red-500' : 'text-gray-400'} hover:text-red-500 transition-colors" title="J'aime">
                            <i data-lucide="heart" class="w-4 h-4 ${isLiked(s) ? 'fill-current' : ''}"></i>
                            <span>${likeCount(s)}</span>
                        </button>
                    </div>
                    
                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button onclick="event.stopPropagation(); addToPlaylist('${s.id}')" class="p-1.5 bg-black/60 rounded text-white hover:bg-white/20" title="Ajouter à une playlist"><i data-lucide="plus" class="w-3 h-3"></i></button>
                         ${canMod(s) ? `<button onclick="event.stopPropagation(); openEditModal('${s.id}')" class="p-1.5 bg-black/60 rounded text-white hover:bg-blue-600/80"><i data-lucide="edit-2" class="w-3 h-3"></i></button>` : ''}
                    </div>
                    ${canMod(s) ? `<button onclick="event.stopPropagation(); deleteSong('${s.id}')" class="absolute top-2 left-2 p-1.5 bg-red-600/80 rounded text-white opacity-0 group-hover:opacity-100"><i data-lucide="trash" class="w-3 h-3"></i></button>` : ''}
                </div>`).join('');
            document.getElementById('songCount').innerText = `${list.length} titres`;
            lucide.createIcons();
        }

        function openEditModal(id) {
            const s = songs.find(x=>x.id===id);
            if(!s) return;
            
            // Open modal FIRST (before filling fields)
            document.getElementById('addModal').classList.remove('hidden');
            switchAddTab('song'); // Make sure we're on song tab
            document.getElementById('addModalTitle').innerText = "Modifier Titre";
            populateGenreSelect();
            
            // THEN fill all fields
            document.getElementById('editSongId').value = s.id;
            document.getElementById('inputTitle').value = s.title;
            document.getElementById('inputGenre').value = s.genre;
            document.getElementById('existingSrc').value = s.src;
            
            // Pré-remplir la cover
            document.getElementById('inputCover').value = s.cover || DEFAULT_COVER;
            if(s.cover && s.cover !== DEFAULT_COVER) {
                const preview = document.getElementById('inputCoverPreview');
                preview.src = s.cover;
                preview.classList.remove('hidden');
            }
            
            // Gérer les artistes multiples (séparés par virgule)
            if(s.artist && s.artist.includes(',')) {
                const artistNames = s.artist.split(',').map(a => a.trim()).filter(a => a);
                currentSongArtists = artistNames;
                renderSongArtists();
                document.getElementById('inputArtist').value = '';
            } else {
                currentSongArtists = [];
                document.getElementById('inputArtist').value = s.artist || '';
                renderSongArtists();
            }
        }

        async function showUserList(type) {
            if(!viewingProfileId) return;
            const targetUser = viewingProfileId;
            document.getElementById('userListModal').classList.remove('hidden');
            document.getElementById('userListTitle').innerText = type === 'followers' ? `Abonnés de ${targetUser}` : `Abonnements de ${targetUser}`;
            document.getElementById('userListContent').innerHTML = '<p class="text-center py-4">Chargement...</p>';
            
            try {
                // Fetch fresh user data
                const r = await fetch(`${ACTIVE_SERVER}/users/profile/${targetUser}`);
                const data = await r.json();
                const list = type === 'followers' ? data.followers : data.following;
                
                if(!list || list.length === 0) {
                    document.getElementById('userListContent').innerHTML = '<p class="text-center py-4 text-gray-500">Personne</p>';
                    return;
                }

                // 10. FOLLOWERS PROFILE PICS FIX
                // Look up user objects from global 'users' list to find avatars
                document.getElementById('userListContent').innerHTML = list.map(uName => {
                    const uObj = users.find(u => u.username === uName);
                    const avatar = uObj ? (uObj.avatar || 'https://via.placeholder.com/150') : 'https://via.placeholder.com/150';
                    
                    return `
                    <div class="flex items-center justify-between p-2 hover:bg-white/5 rounded-lg cursor-pointer" onclick="document.getElementById('userListModal').classList.add('hidden'); openUserProfile('${safeEncode(uName)}')">
                        <div class="flex items-center gap-3">
                            <img src="${avatar}" class="w-8 h-8 rounded-full object-cover bg-gray-700">
                            <span class="font-medium text-white">${uName}</span>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500"></i>
                    </div>`;
                }).join('');
                lucide.createIcons();
            } catch(e) {
                document.getElementById('userListContent').innerHTML = '<p class="text-center text-red-500">Erreur</p>';
            }
        }

        async function openArtistProfile(artistNameEncoded) {
            const artistName = decodeURIComponent(artistNameEncoded);
            viewingProfileType = 'artist'; viewingProfileId = artistName;
            switchView('profile');
            
            let artistData = {};
            try { const r = await fetch(`${ACTIVE_SERVER}/artists/${artistName}`); if(r.ok) artistData = await r.json(); } catch(e) {}
            const artistSongs = songs.filter(s => songHasArtist(s, artistName));
            
            document.getElementById('profileName').innerText = artistName;
            document.getElementById('profileRole').innerText = "Artiste";
            // Use artist specific avatar/banner, or fallback to first song cover, or default placeholder
            document.getElementById('profileAvatar').src = artistData.avatar || (artistSongs[0]?.cover || DEFAULT_COVER);
            document.getElementById('profileBanner').src = artistData.banner || "https://images.unsplash.com/photo-1514525253440-b393332569ec?w=1200&q=80";

            // HIDE Followers and Subscriptions for Artists
            document.getElementById('profileFollowing').parentElement.style.display = 'none'; // Hide followers count
            document.getElementById('containerFollowing').style.display = 'none'; // Hide subscriptions

            const isFollowing = currentUser.following.includes(artistName);
            // REMOVE SUBSCRIBE BUTTON - Only Play button remains
            let btn = `<button onclick="playRandomArtist('${safeEncode(artistName)}')" class="px-4 py-2 bg-white text-black hover:bg-gray-200 rounded-lg font-bold mr-2 flex items-center gap-2"><i data-lucide="play" class="w-4 h-4 fill-black"></i> Lecture</button>`; 
            
            document.getElementById('profileActions').innerHTML = btn;
            lucide.createIcons();

            document.getElementById('profileContentTitle').innerText = "Discographie";
            
            // Group songs by album
            const albumsMap = new Map();
            const singles = [];
            
            artistSongs.forEach(s => {
                if (s.album && s.album !== 'Single' && s.album !== s.title) {
                    if (!albumsMap.has(s.album)) {
                        albumsMap.set(s.album, s); // Store representative song for cover
                    }
                } else {
                    singles.push(s);
                }
            });

            let html = '';
            
            // Render Albums first
            albumsMap.forEach((s, albumName) => {
                 html += `
                    <div class="flex items-center gap-3 p-2 hover:bg-white/10 rounded-lg cursor-pointer group" onclick="openAlbumView('${safeEncode(albumName)}')">
                        <img src="${s.cover || DEFAULT_COVER}" class="w-10 h-10 rounded-lg object-cover">
                        <div class="overflow-hidden">
                            <p class="text-sm font-bold text-white truncate"><span class="bg-white/20 text-[10px] px-1.5 py-0.5 rounded mr-2 align-middle">ALBUM</span>${albumName}</p>
                            <p class="text-xs text-gray-500 truncate">${s.artist}</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-500 ml-auto"></i>
                    </div>`;
            });

            // Render Singles
            singles.forEach(s => {
                 html += `
                    <div class="flex items-center gap-3 p-2 hover:bg-white/10 rounded-lg cursor-pointer group" onclick="playSong('${s.id}')">
                        <img src="${s.cover || DEFAULT_COVER}" class="w-10 h-10 rounded-lg object-cover">
                        <div class="overflow-hidden">
                            <p class="text-sm font-bold text-white truncate">${s.title}</p>
                            <p class="text-xs text-gray-500 truncate">Single</p>
                        </div>
                        <button class="ml-auto opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-white"><i data-lucide="play" class="w-4 h-4"></i></button>
                    </div>`;
            });
            
            document.getElementById('profilePlaylists').innerHTML = html;
            document.getElementById('profilePlaylists').className = "space-y-2"; 
            lucide.createIcons();
        }

        function playRandomArtist(artistNameEncoded) {
            const artistName = decodeURIComponent(artistNameEncoded);
            const artistSongs = songs.filter(s => songHasArtist(s, artistName));
            if(artistSongs.length > 0) {
                filteredSongs = artistSongs.sort(() => Math.random() - 0.5);
                playSong(filteredSongs[0].id);
            }
        }

        async function openUserProfile(usernameEncoded) {
            const username = decodeURIComponent(usernameEncoded);
            if(!username || username === '--') return;
            viewingProfileType = 'user'; viewingProfileId = username;
            switchView('profile');
            
            let data = {};
            try { const r = await fetch(`${ACTIVE_SERVER}/users/profile/${username}`); if(r.ok) data = await r.json(); } catch(e) {}

            document.getElementById('profileName').innerText = data.username || username;
            document.getElementById('profileRole').innerText = data.role || 'user';
            document.getElementById('profileAvatar').src = data.avatar || "https://via.placeholder.com/150";
            document.getElementById('profileBanner').src = data.banner || "https://images.unsplash.com/photo-1514525253440-b393332569ec?w=1200&q=80";
            
            // SHOW Stats for Users
            const followContainer = document.getElementById('profileFollowing').parentElement;
            followContainer.style.display = 'block';
            document.getElementById('profileFollowing').innerText = data.followers ? data.followers.length : 0;
            document.getElementById('labelFollowing').innerText = "Abonnés";
            
            const subContainer = document.getElementById('containerFollowing');
            subContainer.style.display = 'block';
            document.getElementById('profileFollowers').innerText = data.following ? data.following.length : 0;

            const isMe = currentUser.username === username;
            const isFollowing = currentUser.following.includes(username);
            let btn = "";
            
            if (isMe) {
                btn = `<button onclick="document.getElementById('profileModal').classList.remove('hidden')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg font-bold">Modifier</button>`;
            } else {
                btn = isFollowing 
                    ? `<button id="btnFollow" onclick="followUser('${safeEncode(username)}')" class="px-4 py-2 border border-white/20 text-white rounded-lg font-bold transition-all hover:bg-white/10">Abonné</button>`
                    : `<button id="btnFollow" onclick="followUser('${safeEncode(username)}')" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold transition-all">S'abonner</button>`;
            }
            
            document.getElementById('profileActions').innerHTML = btn;

            // Container for profile content
            let profileContent = '';
            
            // 1. Playlists Section
            const userPlaylists = playlists.filter(p => p.owner === username);
            profileContent += `<div class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="list-music" class="w-6 h-6"></i>
                    Playlists (${userPlaylists.length})
                </h2>`;
            
            if(userPlaylists.length > 0) {
                profileContent += `<div class="grid grid-cols-2 md:grid-cols-4 gap-6">`;
                userPlaylists.forEach(p => {
                    // Utiliser la photo de la playlist si elle existe, sinon la couverture de la première chanson
                    let cover = DEFAULT_COVER;
                    if (p.cover) {
                        cover = p.cover;
                    } else if (p.songs && p.songs.length > 0) {
                        const coverSong = songs.find(s => s.id === p.songs[0]);
                        if (coverSong && coverSong.cover) {
                            cover = coverSong.cover;
                        }
                    }
                    
                    profileContent += `
                        <div class="group relative bg-[#181818] p-4 rounded-xl hover:bg-[#282828] transition-all duration-300 cursor-pointer" onclick="openPlaylist('${p.id}')">
                            <div class="relative mb-4 shadow-lg rounded-lg overflow-hidden">
                                <img src="${cover}" class="w-full aspect-square object-cover transform group-hover:scale-105 transition-transform duration-500">
                                <button class="absolute bottom-2 right-2 p-3 rounded-full bg-red-500 text-white shadow-xl translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 hover:scale-105 hover:bg-red-400">
                                    <i data-lucide="play" class="fill-current w-5 h-5"></i>
                                </button>
                            </div>
                            <h3 class="font-bold text-white mb-1 truncate">${p.name}</h3>
                            <p class="text-sm text-gray-400 truncate">${p.songs ? p.songs.length : 0} titre${p.songs && p.songs.length > 1 ? 's' : ''}</p>
                        </div>`;
                });
                profileContent += `</div>`;
            } else {
                profileContent += `<p class="text-gray-500">Aucune playlist</p>`;
            }
            profileContent += `</div>`;
            
            // 2. Liked Songs Section
            const likedSongs = songs.filter(s => s.likes && s.likes.includes(username));
            profileContent += `<div class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="heart" class="w-6 h-6"></i>
                    Titres Likés (${likedSongs.length})
                </h2>`;
            
            if(likedSongs.length > 0) {
                const canMod = s => currentUser && (['admin','superadmin'].includes(currentUser.role));
                const isLiked = (s) => currentUser && s.likes && s.likes.includes(currentUser.username);
                const likeCount = (s) => (s.likes && s.likes.length) || 0;
                
                profileContent += `<div class="grid grid-cols-2 md:grid-cols-4 gap-6">`;
                likedSongs.forEach(s => {
                    profileContent += `
                        <div class="group relative bg-[#181818] p-4 rounded-xl hover:bg-[#282828] transition-all duration-300 cursor-pointer" onclick="playSong('${s.id}')">
                            <div class="relative mb-4 shadow-lg rounded-lg overflow-hidden">
                                <img src="${s.cover || DEFAULT_COVER}" class="w-full aspect-square object-cover transform group-hover:scale-105 transition-transform duration-500">
                                <button onclick="playSong('${s.id}')" class="absolute bottom-2 right-2 p-3 rounded-full bg-red-500 text-white shadow-xl translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 hover:scale-105 hover:bg-red-400">
                                    <i data-lucide="play" class="fill-current w-5 h-5"></i>
                                </button>
                            </div>
                            <h3 class="font-bold text-white mb-1 truncate">${s.title}</h3>
                            <p class="text-sm text-gray-400 truncate">${s.artist}</p>
                            <div class="flex items-center gap-2 mt-2">
                                <button onclick="event.stopPropagation(); toggleLike('${s.id}')" class="flex items-center gap-1 text-xs ${isLiked(s) ? 'text-red-500' : 'text-gray-500'} hover:text-red-500 transition-colors">
                                    <i data-lucide="heart" class="w-4 h-4 fill-current"></i>
                                    <span>${likeCount(s)}</span>
                                </button>
                            </div>
                        </div>`;
                });
                profileContent += `</div>`;
            } else {
                profileContent += `<p class="text-gray-500">Aucun titre liké</p>`;
            }
            profileContent += `</div>`;
            
            // 3. Liked Albums Section
            const user = users.find(u => u.username === username);
            const likedAlbums = user && user.likedAlbums ? user.likedAlbums : [];
            profileContent += `<div class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="disc" class="w-6 h-6"></i>
                    Albums Likés (${likedAlbums.length})
                </h2>`;
            
            if(likedAlbums.length > 0) {
                profileContent += `<div class="grid grid-cols-2 md:grid-cols-4 gap-6">`;
                likedAlbums.forEach(albumName => {
                    const albumSong = songs.find(s => s.album === albumName);
                    if (albumSong) {
                        profileContent += `
                            <div class="group relative bg-[#181818] p-4 rounded-xl hover:bg-[#282828] transition-all duration-300 cursor-pointer" onclick="openAlbumView('${safeEncode(albumName)}')">
                                <div class="relative mb-4 shadow-lg rounded-lg overflow-hidden">
                                    <img src="${albumSong.cover || DEFAULT_COVER}" class="w-full aspect-square object-cover transform group-hover:scale-105 transition-transform duration-500">
                                    <button class="absolute bottom-2 right-2 p-3 rounded-full bg-red-500 text-white shadow-xl translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 hover:scale-105 hover:bg-red-400">
                                        <i data-lucide="play" class="fill-current w-5 h-5"></i>
                                    </button>
                                </div>
                                <h3 class="font-bold text-white mb-1 truncate">${albumName}</h3>
                                <p class="text-sm text-gray-400 truncate">${albumSong.artist}</p>
                            </div>`;
                    }
                });
                profileContent += `</div>`;
            } else {
                profileContent += `<p class="text-gray-500">Aucun album liké</p>`;
            }
            profileContent += `</div>`;
            
            document.getElementById('profileContentTitle').innerText = "";
            document.getElementById('profilePlaylists').className = "";
            document.getElementById('profilePlaylists').innerHTML = profileContent;
            lucide.createIcons();
        }

        async function updateProfile() {
            const avatar = document.getElementById('avatarData').value; 
            const banner = document.getElementById('bannerData').value;
            if(!avatar && !banner) {
                document.getElementById('profileModal').classList.add('hidden');
                return;
            }
            const payload = { username: currentUser.username }; 
            if(avatar) payload.avatar = avatar; 
            if(banner) payload.banner = banner;
            try { 
                await fetch(`${ACTIVE_SERVER}/users/profile`, { 
                    method: 'PUT', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload) 
                }); 
            } catch(e) {}
            if(avatar) currentUser.avatar = avatar; 
            if(banner) currentUser.banner = banner;
            localStorage.setItem('musicAppUser', JSON.stringify(currentUser));
            updateUserUI(); 
            document.getElementById('profileModal').classList.add('hidden'); 
            // Reset form
            document.getElementById('avatarData').value = '';
            document.getElementById('bannerData').value = '';
            document.getElementById('avatarUrlInput').value = '';
            document.getElementById('bannerUrlInput').value = '';
            document.getElementById('avatarInput').value = '';
            document.getElementById('bannerInput').value = '';
            document.getElementById('avatarPreview').classList.add('hidden');
            document.getElementById('bannerPreview').classList.add('hidden');
            document.getElementById('avatarPreview').src = '';
            document.getElementById('bannerPreview').src = '';
            showToast("Profil mis à jour"); 
            openUserProfile(safeEncode(currentUser.username));
        }

        async function followUser(target) {
            const btn = document.getElementById('btnFollow');
            const originalText = btn ? btn.innerText : '';
            
            // 1. Optimistic UI Update (Immediate)
            if (btn) {
                if (currentUser.following.includes(target)) {
                    // Unsubscribe
                    btn.innerText = "S'abonner";
                    btn.className = "px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold transition-all";
                    // Update local count
                    const countEl = document.getElementById('profileFollowing'); // Wait, this is target's followers
                    if(countEl && viewingProfileId === target) countEl.innerText = parseInt(countEl.innerText) - 1;
                    
                    // Update current user list
                    currentUser.following = currentUser.following.filter(x => x !== target);
                } else {
                    // Subscribe
                    btn.innerText = "Abonné";
                    btn.className = "px-4 py-2 border border-white/20 text-white rounded-lg font-bold transition-all hover:bg-white/10";
                    // Update local count
                    const countEl = document.getElementById('profileFollowing');
                    if(countEl && viewingProfileId === target) countEl.innerText = parseInt(countEl.innerText) + 1;
                    
                    // Update current user list
                    currentUser.following.push(target);
                }
                localStorage.setItem('musicAppUser', JSON.stringify(currentUser));
            }

            try {
                // 2. Server Request
                const res = await fetch(`${ACTIVE_SERVER}/users/follow`, { 
                    method: 'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({requester:currentUser.username, target}) 
                });
                
                if (!res.ok) throw new Error("Failed");
                
                // 3. Re-fetch full profile data to ensure consistency (background update)
                // We don't block the UI here, just sync up later if needed
                // const r = await fetch(`${ACTIVE_SERVER}/users/profile/${target}`);
                // const data = await r.json();
                // if (data && countEl) countEl.innerText = data.followers.length; 

            } catch(e) {
                // Rollback if error
                showToast("Erreur lors de l'abonnement");
                if (btn) {
                    // Revert text and class
                    // ... (Simplification: just reload view)
                    openUserProfile(safeEncode(target));
                }
            }
        }

        // --- Simplified Helper Functions & Logic ---
        function showToast(msg, duration = 3000) { const el = document.createElement('div'); el.className = 'toast show'; el.innerText = msg; document.getElementById('toastContainer').appendChild(el); setTimeout(()=>el.remove(), duration); }
        
        // --- SEARCH SYSTEM ---
        let searchTimeout = null;
        
        function openSearchPage() {
            const modal = document.getElementById('searchModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('searchModalInput').focus();
                lucide.createIcons();
            }, 100);
        }
        
        function closeSearchPage() {
            const modal = document.getElementById('searchModal');
            modal.classList.add('hidden');
            document.getElementById('searchModalInput').value = '';
            document.getElementById('searchModalInitial').classList.remove('hidden');
            document.getElementById('searchModalEmpty').classList.add('hidden');
            document.getElementById('searchModalSongs').classList.add('hidden');
            document.getElementById('searchModalUsers').classList.add('hidden');
        }
        
        function initSearch() {
            const searchInput = document.getElementById('searchModalInput');
            
            if (!searchInput) {
                console.error('Search modal input not found');
                return;
            }
            
            console.log('✅ Search system initialized');
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();
                console.log('🔍 Search query:', query);
                
                // Clear previous timeout
                if (searchTimeout) clearTimeout(searchTimeout);
                
                if (query.length === 0) {
                    document.getElementById('searchModalInitial').classList.remove('hidden');
                    document.getElementById('searchModalEmpty').classList.add('hidden');
                    document.getElementById('searchModalSongs').classList.add('hidden');
                    document.getElementById('searchModalUsers').classList.add('hidden');
                    return;
                }
                
                // Hide initial message
                document.getElementById('searchModalInitial').classList.add('hidden');
                
                // Debounce search
                searchTimeout = setTimeout(() => {
                    performModalSearch(query);
                }, 300);
            });
            
            // Close on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !document.getElementById('searchModal').classList.contains('hidden')) {
                    closeSearchPage();
                }
            });
        }
        
        function performModalSearch(query) {
            console.log('🔎 Performing search for:', query);
            
            // Search songs
            const foundSongs = songs.filter(song => {
                const titleMatch = song.title?.toLowerCase().includes(query);
                const artistMatch = song.artist?.toLowerCase().includes(query);
                const albumMatch = song.album?.toLowerCase().includes(query);
                const genreMatch = song.genre?.toLowerCase().includes(query);
                return titleMatch || artistMatch || albumMatch || genreMatch;
            }).slice(0, 20); // Limit to 20 results
            
            // Search users
            const foundUsers = users.filter(user => {
                return user.username?.toLowerCase().includes(query);
            }).slice(0, 10); // Limit to 10 results
            
            // Search artists
            const foundArtists = artists.filter(artist => {
                return artist.name?.toLowerCase().includes(query);
            }).slice(0, 10); // Limit to 10 results
            
            console.log('📝 Results - Songs:', foundSongs.length, 'Users:', foundUsers.length, 'Artists:', foundArtists.length);
            
            // All profiles combined
            const allProfiles = [
                ...foundUsers.map(u => ({ type: 'user', name: u.username, avatar: u.avatar || 'https://via.placeholder.com/100' })),
                ...foundArtists.map(a => ({ type: 'artist', name: a.name, avatar: a.avatar || 'https://via.placeholder.com/100' }))
            ];
            
            // Update UI
            const songsSection = document.getElementById('searchModalSongs');
            const usersSection = document.getElementById('searchModalUsers');
            const emptySection = document.getElementById('searchModalEmpty');
            const songsList = document.getElementById('searchModalSongsList');
            const usersList = document.getElementById('searchModalUsersList');
            
            if (foundSongs.length === 0 && allProfiles.length === 0) {
                emptySection.classList.remove('hidden');
                songsSection.classList.add('hidden');
                usersSection.classList.add('hidden');
            } else {
                emptySection.classList.add('hidden');
                
                // Songs
                if (foundSongs.length > 0) {
                    songsSection.classList.remove('hidden');
                    songsList.innerHTML = foundSongs.map(song => `
                        <div onclick="playSong('${song.id}'); closeSearchPage();" class="flex items-center gap-4 p-3 hover:bg-white/10 rounded-xl cursor-pointer transition">
                            <img src="${song.cover || 'https://via.placeholder.com/60'}" class="w-14 h-14 rounded-lg object-cover bg-gray-800">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-white truncate">${song.title}</div>
                                <div class="text-xs text-gray-400 truncate">${song.artist}</div>
                                ${song.album ? `<div class="text-xs text-gray-500 truncate">${song.album}</div>` : ''}
                            </div>
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <span class="bg-white/5 px-2 py-1 rounded">${song.genre || 'Music'}</span>
                                <i data-lucide="play-circle" class="w-5 h-5 text-red-500"></i>
                            </div>
                        </div>
                    `).join('');
                } else {
                    songsSection.classList.add('hidden');
                }
                
                // Profiles
                if (allProfiles.length > 0) {
                    usersSection.classList.remove('hidden');
                    usersList.innerHTML = allProfiles.map(profile => `
                        <div onclick="${profile.type === 'user' ? `openUserProfile(safeEncode('${profile.name}'))` : `openArtistProfile('${profile.name}')`}; closeSearchPage();" class="flex items-center gap-3 p-4 hover:bg-white/10 rounded-xl cursor-pointer transition">
                            <img src="${profile.avatar}" class="w-12 h-12 rounded-full object-cover bg-gray-800">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-white truncate">${profile.name}</div>
                                <div class="text-xs text-gray-400">${profile.type === 'user' ? 'Utilisateur' : 'Artiste'}</div>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-600"></i>
                        </div>
                    `).join('');
                } else {
                    usersSection.classList.add('hidden');
                }
            }
            
            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        
        function switchView(v, el) { 
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('nav-active')); 
            if(el) el.classList.add('nav-active'); 
            document.querySelectorAll('.view-section').forEach(e=>e.classList.add('hidden')); 
            document.getElementById(`view-${v}`).classList.remove('hidden'); 
            if(v==='users') { 
                fetchUsers(); 
                renderAdminLists(); 
                updateAdminStats(); 
                switchAdminTab('news'); // Default tab
            }
            if(v==='liked') renderLikedSongs();
            if(v==='community') { fetchCommunity(); fetchPosts(); }
            if(v==='explore') renderExplore();
        }
        
        function switchAdminTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            
            // Update content sections
            document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.add('hidden'));
            document.getElementById(`adminContent${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');
            
            // Refresh icons after tab switch
            setTimeout(() => lucide.createIcons(), 50);
        }
        
        function updateAdminStats() {
            // Update header stats
            document.getElementById('statsUsers').textContent = users.length;
            document.getElementById('statsSongs').textContent = songs.length;
            document.getElementById('statsArtists').textContent = artists.length;
            
            // Update detailed stats in System tab
            document.getElementById('statsDetailSongs').textContent = songs.length;
            document.getElementById('statsDetailArtists').textContent = artists.length;
            document.getElementById('statsDetailUsers').textContent = users.length;
            document.getElementById('statsDetailGenres').textContent = genres.length;
        }
        
        async function toggleLike(songId) {
            if (!currentUser) {
                showToast('Connectez-vous pour liker des titres');
                return;
            }
            
            if (!songId) {
                console.error('No song ID provided');
                showToast('Erreur: ID de chanson manquant');
                return;
            }
            
            try {
                const response = await fetch(`${ACTIVE_SERVER}/songs/${songId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser.username })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update the song data locally without reloading everything
                    const song = songs.find(s => s.id === songId);
                    if (song) {
                        if (!song.likes) song.likes = [];
                        const index = song.likes.indexOf(currentUser.username);
                        if (result.liked) {
                            // Add like
                            if (index === -1) song.likes.push(currentUser.username);
                        } else {
                            // Remove like
                            if (index > -1) song.likes.splice(index, 1);
                        }
                    }
                    
                    // Update UI without reloading
                    updatePlayerLikeButton();
                    
                    // Update only the like buttons for this song (don't re-render everything)
                    updateLikeButtonsForSong(songId);
                } else {
                    const error = await response.json();
                    console.error('Like error:', error);
                    showToast('Erreur lors du like: ' + (error.message || 'Erreur inconnue'));
                }
            } catch (err) {
                console.error('Error toggling like:', err);
                showToast('Erreur lors du like');
            }
        }
        
        function updatePlayerLikeButton() {
            // Update header player like button
            const btn = document.getElementById('playerLikeBtn');
            if (btn) {
                const icon = btn.querySelector('i');
                
                if (!currentSongId || !currentUser) {
                    btn.style.opacity = '0.3';
                    btn.style.pointerEvents = 'none';
                } else {
                    const song = songs.find(s => s.id === currentSongId);
                    if (song) {
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                        const isLiked = song.likes && song.likes.includes(currentUser.username);
                        
                        if (isLiked) {
                            btn.classList.remove('text-gray-500');
                            btn.classList.add('text-red-500');
                        } else {
                            btn.classList.remove('text-red-500');
                            btn.classList.add('text-gray-500');
                        }
                    }
                }
            }
            
            // Update fullscreen player like button
            const fsBtn = document.getElementById('fsLikeBtn');
            if (fsBtn) {
                const fsIcon = fsBtn.querySelector('i');
                const fsText = document.getElementById('fsLikeText');
                
                if (!currentSongId || !currentUser) {
                    fsBtn.style.opacity = '0.3';
                    fsBtn.style.pointerEvents = 'none';
                    if (fsText) fsText.textContent = "J'aime";
                } else {
                    const song = songs.find(s => s.id === currentSongId);
                    if (song) {
                        fsBtn.style.opacity = '1';
                        fsBtn.style.pointerEvents = 'auto';
                        const isLiked = song.likes && song.likes.includes(currentUser.username);
                        const likeCount = (song.likes && song.likes.length) || 0;
                        
                        if (isLiked) {
                            fsBtn.classList.remove('text-gray-500');
                            fsBtn.classList.add('text-red-500');
                            if (fsText) fsText.textContent = `Liké (${likeCount})`;
                        } else {
                            fsBtn.classList.remove('text-red-500');
                            fsBtn.classList.add('text-gray-500');
                            if (fsText) fsText.textContent = likeCount > 0 ? `J'aime (${likeCount})` : "J'aime";
                        }
                    }
                }
            }
            
            lucide.createIcons();
        }
        
        function updateLikeButtonsForSong(songId) {
            // Find the song to get updated like count
            const song = songs.find(s => s.id === songId);
            if (!song) return;
            
            const isLiked = currentUser && song.likes && song.likes.includes(currentUser.username);
            const likeCount = (song.likes && song.likes.length) || 0;
            
            // Find all like buttons for this song across all views
            const likeButtons = document.querySelectorAll(`button[onclick*="toggleLike('${songId}')"]`);
            
            likeButtons.forEach(btn => {
                // Update button color IMMEDIATELY
                if (isLiked) {
                    btn.classList.remove('text-gray-500');
                    btn.classList.add('text-red-500');
                } else {
                    btn.classList.remove('text-red-500');
                    btn.classList.add('text-gray-500');
                }
                
                // Update count span - check if it's inside the button or next sibling
                let countSpan = btn.querySelector('span');
                if (!countSpan) {
                    countSpan = btn.nextElementSibling;
                }
                if (countSpan && countSpan.tagName === 'SPAN') {
                    countSpan.textContent = likeCount > 0 ? likeCount : '';
                }
            });
            
            // Recreate icons
            lucide.createIcons();
            
            // Reapply fill state after icons are recreated to ensure it persists
            setTimeout(() => {
                likeButtons.forEach(btn => {
                    const icon = btn.querySelector('i[data-lucide="heart"]');
                    if (icon) {
                        if (isLiked) {
                            icon.classList.add('fill-current');
                        } else {
                            icon.classList.remove('fill-current');
                        }
                    }
                });
            }, 10);
        }
        
        function renderLikedSongs() {
            if (!currentUser) {
                document.getElementById('likedSongGrid').innerHTML = '<p class="col-span-full text-center py-20 text-gray-500">Connectez-vous pour voir vos titres likés</p>';
                const countWord = currentLang === 'fr' ? 'titres' : currentLang === 'en' ? 'songs' : currentLang === 'es' ? 'canciones' : currentLang === 'it' ? 'brani' : currentLang === 'pt' ? 'músicas' : currentLang === 'de' ? 'Lieder' : currentLang === 'zh' ? '歌曲' : currentLang === 'ja' ? '曲' : '노래';
                document.getElementById('likedSongCount').innerText = `0 ${countWord}`;
                return;
            }
            
            const likedSongs = songs.filter(s => s.likes && s.likes.includes(currentUser.username));
            const countWord = currentLang === 'fr' ? 'titre' + (likedSongs.length > 1 ? 's' : '') : currentLang === 'en' ? 'song' + (likedSongs.length > 1 ? 's' : '') : currentLang === 'es' ? 'canción' + (likedSongs.length > 1 ? 'es' : '') : currentLang === 'it' ? 'bran' + (likedSongs.length > 1 ? 'i' : 'o') : currentLang === 'pt' ? 'música' + (likedSongs.length > 1 ? 's' : '') : currentLang === 'de' ? 'Lied' + (likedSongs.length > 1 ? 'er' : '') : currentLang === 'zh' ? '歌曲' : currentLang === 'ja' ? '曲' : '노래';
            document.getElementById('likedSongCount').innerText = `${likedSongs.length} ${countWord}`;
            
            if (likedSongs.length === 0) {
                document.getElementById('likedSongGrid').innerHTML = '<p class="col-span-full text-center py-20 text-gray-500">Vous n\'avez pas encore liké de titres</p>';
                return;
            }
            
            const canMod = s => currentUser && (['admin','superadmin'].includes(currentUser.role));
            const isLiked = (s) => currentUser && s.likes && s.likes.includes(currentUser.username);
            const likeCount = (s) => (s.likes && s.likes.length) || 0;
            
            document.getElementById('likedSongGrid').innerHTML = likedSongs.map(s => `
                <div class="group relative bg-[#181818] p-4 rounded-xl hover:bg-[#282828] transition-all duration-300 cursor-pointer" onclick="playSong('${s.id}')">
                    <div class="relative mb-4 shadow-lg rounded-lg overflow-hidden">
                        <img src="${s.cover || DEFAULT_COVER}" class="w-full aspect-square object-cover transform group-hover:scale-105 transition-transform duration-500">
                        <button onclick="playSong('${s.id}')" class="absolute bottom-2 right-2 p-3 rounded-full bg-red-500 text-white shadow-xl translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 hover:scale-105 hover:bg-red-400"><i data-lucide="play" class="fill-current w-5 h-5"></i></button>
                    </div>
                    <h3 class="font-bold text-white mb-1 truncate">${s.title}</h3>
                    <p class="text-sm text-gray-400 truncate hover:underline" onclick="event.stopPropagation(); openArtistProfile('${safeEncode(s.artist)}')">${s.artist}</p>
                    
                    <div class="flex items-center gap-2 mt-2">
                        <button onclick="event.stopPropagation(); toggleLike('${s.id}')" class="flex items-center gap-1 text-xs ${isLiked(s) ? 'text-red-500' : 'text-gray-400'} hover:text-red-500 transition-colors" title="J'aime">
                            <i data-lucide="heart" class="w-4 h-4 ${isLiked(s) ? 'fill-current' : ''}"></i>
                            <span>${likeCount(s)}</span>
                        </button>
                    </div>
                    
                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button onclick="event.stopPropagation(); addToPlaylist('${s.id}')" class="p-1.5 bg-black/60 rounded text-white hover:bg-white/20" title="Ajouter à une playlist"><i data-lucide="plus" class="w-3 h-3"></i></button>
                         ${canMod(s) ? `<button onclick="event.stopPropagation(); openEditModal('${s.id}')" class="p-1.5 bg-black/60 rounded text-white hover:bg-blue-600/80"><i data-lucide="edit-2" class="w-3 h-3"></i></button>` : ''}
                    </div>
                    ${canMod(s) ? `<button onclick="event.stopPropagation(); deleteSong('${s.id}')" class="absolute top-2 left-2 p-1.5 bg-red-600/80 rounded text-white opacity-0 group-hover:opacity-100"><i data-lucide="trash" class="w-3 h-3"></i></button>` : ''}
                </div>`).join('');
            lucide.createIcons();
        }
        
        async function deleteSong(id) { if(await customConfirm("Supprimer ?")) { await fetch(`${ACTIVE_SERVER}/songs/${id}`, {method:'DELETE'}); smartConnect(); } }
        
        async function deleteAlbum(albumNameEncoded) {
            const albumName = decodeURIComponent(albumNameEncoded);
            if(!await customConfirm(`Supprimer l'album "${albumName}" et tous ses titres ?`)) return;
            
            // Find all songs in this album
            const albumSongs = songs.filter(s => s.album === albumName);
            
            // Delete each song
            for(const song of albumSongs) {
                await fetch(`${ACTIVE_SERVER}/songs/${song.id}`, {method:'DELETE'});
            }
            
            showToast(`Album "${albumName}" supprimé`);
            smartConnect();
        }
        
        async function changeRole(target, role) { if(!await customConfirm(`Passer ${target} en ${role} ?`)) return; await fetch(`${ACTIVE_SERVER}/users/role`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({requester:currentUser.username, targetUser:target, newRole:role})}); fetchUsers(); }
        
        async function toggleAlbumLike(albumNameEncoded) {
            const albumName = decodeURIComponent(albumNameEncoded);
            if (!currentUser) {
                showToast('Connectez-vous pour liker des albums');
                return;
            }
            
            try {
                const response = await fetch(`${ACTIVE_SERVER}/albums/${encodeURIComponent(albumName)}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser.username })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Update local user data
                    if (!currentUser.likedAlbums) currentUser.likedAlbums = [];
                    const index = currentUser.likedAlbums.indexOf(albumName);
                    
                    if (result.liked) {
                        if (index === -1) currentUser.likedAlbums.push(albumName);
                    } else {
                        if (index > -1) currentUser.likedAlbums.splice(index, 1);
                    }
                    
                    // Update localStorage
                    localStorage.setItem('musicAppUser', JSON.stringify(currentUser));
                    
                    // Update button UI immediately
                    const btnLikeAlbum = document.getElementById('btnLikeAlbum');
                    const albumLikeText = document.getElementById('albumLikeText');
                    
                    if (btnLikeAlbum && albumLikeText) {
                        // Fetch updated user count
                        await fetchUsers();
                        const albumLikesCount = users.filter(u => u.likedAlbums && u.likedAlbums.includes(albumName)).length;
                        
                        if (result.liked) {
                            btnLikeAlbum.classList.remove('text-gray-400');
                            btnLikeAlbum.classList.add('text-red-500');
                            const icon = btnLikeAlbum.querySelector('i');
                            if (icon) icon.classList.add('fill-current');
                            albumLikeText.textContent = albumLikesCount > 0 ? `Liké (${albumLikesCount})` : "Liké";
                        } else {
                            btnLikeAlbum.classList.remove('text-red-500');
                            btnLikeAlbum.classList.add('text-gray-400');
                            const icon = btnLikeAlbum.querySelector('i');
                            if (icon) icon.classList.remove('fill-current');
                            albumLikeText.textContent = albumLikesCount > 0 ? `J'aime (${albumLikesCount})` : "J'aime";
                        }
                        
                        lucide.createIcons();
                        
                        // Reapply fill state after icon recreation
                        setTimeout(() => {
                            const icon = btnLikeAlbum.querySelector('i');
                            if (icon) {
                                if (result.liked) {
                                    icon.classList.add('fill-current');
                                } else {
                                    icon.classList.remove('fill-current');
                                }
                            }
                        }, 10);
                    }
                    
                    showToast(result.liked ? 'Album ajouté aux favoris' : 'Album retiré des favoris');
                } else {
                    showToast('Erreur lors du like');
                }
            } catch (err) {
                console.error('Error toggling album like:', err);
                showToast('Erreur lors du like');
            }
        }
        
        function fetchPlaylists() { fetch(`${ACTIVE_SERVER}/playlists`).then(r=>r.json()).then(d=>{playlists=d; renderSidebarPlaylists()}); }
        function renderSidebarPlaylists() { document.getElementById('playlistSidebar').innerHTML = playlists.filter(p=>p.owner===currentUser.username).map(p=>`<a href="#" onclick="openPlaylist('${p.id}')" class="flex items-center gap-3 px-4 py-2.5 text-gray-400 hover:text-white truncate rounded-xl hover:bg-gradient-to-r hover:from-white/10 hover:to-transparent transition-all group border border-transparent hover:border-white/5"><i data-lucide="list-music" class="w-4 h-4 flex-shrink-0 group-hover:text-red-400 transition-colors"></i><span class="truncate text-sm font-medium">${p.name}</span></a>`).join(''); lucide.createIcons(); }
        function openCreatePlaylistModal() { document.getElementById('createPlaylistModal').classList.remove('hidden'); }
        async function submitCreatePlaylist() { 
            await fetch(`${ACTIVE_SERVER}/playlists`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    name:document.getElementById('newPlaylistName').value, 
                    owner:currentUser.username
                })
            }); 
            document.getElementById('createPlaylistModal').classList.add('hidden'); 
            // Reset form
            document.getElementById('newPlaylistName').value = '';
            fetchPlaylists(); 
        }
        function openEditPlaylistModal() { document.getElementById('editPlaylistModal').classList.remove('hidden'); }
        async function savePlaylistEdit() { 
            const id = document.getElementById('editPlaylistId').value; 
            const name = document.getElementById('editPlaylistName').value; 
            const coverInput = document.getElementById('editPlaylistCover').value; 
            const cover = coverInput || "https://via.placeholder.com/300"; 
            await fetch(`${ACTIVE_SERVER}/playlists/${id}`, { 
                method: 'PUT', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ name, cover }) 
            }); 
            document.getElementById('editPlaylistModal').classList.add('hidden'); 
            // Reset form
            document.getElementById('editPlaylistName').value = '';
            document.getElementById('editPlaylistCover').value = '';
            document.getElementById('editPlaylistCoverUrl').value = '';
            document.getElementById('editPlaylistCoverFile').value = '';
            document.getElementById('editPlaylistCoverPreview').classList.add('hidden');
            document.getElementById('editPlaylistCoverPreview').src = '';
            showToast("Playlist modifiée !"); 
            fetchPlaylists(); 
            openPlaylist(id); 
        }
        
        function addToPlaylist(songId) {
            songToAddId = songId;
            const myPlaylists = playlists.filter(p => p.owner === currentUser.username);
            
            if(myPlaylists.length === 0) {
                showToast("Créez d'abord une playlist !");
                return;
            }

            const modal = document.getElementById('addToPlaylistModal');
            const content = document.getElementById('addToPlaylistContent');
            
            content.innerHTML = myPlaylists.map(p => `
                <div onclick="selectPlaylistForAdd('${p.id}')" class="p-3 bg-white/5 hover:bg-white/10 rounded-xl cursor-pointer flex items-center gap-3 transition">
                    <img src="${p.cover || 'https://via.placeholder.com/150'}" class="w-10 h-10 rounded-lg object-cover">
                    <span class="font-bold text-sm">${p.name}</span>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        async function selectPlaylistForAdd(playlistId) {
            if(!songToAddId) return;
            try {
                await fetch(`${ACTIVE_SERVER}/playlists/${playlistId}/songs`, { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({ songId: songToAddId }) 
                });
                showToast("Ajouté à la playlist !");
                document.getElementById('addToPlaylistModal').classList.add('hidden');
                songToAddId = null;
                fetchPlaylists();
            } catch(e) {
                showToast("Erreur lors de l'ajout");
            }
        }
        
        async function removeFromPlaylist(pid, sid) { if(!await customConfirm("Retirer le titre ?")) return; await fetch(`${ACTIVE_SERVER}/playlists/${pid}/songs/${sid}`, { method: 'DELETE' }); fetchPlaylists(); openPlaylist(pid); }
        async function deletePlaylist() {
            const id = document.getElementById('editPlaylistId').value;
            if(!await customConfirm("Supprimer définitivement cette playlist ?")) return;
            await fetch(`${ACTIVE_SERVER}/playlists/${id}`, { method: 'DELETE' });
            switchView('listen');
            fetchPlaylists();
        }

        function openEditArtistModal(nameEncoded = "") { 
            const name = decodeURIComponent(nameEncoded); 
            document.getElementById('editArtistModal').classList.remove('hidden'); 
            document.getElementById('editArtistOriginalName').value = name; 
            document.getElementById('editArtistName').value = name; 
            
            // 5. ARTIST STATE RESET FIX
            document.getElementById('editArtistAvatar').value = ""; 
            document.getElementById('editArtistBanner').value = ""; 
            document.getElementById('editArtistAvatarFile').value = ""; // Reset file inputs
            document.getElementById('editArtistBannerFile').value = "";
            document.getElementById('editArtistAvatarPreview').classList.add('hidden');
            document.getElementById('editArtistBannerPreview').classList.add('hidden');
        }

        function saveArtistProfile() { 
            const oldName = document.getElementById('editArtistOriginalName').value; 
            const newName = document.getElementById('editArtistName').value; 
            const newAvatar = document.getElementById('editArtistAvatar').value; 
            const newBanner = document.getElementById('editArtistBanner').value; 
            if(!newName) return; 
            
            // Empêcher la création d'artiste avec plusieurs noms (virgule = artistes multiples)
            if(newName.includes(',')) {
                showToast("Nom d'artiste invalide : utilisez le système d'artistes multiples au lieu des virgules");
                return;
            }
            
            fetch(`${ACTIVE_SERVER}/artists`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ name: newName, avatar: newAvatar, banner: newBanner }) 
            }).then(() => { 
                document.getElementById('editArtistModal').classList.add('hidden'); 
                // Reset form
                document.getElementById('editArtistName').value = '';
                document.getElementById('editArtistAvatar').value = '';
                document.getElementById('editArtistBanner').value = '';
                document.getElementById('editArtistAvatarUrl').value = '';
                document.getElementById('editArtistBannerUrl').value = '';
                document.getElementById('editArtistAvatarFile').value = '';
                document.getElementById('editArtistBannerFile').value = '';
                document.getElementById('editArtistAvatarPreview').classList.add('hidden');
                document.getElementById('editArtistBannerPreview').classList.add('hidden');
                document.getElementById('editArtistAvatarPreview').src = '';
                document.getElementById('editArtistBannerPreview').src = '';
                showToast("Profil Artiste sauvegardé !"); 
                if(viewingProfileType === 'artist' && (viewingProfileId === oldName || viewingProfileId === newName)) { 
                    openArtistProfile(safeEncode(newName)); 
                } 
                fetchArtists(); 
                renderAdminLists(); 
            }); 
        }
        function openEditAlbumModal(albumNameEncoded) { 
            const albumName = decodeURIComponent(albumNameEncoded); 
            const refSong = songs.find(s => s.album === albumName); 
            if(!refSong) { 
                console.error('Album not found:', albumName); 
                showToast('Album non trouvé'); 
                return; 
            } 
            document.getElementById('editAlbumOldName').value = albumName; 
            document.getElementById('editAlbumNewName').value = refSong.album; 
            document.getElementById('editAlbumArtist').value = refSong.artist; 
            document.getElementById('editAlbumCover').value = refSong.cover || ''; 
            document.getElementById('editAlbumModal').classList.remove('hidden'); 
        }
        async function saveAlbumEdit() { 
            const oldName = document.getElementById('editAlbumOldName').value; 
            const newName = document.getElementById('editAlbumNewName').value; 
            const newArtist = document.getElementById('editAlbumArtist').value; 
            const coverFile = document.getElementById('editAlbumCover').value; 
            const oldCover = document.getElementById('editAlbumCover').placeholder; 
            const newCover = coverFile || oldCover; 
            if(!newName) return; 
            const songsToUpdate = songs.filter(s => s.album.toLowerCase() === oldName.toLowerCase()); 
            for(const s of songsToUpdate) { 
                const updatedSong = { ...s, album: newName }; 
                if(newArtist) updatedSong.artist = newArtist; 
                if(newCover && newCover !== 'undefined') updatedSong.cover = newCover; 
                await fetch(`${ACTIVE_SERVER}/songs/${s.id}`, { 
                    method: 'PUT', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({username:currentUser.username, song: updatedSong}) 
                }); 
            } 
            document.getElementById('editAlbumModal').classList.add('hidden'); 
            // Reset form
            document.getElementById('editAlbumNewName').value = '';
            document.getElementById('editAlbumArtist').value = '';
            document.getElementById('editAlbumCover').value = '';
            document.getElementById('editAlbumCoverUrl').value = '';
            document.getElementById('editAlbumCoverFile').value = '';
            document.getElementById('editAlbumCoverPreview').classList.add('hidden');
            document.getElementById('editAlbumCoverPreview').src = '';
            showToast("Album modifié !"); 
            smartConnect(); 
        }
        
        function openPlaylist(id) {
            const pl = playlists.find(p => p.id === id); if(!pl) return;
            window.currentAlbumName = null; // Clear album name for playlists
            document.getElementById('btnLikeAlbum').classList.add('hidden'); // Hide album like button for playlists
            document.getElementById('plTitle').innerText = pl.name; document.getElementById('plOwner').innerText = `Par ${pl.owner}`; document.getElementById('plCover').src = pl.cover || "https://via.placeholder.com/300";
            
            // 8. ADMIN PLAYLIST PERMISSIONS FIX
            const isOwner = pl.owner === currentUser.username || ['admin', 'superadmin'].includes(currentUser.role);
            
            const btnEdit = document.getElementById('btnEditPlaylist'); 
            const btnDel = document.getElementById('btnDeletePlaylist');
            
            if(isOwner) { 
                btnEdit.classList.remove('hidden'); btnEdit.onclick = openEditPlaylistModal; 
                btnDel.classList.remove('hidden'); 
            } else { 
                btnEdit.classList.add('hidden'); 
                btnDel.classList.add('hidden'); 
            }
            switchView('playlist');
            document.getElementById('editPlaylistId').value = pl.id; document.getElementById('editPlaylistName').value = pl.name; document.getElementById('editPlaylistCover').value = pl.cover || "";
            const plSongs = []; pl.songIds.forEach(sid => { const s = songs.find(x => x.id === sid); if(s) plSongs.push(s); });
            
            const isLiked = (s) => currentUser && s.likes && s.likes.includes(currentUser.username);
            const likeCount = (s) => (s.likes && s.likes.length) || 0;
            
            document.getElementById('plSongs').innerHTML = plSongs.map((s, i) => `
                <div class="flex items-center gap-4 p-2 hover:bg-white/10 rounded-lg group" onclick="playSong('${s.id}')">
                    <span class="text-gray-500 w-6 text-center text-sm font-mono group-hover:text-white">${i+1}</span>
                    <div class="flex-1 min-w-0"><div class="text-white font-medium truncate">${s.title}</div><div class="text-gray-500 text-xs truncate">${s.artist}</div></div>
                    <button onclick="event.stopPropagation(); toggleLike('${s.id}')" class="opacity-0 group-hover:opacity-100 p-2 ${isLiked(s) ? 'text-red-500' : 'text-gray-400'} hover:text-red-500" title="J'aime">
                        <i data-lucide="heart" class="w-4 h-4 ${isLiked(s) ? 'fill-current' : ''}"></i>
                    </button>
                    <span class="opacity-0 group-hover:opacity-100 text-xs text-gray-500 w-8 text-center">${likeCount(s) > 0 ? likeCount(s) : ''}</span>
                    <button class="opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-white"><i data-lucide="play" class="w-4 h-4"></i></button>
                    ${isOwner ? `<button onclick="event.stopPropagation(); removeFromPlaylist('${pl.id}', '${s.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-red-500"><i data-lucide="minus-circle" class="w-4 h-4"></i></button>` : ''}
                </div>`).join('');
            lucide.createIcons(); filteredSongs = plSongs;
        }

        function openAlbumView(albumName) {
            const decodedName = decodeURIComponent(albumName); const safeDecodedName = decodedName === "undefined" || decodedName === "null" ? "" : decodedName;
            window.currentAlbumName = safeDecodedName; // Store current album name
            let albumSongs = songs.filter(s => (s.album || "").toLowerCase() === safeDecodedName.toLowerCase()); 
            
            // Sort by displayOrder if available, otherwise keep original order
            albumSongs = albumSongs.sort((a, b) => {
                const orderA = typeof a.displayOrder === 'number' ? a.displayOrder : Infinity;
                const orderB = typeof b.displayOrder === 'number' ? b.displayOrder : Infinity;
                return orderA - orderB;
            });
            
            if(albumSongs.length === 0) return;
            // 3. FALLBACK COVER FOR ALBUM VIEW
            document.getElementById('plTitle').innerText = safeDecodedName || "Singles"; document.getElementById('plOwner').innerText = "Album • " + albumSongs[0].artist; document.getElementById('plCover').src = albumSongs[0].cover || DEFAULT_COVER;
            
            // Show and update album like button
            const btnLikeAlbum = document.getElementById('btnLikeAlbum');
            const albumLikeText = document.getElementById('albumLikeText');
            
            if (btnLikeAlbum && albumLikeText) {
                const isAlbumLiked = currentUser && currentUser.likedAlbums && currentUser.likedAlbums.includes(safeDecodedName);
                const albumLikesCount = users.filter(u => u.likedAlbums && u.likedAlbums.includes(safeDecodedName)).length;
                
                btnLikeAlbum.classList.remove('hidden');
                if (isAlbumLiked) {
                    btnLikeAlbum.classList.remove('text-gray-400');
                    btnLikeAlbum.classList.add('text-red-500');
                    const icon = btnLikeAlbum.querySelector('i');
                    if (icon) icon.classList.add('fill-current');
                    albumLikeText.textContent = albumLikesCount > 0 ? `Liké (${albumLikesCount})` : "Liké";
                } else {
                    btnLikeAlbum.classList.remove('text-red-500');
                    btnLikeAlbum.classList.add('text-gray-400');
                    const icon = btnLikeAlbum.querySelector('i');
                    if (icon) icon.classList.remove('fill-current');
                    albumLikeText.textContent = albumLikesCount > 0 ? `J'aime (${albumLikesCount})` : "J'aime";
                }
            }
            
            const isAdm = currentUser && ['admin','superadmin'].includes(currentUser.role); 
            
            if(isAdm) { 
                document.getElementById('btnEditPlaylist').classList.remove('hidden'); 
                document.getElementById('btnEditPlaylist').onclick = () => openEditAlbumModal(safeEncode(safeDecodedName)); 
                document.getElementById('btnDeletePlaylist').classList.remove('hidden');
                document.getElementById('btnDeletePlaylist').onclick = () => deleteAlbum(safeEncode(safeDecodedName));
            } else { 
                document.getElementById('btnEditPlaylist').classList.add('hidden'); 
                document.getElementById('btnDeletePlaylist').classList.add('hidden');
            }
            
            switchView('playlist');
            
            // Store album songs in a global variable for drag-drop operations
            window.currentAlbumSongs = albumSongs;
            
            const isLiked = (s) => currentUser && s.likes && s.likes.includes(currentUser.username);
            const likeCount = (s) => (s.likes && s.likes.length) || 0;
            
            document.getElementById('plSongs').innerHTML = albumSongs.map((s, i) => `
                <div class="flex items-center gap-4 p-2 hover:bg-white/10 rounded-lg group" id="song-${s.id}">
                    ${isAdm ? `
                        <span class="text-gray-500 w-6 text-center text-sm font-mono group-hover:text-white select-none cursor-pointer position-display-${s.id}" onclick="editSongPosition('${s.id}', ${i+1}, ${albumSongs.length})">${i+1}</span>
                        <input type="number" min="1" max="${albumSongs.length}" value="${i+1}" class="w-6 text-center text-gray-400 bg-transparent border border-gray-600 rounded px-1 text-sm position-input-${s.id} hidden" onchange="reorderSongByInput('${s.id}', this.value, ${albumSongs.length})" onblur="cancelEditSongPosition('${s.id}')" onkeydown="if(event.key==='Enter') reorderSongByInput('${s.id}', this.value, ${albumSongs.length}); if(event.key==='Escape') cancelEditSongPosition('${s.id}')">
                    ` : `<span class="text-gray-500 w-6 text-center text-sm font-mono group-hover:text-white cursor-pointer" onclick="playSong('${s.id}')">${i+1}</span>`}
                    <div class="flex-1 min-w-0 cursor-pointer" onclick="playSong('${s.id}')"><div class="text-white font-medium truncate">${s.title}</div><div class="text-gray-500 text-xs truncate">${s.artist}</div></div>
                    <button onclick="event.stopPropagation(); toggleLike('${s.id}')" class="opacity-0 group-hover:opacity-100 p-2 ${isLiked(s) ? 'text-red-500' : 'text-gray-400'} hover:text-red-500" title="J'aime">
                        <i data-lucide="heart" class="w-4 h-4 ${isLiked(s) ? 'fill-current' : ''}"></i>
                    </button>
                    <span class="opacity-0 group-hover:opacity-100 text-xs text-gray-500 w-8 text-center">${likeCount(s) > 0 ? likeCount(s) : ''}</span>
                    <button class="opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-white" onclick="event.stopPropagation(); playSong('${s.id}')"><i data-lucide="play" class="w-4 h-4"></i></button>
                </div>`).join('');
            lucide.createIcons(); filteredSongs = albumSongs;
        }

        // --- ALBUM MANAGEMENT FOR ADMINS ---
        async function deleteAlbum(albumNameEncoded) {
            const albumName = decodeURIComponent(albumNameEncoded);
            if (!await customConfirm(`Êtes-vous sûr de vouloir supprimer l'album "${albumName}" et tous ses morceaux ?`)) return;
            
            try {
                // Find all songs in this album and delete them
                const albumSongs = songs.filter(s => (s.album || "").toLowerCase() === albumName.toLowerCase());
                for (const s of albumSongs) {
                    await fetch(`${ACTIVE_SERVER}/songs/${s.id}`, { method: 'DELETE' });
                }
                showToast(`Album "${albumName}" supprimé avec ${albumSongs.length} morceau(x)`);
                smartConnect(); // Reload songs
                switchView('listen');
            } catch (e) {
                showToast("Erreur lors de la suppression de l'album");
            }
        }

        // --- DRAG & DROP REORDERING (REMOVED - REPLACED WITH INPUT) ---
        let draggedSongId = null;

        function dragStartSong(e, songId) {
            draggedSongId = songId;
            const elem = document.getElementById(`song-${songId}`);
            elem.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }

        function dragOverSong(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        // Show input field for editing position
        function editSongPosition(songId, currentPos, totalSongs) {
            const display = document.querySelector(`.position-display-${songId}`);
            const input = document.querySelector(`.position-input-${songId}`);
            if (display) display.classList.add('hidden');
            if (input) {
                input.classList.remove('hidden');
                input.focus();
                input.select();
            }
        }

        // Hide input field and cancel editing
        function cancelEditSongPosition(songId) {
            const display = document.querySelector(`.position-display-${songId}`);
            const input = document.querySelector(`.position-input-${songId}`);
            if (input) input.classList.add('hidden');
            if (display) display.classList.remove('hidden');
        }

        async function reorderSongByInput(songId, newPosition, totalSongs) {
            const newPos = Math.max(1, Math.min(parseInt(newPosition), totalSongs));
            const albumSongs = window.currentAlbumSongs;
            
            // Find current position
            const currentIdx = albumSongs.findIndex(s => s.id === songId);
            if (currentIdx === -1) return;
            
            const targetIdx = newPos - 1; // Convert 1-based to 0-based
            if (currentIdx === targetIdx) {
                cancelEditSongPosition(songId);
                return; // No change
            }
            
            // Remove song from current position and insert at new position
            const [movedSong] = albumSongs.splice(currentIdx, 1);
            albumSongs.splice(targetIdx, 0, movedSong);
            
            // Update displayOrder for all songs
            albumSongs.forEach((s, idx) => {
                s.displayOrder = idx;
            });

            // Save all songs to server
            for (const s of albumSongs) {
                try {
                    await fetch(`${ACTIVE_SERVER}/songs/${s.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ song: { ...s, displayOrder: s.displayOrder } })
                    });
                } catch (err) {
                    console.error('Error saving song order:', err);
                }
            }

            // Re-render the album view
            const albumName = getCurrentAlbumName();
            const isAdm = currentUser && ['admin','superadmin'].includes(currentUser.role);

            document.getElementById('plSongs').innerHTML = albumSongs.map((s, i) => `
                <div class="flex items-center gap-4 p-2 hover:bg-white/10 rounded-lg group cursor-pointer" id="song-${s.id}">
                    ${isAdm ? `
                        <span class="text-gray-500 w-6 text-center text-sm font-mono group-hover:text-white select-none cursor-pointer position-display-${s.id}" onclick="editSongPosition('${s.id}', ${i+1}, ${albumSongs.length})">${i+1}</span>
                        <input type="number" min="1" max="${albumSongs.length}" value="${i+1}" class="w-6 text-center text-gray-400 bg-transparent border border-gray-600 rounded px-1 text-sm position-input-${s.id} hidden" onchange="reorderSongByInput('${s.id}', this.value, ${albumSongs.length})" onblur="cancelEditSongPosition('${s.id}')" onkeydown="if(event.key==='Enter') reorderSongByInput('${s.id}', this.value, ${albumSongs.length}); if(event.key==='Escape') cancelEditSongPosition('${s.id}')">
                    ` : `<span class="text-gray-500 w-6 text-center text-sm font-mono group-hover:text-white">${i+1}</span>`}
                    <div class="flex-1 min-w-0 cursor-pointer" onclick="playSong('${s.id}')"><div class="text-white font-medium truncate">${s.title}</div><div class="text-gray-500 text-xs truncate">${s.artist}</div></div>
                    <button class="opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-white" onclick="event.stopPropagation(); playSong('${s.id}')"><i data-lucide="play" class="w-4 h-4"></i></button>
                </div>`).join('');
            
            lucide.createIcons();
            filteredSongs = albumSongs;
            showToast("Ordre mis à jour");
        }

        function dragEndSong(e) {
            const elem = document.getElementById(`song-${draggedSongId}`);
            if (elem) elem.style.opacity = '1';
            draggedSongId = null;
        }

        // Get current album name from the view
        function getCurrentAlbumName() {
            const titleEl = document.getElementById('plTitle');
            const albumName = titleEl ? titleEl.innerText : '';
            return albumName === "Singles" ? "" : albumName;
        }
        
        function fetchCommunity() { /* Managed by fetchUsers */ } 
        function switchAddTab(t) { if(t==='song'){document.getElementById('formSong').classList.remove('hidden');document.getElementById('formAlbum').classList.add('hidden');document.getElementById('tabSong').classList.add('active');document.getElementById('tabAlbum').classList.remove('active');} else {document.getElementById('formSong').classList.add('hidden');document.getElementById('formAlbum').classList.remove('hidden');document.getElementById('tabSong').classList.remove('active');document.getElementById('tabAlbum').classList.add('active');}}
        // --- MANAGE MULTIPLE ARTISTS ---
        let currentSongArtists = [];
        let currentAlbumArtists = [];
        
        function addSongArtist() {
            const input = document.getElementById('inputArtist');
            const artist = input.value.trim();
            if(!artist) {
                showToast("Entrez un nom d'artiste");
                return;
            }
            if(currentSongArtists.includes(artist)) {
                showToast("Artiste déjà ajouté");
                return;
            }
            currentSongArtists.push(artist);
            input.value = '';
            renderSongArtists();
        }
        
        function removeSongArtist(idx) {
            currentSongArtists.splice(idx, 1);
            renderSongArtists();
        }
        
        function renderSongArtists() {
            const container = document.getElementById('songArtistsList');
            if(!container) return;
            container.innerHTML = currentSongArtists.map((a, i) => `
                <div class="flex items-center justify-between bg-white/10 px-3 py-2 rounded-lg">
                    <span class="text-sm text-white">${a}</span>
                    <button type="button" onclick="removeSongArtist(${i})" class="text-red-400 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        function addAlbumArtist() {
            const input = document.getElementById('inputAlbumArtist');
            const artist = input.value.trim();
            if(!artist) {
                showToast("Entrez un nom d'artiste");
                return;
            }
            if(currentAlbumArtists.includes(artist)) {
                showToast("Artiste déjà ajouté");
                return;
            }
            currentAlbumArtists.push(artist);
            input.value = '';
            renderAlbumArtists();
        }
        
        function removeAlbumArtist(idx) {
            currentAlbumArtists.splice(idx, 1);
            renderAlbumArtists();
        }
        
        function renderAlbumArtists() {
            const container = document.getElementById('albumArtistsList');
            if(!container) return;
            container.innerHTML = currentAlbumArtists.map((a, i) => `
                <div class="flex items-center justify-between bg-white/10 px-3 py-2 rounded-lg">
                    <span class="text-sm text-white">${a}</span>
                    <button type="button" onclick="removeAlbumArtist(${i})" class="text-red-400 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        function closeAddModal() { 
            document.getElementById('addModal').classList.add('hidden');
            // Reset forms
            document.getElementById('formSong').reset();
            document.getElementById('formAlbum').reset();
            // Clear artist lists
            currentSongArtists = [];
            currentAlbumArtists = [];
            renderSongArtists();
            renderAlbumArtists();
            // Clear preview images
            document.getElementById('inputCoverPreview').classList.add('hidden');
            document.getElementById('inputCoverPreview').src = '';
            document.getElementById('inputAlbumCoverPreview').classList.add('hidden');
            document.getElementById('inputAlbumCoverPreview').src = '';
            // Clear file inputs
            document.getElementById('fileInputSong').value = '';
            document.getElementById('fileInputAlbum').value = '';
            document.getElementById('inputCoverFile').value = '';
            document.getElementById('inputAlbumCoverFile').value = '';
            // Clear hidden inputs
            document.getElementById('inputCover').value = '';
            document.getElementById('inputAlbumCover').value = '';
            document.getElementById('editSongId').value = '';
            document.getElementById('existingSrc').value = '';
            // Clear album file list
            document.getElementById('albumFileList').innerHTML = '';
            document.getElementById('albumFileList').classList.add('hidden');
            document.getElementById('dropContentAlbum').innerHTML = '<i data-lucide="folder-plus" class="w-8 h-8 mb-2"></i>Sélectionner des fichiers';
            lucide.createIcons();
        }
        
        function openAddModal() { 
            document.getElementById('addModal').classList.remove('hidden'); 
            document.getElementById('editSongId').value = ""; // Reset
            document.getElementById('formSong').reset();
            document.getElementById('formAlbum').reset();
            currentSongArtists = [];
            currentAlbumArtists = [];
            renderSongArtists();
            renderAlbumArtists();
            document.getElementById('addModalTitle').innerText = "Ajouter Titre";
            populateGenreSelect(); 
        }
        function populateGenreSelect() { 
            // 2. ALBUM CREATION GENRES FIX
            const html = genres.map(g => { const n = typeof g==='string'?g:g.name; return `<option value="${n}">${n}</option>` }).join('');
            document.getElementById('inputGenre').innerHTML = html;
            document.getElementById('inputAlbumGenre').innerHTML = html;
        }
        function openSiteConfigModal() { document.getElementById('siteConfigModal').classList.remove('hidden'); }
        
        // --- 2. UPDATED SONG SUBMIT HANDLER ---
        async function handleSongSubmit(e) { 
            e.preventDefault(); 
            const id = document.getElementById('editSongId').value;
            const title = document.getElementById('inputTitle').value; 
            const artists = currentSongArtists.length > 0 ? currentSongArtists.join(', ') : document.getElementById('inputArtist').value;
            const genre = document.getElementById('inputGenre').value;
            
            // FILES DIRECTLY
            const audioFile = document.getElementById('fileInputSong').files[0];
            const coverFile = document.getElementById('inputCoverFile').files[0];
            
            // URL FALLBACKS
            const audioUrl = document.getElementById('inputAudioUrl').value;
            const coverUrl = document.getElementById('inputCoverUrl').value;
            
            // EXISTING SRC (Edit Mode)
            const existingSrc = document.getElementById('existingSrc').value;

            showToast("Traitement en cours...", 2000);

            try {
                // 1. RESOLVE AUDIO - Use base64 for now (simpler and works)
                let finalSrc = null;
                if(audioFile) {
                    finalSrc = await toBase64(audioFile);
                } else if (audioUrl) {
                    finalSrc = audioUrl;
                } else if (id && existingSrc) {
                    finalSrc = existingSrc;
                }

                if(!finalSrc) return showToast("Aucun fichier audio !");

                // 2. RESOLVE COVER - Use base64 for now
                let finalCover = DEFAULT_COVER;
                if(coverFile) {
                    finalCover = await toBase64(coverFile);
                } else if (coverUrl) {
                    finalCover = coverUrl;
                } else if (document.getElementById('inputCover').value && document.getElementById('inputCover').value !== "undefined") {
                    finalCover = document.getElementById('inputCover').value;
                }

                const payload = { title, artist: artists, genre, cover: finalCover, src: finalSrc };
                if(id) { payload.id = id; } 

                const method = id ? 'PUT' : 'POST';
                const url = id ? `${ACTIVE_SERVER}/songs/${id}` : `${ACTIVE_SERVER}/songs`;

                const res = await fetch(url, { 
                    method: method, 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(id ? {username:currentUser.username, song:payload} : payload) 
                });
                
                if(res.ok) { 
                    showToast(id ? "Titre modifié !" : "Titre ajouté !"); 
                    currentSongArtists = [];
                    closeAddModal(); 
                    smartConnect(); 
                } else { 
                    showToast("Erreur upload"); 
                }
            } catch(e) { 
                console.error(e);
                showToast("Erreur connexion/conversion"); 
            }
        }
        
        // --- 3. UPDATED ALBUM SUBMIT HANDLER ---
        async function handleAlbumSubmit(e) { 
            e.preventDefault(); 
            
            const filesInput = document.getElementById('fileInputAlbum');
            const files = filesInput.files;
            if(files.length === 0) return showToast("Sélectionnez des fichiers audio");
            
            // Copier les fichiers dans un tableau pour éviter la perte de référence
            const fileArray = Array.from(files);
            
            const albumName = document.getElementById('inputAlbumName').value;
            const artists = currentAlbumArtists.length > 0 ? currentAlbumArtists.join(', ') : document.getElementById('inputAlbumArtist').value;
            const genre = document.getElementById('inputAlbumGenre').value;
            
            if(!albumName) return showToast("Nom d'album requis");
            if(!artists) return showToast("Artiste requis");
            
            console.log(`Starting album upload: ${fileArray.length} files, album: ${albumName}, artist: ${artists}`);
            
            // Cover Handling
            const coverFile = document.getElementById('inputAlbumCoverFile').files[0];
            const coverUrlInput = document.getElementById('inputAlbumCoverUrl').value;
            
            let finalCover = DEFAULT_COVER;
            if(coverFile) {
                try {
                    console.log('Converting cover to base64...');
                    finalCover = await toBase64(coverFile);
                    console.log('Cover converted successfully');
                } catch(err) { 
                    console.error("Cover convert error", err); 
                }
            } else if (coverUrlInput) {
                finalCover = coverUrlInput;
            }
            
            // Fermer la modal APRÈS avoir récupéré toutes les données
            showToast(`Upload de ${fileArray.length} titres en cours...`);
            closeAddModal();

            let successCount = 0;
            let errorCount = 0;

            for(let i=0; i<fileArray.length; i++) {
                const file = fileArray[i];
                console.log(`\n📁 Processing file ${i+1}/${fileArray.length}: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);
                
                try {
                    console.log(`🔄 Converting ${file.name} to base64...`);
                    const audioSrc = await toBase64(file);
                    console.log(`✓ Conversion successful, base64 length: ${audioSrc.length} chars`);
                    
                    const songName = file.name.replace(/\.[^/.]+$/, ""); 
                    
                    const payload = {
                        title: songName,
                        artist: artists,
                        album: albumName,
                        genre: genre,
                        cover: finalCover,
                        src: audioSrc,
                        date: Date.now() + i 
                    };

                    console.log(`📤 Sending request for: ${songName}`);
                    const res = await fetch(`${ACTIVE_SERVER}/songs`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    if(res.ok) {
                        const result = await res.json();
                        successCount++;
                        console.log(`✅ ${songName} uploaded successfully (${successCount}/${fileArray.length})`);
                        showToast(`${successCount}/${fileArray.length} titres ajoutés...`, 1000);
                    } else {
                        errorCount++;
                        const errorText = await res.text();
                        console.error(`❌ Failed to add song ${songName}. Status: ${res.status}, Response:`, errorText);
                    }
                } catch(err) {
                    errorCount++;
                    console.error(`❌ Error uploading song ${file.name}:`, err);
                }
                
                // Petit délai entre les uploads pour éviter de surcharger le serveur
                if(i < fileArray.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            console.log(`\n🎉 Album upload complete: ${successCount}/${fileArray.length} songs added, ${errorCount} errors`);
            showToast(`✅ ${successCount}/${fileArray.length} titres ajoutés !`);
            currentAlbumArtists = [];
            
            // Recharger les données
            await smartConnect();
        }

        function playRandom() { if(songs.length) playSong(songs[Math.floor(Math.random()*songs.length)].id); }
        function filterByGenre(g) { filteredSongs = songs.filter(s => s.genre === g); switchView('listen'); renderSongs(filteredSongs); document.getElementById('searchInput').value = `Genre: ${g}`; }
        
        async function submitPost() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const media = document.getElementById('postMedia').value;
            const type = document.getElementById('postMediaType').value;
            if(!title || !content) return showToast("Titre et contenu requis");
            await fetch(`${ACTIVE_SERVER}/posts`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title, content, media, type, author: currentUser.username }) });
            showToast("News publiée !");
            document.getElementById('postTitle').value = ''; document.getElementById('postContent').value = ''; document.getElementById('postMedia').value = ''; document.getElementById('postMediaPreview').classList.add('hidden'); document.getElementById('postMediaVideoPreview').classList.add('hidden');
            fetchPosts();
        }
        
        async function sendAdminNotification() {
            const target = document.getElementById('notifTargetUser').value;
            const msg = document.getElementById('notifMessage').value;
            if(!msg) return;
            await fetch(`${ACTIVE_SERVER}/notifications`, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ targetUser: target, message: msg, sender: 'Admin' }) });
            showToast("Notification envoyée");
            document.getElementById('notifMessage').value = '';
        }
    </script>
</body>
</html>